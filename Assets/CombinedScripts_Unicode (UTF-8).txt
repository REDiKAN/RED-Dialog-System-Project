// ===== Combined Scripts Header =====
// Generation Time: 17.12.2025 19:07:49
// Total Files: 1
// =================================

//==== File 1 of 1: D:/Work/REDDialogSystemProject/Assets\Scripts/Editor/DialogueGraph/Utilities/GraphSaveUtility.cs ====
using UnityEditor.Experimental.GraphView;
using System.Collections.Generic;
using UnityEngine.UIElements;
using System.Linq;
using UnityEngine;
using UnityEditor;
using System;
using UnityEngine.Events;

/// <summary>
/// Утилита для сохранения и загрузки диалоговых графов
/// </summary>
public class GraphSaveUtility
{
    private DialogueGraphView targetGraphView;
    private DialogueContainer containerCache;

    private List<BaseNode> GetNodes() => targetGraphView.nodes.ToList().Cast<BaseNode>().ToList();
    private List<Edge> GetEdges() => targetGraphView.edges.ToList();

    /// <summary>
    /// Получение экземпляра утилиты для сохранения
    /// </summary>
    public static GraphSaveUtility GetInstance(DialogueGraphView targetGraphView)
    {
        return new GraphSaveUtility { targetGraphView = targetGraphView };
    }

    #region Saving
    /// <summary>
    /// Сохранение графа в файл
    /// </summary>
    /// <summary>
    /// Сохранение графа в файл
    /// </summary>
    public void SaveGraph(string fileName)
    {
        DialogueSettingsData settings = LoadDialogueSettings();
        string savePath = null;

        // Сначала проверяем, включено ли автосохранение
        bool useAutoSave = false;
        if (settings != null && settings.General.enableAutoSaveLocation)
        {
            // Только если автосохранение включено, проверяем валидность пути
            if (!string.IsNullOrEmpty(settings.General.autoSaveFolderPath) &&
                settings.IsValidSavePath(settings.General.autoSaveFolderPath))
            {
                useAutoSave = true;
            }
        }

        if (useAutoSave)
        {
            string folderPath = settings.GetFullPath();
            savePath = System.IO.Path.Combine(folderPath, $"{fileName}.asset");
            savePath = savePath.Replace("\\", "/");
        }
        else
        {
            // Всегда показываем диалог выбора пути, если автосохранение отключено
            savePath = EditorUtility.SaveFilePanelInProject(
                "Save Dialogue",
                fileName,
                "asset",
                "Save dialogue asset"
            );
        }

        if (string.IsNullOrEmpty(savePath))
            return;

        // Создаем контейнер для данных диалога
        var dialogueContainer = ScriptableObject.CreateInstance<DialogueContainer>();
        // Сохраняем узлы и связи
        SaveNodes(dialogueContainer);
        // Сохраняем свойства черной доски
        SaveExposedProperties(dialogueContainer);
        // Сохраняем ассет
        AssetDatabase.CreateAsset(dialogueContainer, savePath);
        AssetDatabase.SaveAssets();
        EditorUtility.DisplayDialog("Success", $"Graph saved as {fileName}", "OK");
    }

    /// <summary>
    /// Сохраняет узлы в контейнер
    /// </summary>
    private void SaveNodes(DialogueContainer dialogueContainer)
    {
        dialogueContainer.BaseCharacterGuid = targetGraphView.BaseCharacterGuid;

        // Сохраняем связи между узлами
        var edgesList = targetGraphView.edges.ToList();
        var connectedPorts = edgesList.Where(x => x.input.node != null).ToArray();
        foreach (var edge in connectedPorts)
        {;
            var outputNode = edge.output.node as BaseNode;
            var inputNode = edge.input.node as BaseNode;
            dialogueContainer.NodeLinks.Add(new NodeLinkData
            {
                BaseNodeGuid = outputNode.GUID,
                PortName = edge.output.portName,
                TargetNodeGuid = inputNode.GUID
            });
        }

        // Сохраняем данные узлов
        foreach (var node in GetNodes())
        {
            if (node.EntryPoint)
            {
                dialogueContainer.EntryNodeData = new EntryNodeData
                {
                    Guid = node.GUID,
                    Position = node.GetPosition().position
                };
            }
            else if (node is SpeechNodeText speechNodeText)
            {
                dialogueContainer.SpeechNodeDatas.Add(new SpeechNodeData
                {
                    Guid = speechNodeText.GUID,
                    DialogueText = speechNodeText.DialogueText,
                    Position = node.GetPosition().position,
                    AudioClipGuid = "",
                    SpeakerGuid = speechNodeText.Speaker ? AssetDatabaseHelper.GetAssetGuid(speechNodeText.Speaker) : "",
                    SpeakerName = speechNodeText.Speaker ? speechNodeText.Speaker.name : "",
                    NodeType = "SpeechNodeText"
                });
            }
            else if (node is SpeechNodeAudio speechNodeAudio)
            {
                dialogueContainer.SpeechNodeDatas.Add(new SpeechNodeData
                {
                    Guid = speechNodeAudio.GUID,
                    DialogueText = "", // Аудио-ноды не используют текст
                    Position = node.GetPosition().position,
                    AudioClipGuid = speechNodeAudio.AudioClip ? AssetDatabase.AssetPathToGUID(AssetDatabase.GetAssetPath(speechNodeAudio.AudioClip)) : "",
                    SpeakerGuid = speechNodeAudio.Speaker ? AssetDatabaseHelper.GetAssetGuid(speechNodeAudio.Speaker) : "",
                    NodeType = "SpeechNodeAudio"
                });
            }
            else if (node is SpeechNodeImage speechNodeImage)
            {
                dialogueContainer.SpeechNodeImageDatas.Add(new SpeechNodeImageData
                {
                    Guid = speechNodeImage.GUID,
                    Position = node.GetPosition().position,
                    ImageSpritePath = speechNodeImage.ImageSprite ? GetResourcePath(speechNodeImage.ImageSprite) : "",
                    ImageSpriteGuid = speechNodeImage.ImageSprite ? AssetDatabase.GetAssetPath(speechNodeImage.ImageSprite) : "",
                    SpeakerName = speechNodeImage.Speaker ? speechNodeImage.Speaker.name : "",
                    SpeakerGuid = speechNodeImage.Speaker ? AssetDatabaseHelper.GetAssetGuid(speechNodeImage.Speaker) : "",
                    NodeType = "SpeechNodeImage"
                });
            }
            else if (node is OptionNodeText optionNodeText)
            {
                dialogueContainer.OptionNodeDatas.Add(new OptionNodeData
                {
                    Guid = optionNodeText.GUID,
                    ResponseText = optionNodeText.ResponseText,
                    Position = node.GetPosition().position,
                    AudioClipGuid = "",
                    NodeType = "OptionNodeText"
                });
            }
            else if (node is OptionNodeAudio optionNodeAudio)
            {
                dialogueContainer.OptionNodeDatas.Add(new OptionNodeData
                {
                    Guid = optionNodeAudio.GUID,
                    ResponseText = "", // Аудио-опции не используют текст
                    Position = node.GetPosition().position,
                    AudioClipGuid = optionNodeAudio.AudioClip ? AssetDatabase.AssetPathToGUID(AssetDatabase.GetAssetPath(optionNodeAudio.AudioClip)) : "",
                    NodeType = "OptionNodeAudio"
                });
            }
            else if (node is OptionNodeImage optionNodeImage)
            {
                dialogueContainer.OptionNodeImageDatas.Add(new OptionNodeImageData
                {
                    Guid = optionNodeImage.GUID,
                    Position = node.GetPosition().position,
                    ImageSpriteGuid = optionNodeImage.ImageSprite ? AssetDatabase.AssetPathToGUID(AssetDatabase.GetAssetPath(optionNodeImage.ImageSprite)) : "",
                    NodeType = "OptionNodeImage"
                });
            }
            else if (node is IntConditionNode intConditionNode)
            {
                dialogueContainer.IntConditionNodeDatas.Add(new IntConditionNodeData
                {
                    Guid = intConditionNode.GUID,
                    Position = node.GetPosition().position,
                    SelectedProperty = intConditionNode.SelectedProperty,
                    Comparison = intConditionNode.Comparison,
                    CompareValue = intConditionNode.CompareValue
                });
            }
            else if (node is StringConditionNode stringConditionNode)
            {
                dialogueContainer.StringConditionNodeDatas.Add(new StringConditionNodeData
                {
                    Guid = stringConditionNode.GUID,
                    Position = node.GetPosition().position,
                    SelectedProperty = stringConditionNode.SelectedProperty,
                    Comparison = (DialogueSystem.StringComparisonType)stringConditionNode.Comparison,
                    CompareValue = stringConditionNode.CompareValue
                });
            }
            else if (node is ModifyIntNode modifyIntNode)
            {
                dialogueContainer.ModifyIntNodeDatas.Add(new ModifyIntNodeData
                {
                    Guid = modifyIntNode.GUID,
                    Position = node.GetPosition().position,
                    SelectedProperty = modifyIntNode.SelectedProperty,
                    Operator = modifyIntNode.Operator,
                    Value = modifyIntNode.Value
                });
            }
            else if (node is EndNode endNode)
            {
                dialogueContainer.EndNodeDatas.Add(new EndNodeData
                {
                    Guid = endNode.GUID,
                    Position = node.GetPosition().position,
                    NextDialogueName = endNode.GetNextDialoguePath()
                });
            }
            else if (node is EventNode eventNode)
            {
                dialogueContainer.EventNodeDatas.Add(new EventNodeData
                {
                    Guid = eventNode.GUID,
                    Position = node.GetPosition().position,
                    Event = eventNode.RuntimeEvent
                });
            }
            else if (node is CharacterIntConditionNode charIntCond)
            {
                dialogueContainer.CharacterIntConditionNodeDatas.Add(new CharacterIntConditionNodeData
                {
                    Guid = charIntCond.GUID,
                    Position = node.GetPosition().position,
                    CharacterName = charIntCond.CharacterName,
                    SelectedVariable = charIntCond.SelectedVariable,
                    Comparison = charIntCond.Comparison,
                    CompareValue = charIntCond.CompareValue
                });
            }
            else if (node is CharacterModifyIntNode charModify)
            {
                dialogueContainer.CharacterModifyIntNodeDatas.Add(new CharacterModifyIntNodeData
                {
                    Guid = charModify.GUID,
                    Position = node.GetPosition().position,
                    CharacterName = charModify.CharacterAsset ? charModify.CharacterAsset.name : "",
                    SelectedVariable = charModify.SelectedVariable,
                    Operator = charModify.Operator,
                    Value = charModify.Value
                });
            }
            else if (node is DebugLogNode debugLog)
            {
                dialogueContainer.DebugLogNodeDatas.Add(new DebugLogNodeData
                {
                    Guid = debugLog.GUID,
                    Position = node.GetPosition().position,
                    MessageText = debugLog.MessageText
                });
            }
            else if (node is DebugWarningNode debugWarn)
            {
                dialogueContainer.DebugWarningNodeDatas.Add(new DebugWarningNodeData
                {
                    Guid = debugWarn.GUID,
                    Position = node.GetPosition().position,
                    MessageText = debugWarn.MessageText
                });
            }
            else if (node is DebugErrorNode debugErr)
            {
                dialogueContainer.DebugErrorNodeDatas.Add(new DebugErrorNodeData
                {
                    Guid = debugErr.GUID,
                    Position = node.GetPosition().position,
                    MessageText = debugErr.MessageText
                });
            }
            else if (node is SpeechNodeRandText speechRandNode)
            {
                dialogueContainer.SpeechRandNodeDatas.Add(new SpeechRandNodeData
                {
                    Guid = speechRandNode.GUID,
                    Position = node.GetPosition().position,
                    SpeakerName = speechRandNode.Speaker ? speechRandNode.Speaker.name : "",
                    Variants = speechRandNode.GetVariants()
                });
            }
            else if (node is RandomBranchNode randomBranchNode)
            {
                dialogueContainer.RandomBranchNodeDatas.Add(new RandomBranchNodeData
                {
                    Guid = randomBranchNode.GUID,
                    Position = node.GetPosition().position,
                    Variants = randomBranchNode.GetVariants()
                });
            }
            else if (node is NoteNode noteNode)
            {
                dialogueContainer.NoteNodeDatas.Add(new NoteNodeData
                {
                    Guid = noteNode.GUID,
                    Position = node.GetPosition().position,
                    NoteText = noteNode.NoteText,
                    BackgroundColor = noteNode.BackgroundColor,
                    ConnectedNodeGuids = noteNode.ConnectedNodeGuids
                });
            }
            else if (node is TimerNode timerNode)
            {
                dialogueContainer.TimerNodeDatas.Add(new TimerNodeData
                {
                    Guid = timerNode.GUID,
                    Position = node.GetPosition().position,
                    DurationSeconds = timerNode.DurationSeconds
                });
            }
            else if (node is PauseNode pauseNode)
            {
                dialogueContainer.PauseNodeDatas.Add(new PauseNodeData
                {
                    Guid = pauseNode.GUID,
                    Position = node.GetPosition().position,
                    DurationSeconds = pauseNode.DurationSeconds
                });
            }
            else if (node is WireNode wireNode)
            {
                dialogueContainer.WireNodeDatas.Add(new WireNodeData
                {
                    Guid = wireNode.GUID,
                    Position = node.GetPosition().position
                });
            }
            else if (node is CharacterButtonPressNode charButtonPressNode)
            {
                dialogueContainer.CharacterButtonPressNodeDatas.Add(new CharacterButtonPressNodeData
                {
                    Guid = charButtonPressNode.GUID,
                    Position = node.GetPosition().position,
                    CharacterName = charButtonPressNode.CharacterAsset ? charButtonPressNode.CharacterAsset.name : "",
                    RequireButtonPress = charButtonPressNode.RequireButtonPress
                });
            }
            else if (node is ChatSwitchNode chatSwitchNode)
            {
                dialogueContainer.ChatSwitchNodeDatas.Add(new ChatSwitchNodeData
                {
                    Guid = chatSwitchNode.GUID,
                    Position = node.GetPosition().position,
                    TargetChatIndex = chatSwitchNode.TargetChatIndex
                });
            }
        }
    }

    private string GetResourcePath(Sprite sprite)
    {
        if (sprite == null) return "";
        string path = AssetDatabase.GetAssetPath(sprite);
        if (!path.StartsWith("Assets/Resources/"))
        {
            Debug.LogError($"Sprite {sprite.name} must be in Assets/Resources!");
            return "";
        }
        path = path.Substring("Assets/Resources/".Length);
        if (path.LastIndexOf('.') > 0)
            path = path.Substring(0, path.LastIndexOf('.'));
        return path;
    }

    /// <summary>
    /// Сохранение свойств черной доски
    /// </summary>
    private void SaveExposedProperties(DialogueContainer dialogueContainer)
    {
        // Очистка старых данных
        dialogueContainer.ExposedProperties.Clear(); // для обратной совместимости, если используется
        dialogueContainer.IntExposedProperties.Clear();
        dialogueContainer.StringExposedProperties.Clear();

        // Сохранение актуальных данных
        dialogueContainer.IntExposedProperties.AddRange(targetGraphView.IntExposedProperties);
        dialogueContainer.StringExposedProperties.AddRange(targetGraphView.StringExposedProperties);
    }
    #endregion

    #region Loading
    /// <summary>
    /// Загрузка графа из файла
    /// </summary>
    public void LoadGraph(string fileName)
    {
        containerCache = Resources.Load<DialogueContainer>(fileName);
        if (containerCache == null)
        {
            EditorUtility.DisplayDialog("File Not Found", "Target dialogue graph file does not exist", "OK");
            return;
        }

        ClearGraph();
        CreateNodes();
        ConnectNodes();
        CreateExposedProperties();

        EditorUtility.DisplayDialog("Success", $"Graph {fileName} loaded", "OK");
    }

    /// <summary>
    /// Создает узлы из загруженных данных
    /// </summary>
    private void CreateNodes()
    {
        // Восстанавливаем EntryNode
        if (containerCache.EntryNodeData != null)
        {
            var entryNode = GetNodes().Find(x => x.EntryPoint);
            if (entryNode != null)
            {
                entryNode.GUID = containerCache.EntryNodeData.Guid;
                entryNode.SetPosition(new Rect(containerCache.EntryNodeData.Position, targetGraphView.DefaultNodeSize));
            }
        }

        // Создаем SpeechNode
        foreach (var nodeData in containerCache.SpeechNodeDatas)
        {
            BaseNode tempNode = null;
            switch (nodeData.NodeType)
            {
                case "SpeechNodeText":
                    tempNode = NodeFactory.CreateSpeechNodeText(nodeData.Position);
                    if (tempNode is SpeechNode speechNodeText)
                    {
                        speechNodeText.SetDialogueText(nodeData.DialogueText);
                    }
                    break;
                case "SpeechNodeAudio":
                    tempNode = NodeFactory.CreateSpeechNodeAudio(nodeData.Position);
                    break;
                default:
                    tempNode = NodeFactory.CreateSpeechNode(nodeData.Position);
                    if (tempNode is SpeechNode speechNode)
                    {
                        speechNode.SetDialogueText(nodeData.DialogueText);
                    }
                    break;
            }
            tempNode.GUID = nodeData.Guid;

            // Восстанавливаем аудио клип по GUID
            if (!string.IsNullOrEmpty(nodeData.AudioClipGuid))
            {
                var audioClip = AssetDatabase.LoadAssetAtPath<AudioClip>(
                    AssetDatabase.GUIDToAssetPath(nodeData.AudioClipGuid));
                if (tempNode is SpeechNode speechNode)
                {
                    speechNode.AudioClip = audioClip;
                }
            }

            // Восстанавливаем спикера по GUID
            if (!string.IsNullOrEmpty(nodeData.SpeakerGuid))
            {
                var speaker = AssetDatabaseHelper.LoadAssetFromGuid<CharacterData>(nodeData.SpeakerGuid);
                if (tempNode is SpeechNode speechNode)
                {
                    speechNode.SetSpeaker(speaker);
                }
            }

            targetGraphView.AddElement(tempNode);
        }

        // Создаем SpeechNodeImage
        // Создаем SpeechNodeImage
        foreach (var nodeData in containerCache.SpeechNodeImageDatas)
        {
            var tempNode = NodeFactory.CreateSpeechNodeImage(nodeData.Position);
            tempNode.GUID = nodeData.Guid;

            if (tempNode is SpeechNodeImage speechNodeImage)
            {
                // Восстанавливаем спрайт
                if (!string.IsNullOrEmpty(nodeData.ImageSpritePath))
                {
                    string fullPath = $"Assets/Resources/{nodeData.ImageSpritePath}.sprite";
                    var sprite = AssetDatabase.LoadAssetAtPath<Sprite>(fullPath);
                    if (sprite == null)
                    {
                        fullPath = $"Assets/Resources/{nodeData.ImageSpritePath}";
                        sprite = AssetDatabase.LoadAssetAtPath<Sprite>(fullPath);
                    }
                    speechNodeImage.ImageSprite = sprite;
                }

                CharacterData speaker = null;
                if (!string.IsNullOrEmpty(nodeData.SpeakerGuid))
                {
                    speaker = AssetDatabaseHelper.LoadAssetFromGuid<CharacterData>(nodeData.SpeakerGuid);
                }
                else if (!string.IsNullOrEmpty(nodeData.SpeakerName))
                {
                    speaker = CharacterManager.Instance?.GetCharacter(nodeData.SpeakerName);
                }
                speechNodeImage.SetSpeaker(speaker);

                // Восстанавливаем спикера
                if (!string.IsNullOrEmpty(nodeData.ImageSpriteGuid))
                {
                    var sprite = AssetDatabase.LoadAssetAtPath<Sprite>(nodeData.ImageSpriteGuid);
                    speechNodeImage.ImageSprite = sprite;
                    if (speechNodeImage.imageField != null)
                        speechNodeImage.imageField.SetValueWithoutNotify(sprite);
                }
            }

            targetGraphView.AddElement(tempNode);
        }

        // Создаем OptionNode
        foreach (var nodeData in containerCache.OptionNodeDatas)
        {
            BaseNode tempNode = null;
            switch (nodeData.NodeType)
            {
                case "OptionNodeText":
                    tempNode = NodeFactory.CreateOptionNodeText(nodeData.Position);
                    if (tempNode is OptionNode optionNodeText)
                    {
                        optionNodeText.SetResponseText(nodeData.ResponseText);
                    }
                    break;
                case "OptionNodeAudio":
                    tempNode = NodeFactory.CreateOptionNodeAudio(nodeData.Position);
                    break;
                default:
                    tempNode = NodeFactory.CreateOptionNode(nodeData.Position);
                    if (tempNode is OptionNode optionNode)
                    {
                        optionNode.SetResponseText(nodeData.ResponseText);
                    }
                    break;
            }
            tempNode.GUID = nodeData.Guid;

            // Восстанавливаем аудио клип по GUID
            if (!string.IsNullOrEmpty(nodeData.AudioClipGuid))
            {
                var audioClip = AssetDatabase.LoadAssetAtPath<AudioClip>(
                    AssetDatabase.GUIDToAssetPath(nodeData.AudioClipGuid));
                if (tempNode is OptionNode optionNode)
                {
                    optionNode.AudioClip = audioClip;
                }
            }

            targetGraphView.AddElement(tempNode);
        }

        // Создаем OptionNodeImage
        foreach (var nodeData in containerCache.OptionNodeImageDatas)
        {
            var tempNode = NodeFactory.CreateOptionNodeImage(nodeData.Position);
            tempNode.GUID = nodeData.Guid;

            // Восстанавливаем изображение по GUID
            if (!string.IsNullOrEmpty(nodeData.ImageSpriteGuid))
            {
                var imageSprite = AssetDatabase.LoadAssetAtPath<Sprite>(
                    AssetDatabase.GUIDToAssetPath(nodeData.ImageSpriteGuid));
                if (tempNode is OptionNodeImage optionNodeImage)
                {
                    optionNodeImage.ImageSprite = imageSprite;
                }
            }

            targetGraphView.AddElement(tempNode);
        }

        // Создаем IntConditionNode
        foreach (var nodeData in containerCache.IntConditionNodeDatas)
        {
            var tempNode = NodeFactory.CreateIntConditionNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is IntConditionNode intConditionNode)
            {
                intConditionNode.SelectedProperty = nodeData.SelectedProperty;
                intConditionNode.Comparison = nodeData.Comparison;
                intConditionNode.CompareValue = nodeData.CompareValue;
            }
            targetGraphView.AddElement(tempNode);
            // Обновляем UI после добавления в граф
            if (tempNode is IntConditionNode icn)
                icn.UpdateUIFromData();
        }

        // Создаем StringConditionNode
        foreach (var nodeData in containerCache.StringConditionNodeDatas)
        {
            var tempNode = NodeFactory.CreateStringConditionNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is StringConditionNode stringConditionNode)
            {
                stringConditionNode.SelectedProperty = nodeData.SelectedProperty;
                stringConditionNode.Comparison = (StringConditionNode.StringComparisonType)nodeData.Comparison;
                stringConditionNode.CompareValue = nodeData.CompareValue;
            }
            targetGraphView.AddElement(tempNode);
            // Обновляем UI после добавления в граф
            if (tempNode is StringConditionNode scn)
                scn.UpdateUIFromData();
        }

        // Создаем ModifyIntNode
        foreach (var nodeData in containerCache.ModifyIntNodeDatas)
        {
            var tempNode = NodeFactory.CreateModifyIntNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is ModifyIntNode modifyIntNode)
            {
                modifyIntNode.SelectedProperty = nodeData.SelectedProperty;
                modifyIntNode.Operator = nodeData.Operator;
                modifyIntNode.Value = nodeData.Value;
                modifyIntNode.UpdateUIFromData(); // ← добавлено
            }
            targetGraphView.AddElement(tempNode);
        }

        // Создаем EndNode
        foreach (var nodeData in containerCache.EndNodeDatas)
        {
            var tempNode = NodeFactory.CreateEndNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is EndNode endNodeEditor)
            {
                endNodeEditor.SetNextDialogueFromPath(nodeData.NextDialogueName);
            }
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.EventNodeDatas)
        {
            var tempNode = new EventNode();
            tempNode.Initialize(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            tempNode.RuntimeEvent = nodeData.Event;
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.CharacterIntConditionNodeDatas)
        {
            var tempNode = NodeFactory.CreateCharacterIntConditionNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is CharacterIntConditionNode n)
            {
                n.SetInitialData(nodeData.CharacterName, nodeData.SelectedVariable, nodeData.Comparison, nodeData.CompareValue);
                n.UpdateUIFromData();
            }
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.CharacterModifyIntNodeDatas)
        {
            var tempNode = NodeFactory.CreateCharacterModifyIntNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is CharacterModifyIntNode n)
            {
                n.CharacterAsset = CharacterManager.Instance?.GetCharacter(nodeData.CharacterName);
                n.SelectedVariable = nodeData.SelectedVariable;
                n.Operator = nodeData.Operator;
                n.Value = nodeData.Value;
                n.UpdateUIFromData();
            }
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.DebugLogNodeDatas)
        {
            var node = new DebugLogNode();
            node.Initialize(nodeData.Position);
            node.GUID = nodeData.Guid;
            node.MessageText = nodeData.MessageText;
            if (node._previewLabel != null) node._previewLabel.text = nodeData.MessageText;
            targetGraphView.AddElement(node);
        }

        foreach (var nodeData in containerCache.DebugWarningNodeDatas)
        {
            var node = new DebugWarningNode();
            node.Initialize(nodeData.Position);
            node.GUID = nodeData.Guid;
            node.MessageText = nodeData.MessageText;
            if (node._previewLabel != null) node._previewLabel.text = nodeData.MessageText;
            targetGraphView.AddElement(node);
        }

        foreach (var nodeData in containerCache.DebugErrorNodeDatas)
        {
            var node = new DebugErrorNode();
            node.Initialize(nodeData.Position);
            node.GUID = nodeData.Guid;
            node.MessageText = nodeData.MessageText;
            if (node._previewLabel != null) node._previewLabel.text = nodeData.MessageText;
            targetGraphView.AddElement(node);
        }

        foreach (var nodeData in containerCache.SpeechRandNodeDatas)
        {
            var tempNode = NodeFactory.CreateSpeechNodeRandText(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (!string.IsNullOrEmpty(nodeData.SpeakerName))
            {
                var speaker = CharacterManager.Instance?.GetCharacter(nodeData.SpeakerName);
                tempNode.SetSpeaker(speaker);
            }
            tempNode.LoadVariants(nodeData.Variants);
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.RandomBranchNodeDatas)
        {
            var tempNode = NodeFactory.CreateRandomBranchNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is RandomBranchNode randomBranchNode)
            {
                randomBranchNode.LoadVariants(nodeData.Variants);
            }
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.NoteNodeDatas)
        {
            var tempNode = NodeFactory.CreateNoteNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is NoteNode noteNode)
            {
                noteNode.SetNoteText(nodeData.NoteText);
                noteNode.SetBackgroundColor(nodeData.BackgroundColor);
                noteNode.ConnectedNodeGuids = nodeData.ConnectedNodeGuids ?? new List<string>();
            }
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.TimerNodeDatas)
        {
            var tempNode = NodeFactory.CreateTimerNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            tempNode.SetDuration(nodeData.DurationSeconds);
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.TimerNodeDatas)
        {
            // Проверяем, существует ли уже узел с таким GUID
            var existingNode = GetNodes().FirstOrDefault(n => n.GUID == nodeData.Guid);
            BaseNode tempNode;
            if (existingNode != null)
            {
                // Если существует — используем его
                tempNode = existingNode;
                // Обновляем позицию
                tempNode.SetPosition(new Rect(nodeData.Position, targetGraphView.DefaultNodeSize));
            }
            else
            {
                // Если не существует — создаём новый
                tempNode = NodeFactory.CreateTimerNode(nodeData.Position);
                tempNode.GUID = nodeData.Guid;
                targetGraphView.AddElement(tempNode);
            }
            // Обновляем данные узла
            if (tempNode is TimerNode timerNode)
            {
                timerNode.SetDuration(nodeData.DurationSeconds);
            }
        }

        foreach (var nodeData in containerCache.PauseNodeDatas)
        {
            var tempNode = NodeFactory.CreatePauseNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            tempNode.SetDuration(nodeData.DurationSeconds);
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.WireNodeDatas)
        {
            var tempNode = NodeFactory.CreateWireNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.CharacterButtonPressNodeDatas)
        {
            var tempNode = NodeFactory.CreateCharacterButtonPressNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is CharacterButtonPressNode node)
            {
                CharacterData character = null;

                // 1. Сначала пытаемся загрузить через CharacterManager
                if (CharacterManager.Instance != null && !string.IsNullOrEmpty(nodeData.CharacterName))
                {
                    character = CharacterManager.Instance.GetCharacter(nodeData.CharacterName);
                }

                // 2. Если не получилось, ищем напрямую через AssetDatabase
                if (character == null && !string.IsNullOrEmpty(nodeData.CharacterName))
                {
                    string[] characterGuids = AssetDatabase.FindAssets($"t:CharacterData {nodeData.CharacterName}");
                    if (characterGuids.Length > 0)
                    {
                        string characterPath = AssetDatabase.GUIDToAssetPath(characterGuids[0]);
                        character = AssetDatabase.LoadAssetAtPath<CharacterData>(characterPath);
                    }
                }

                node.CharacterAsset = character;
                node.RequireButtonPress = nodeData.RequireButtonPress;

                // 3. Обновляем UI через метод UpdateUIFromData
                if (node.characterField != null)
                    node.characterField.SetValueWithoutNotify(character);
                if (node.buttonPressToggle != null)
                    node.buttonPressToggle.SetValueWithoutNotify(node.RequireButtonPress);
            }
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.ChatSwitchNodeDatas.ToList())
        {
            // Проверяем, существует ли уже узел с таким GUID
            var existingNode = targetGraphView.nodes.ToList().FirstOrDefault(n => n is BaseNode bn && bn.GUID == nodeData.Guid);

            BaseNode tempNode;
            if (existingNode != null)
            {
                // Если узел уже существует, используем его
                tempNode = existingNode;
                // Обновляем позицию
                tempNode.SetPosition(new Rect(nodeData.Position, targetGraphView.DefaultNodeSize));
            }
            else
            {
                // Если не существует — создаём новый
                tempNode = NodeFactory.CreateChatSwitchNode(nodeData.Position);
                tempNode.GUID = nodeData.Guid;
                targetGraphView.AddElement(tempNode);
            }

            // Обновляем данные узла
            if (tempNode is ChatSwitchNode chatSwitchNode)
            {
                chatSwitchNode.TargetChatIndex = nodeData.TargetChatIndex;
            }
        }
    }

    /// <summary>
    /// Восстановление связей между узлами
    /// </summary>
    /// <summary>
    /// Восстановление связей между узлами
    /// </summary>
    private void ConnectNodes()
    {
        try
        {
            var nodeList = this.targetGraphView.nodes.ToList().Cast<BaseNode>().ToList();
            for (int i = 0; i < nodeList.Count; i++)
            {
                var connections = containerCache.NodeLinks.Where(x => x.BaseNodeGuid == nodeList[i].GUID).ToList();
                foreach (var connection in connections)
                {
                    var targetNodeGuid = connection.TargetNodeGuid;
                    var targetNode = nodeList.FirstOrDefault(x => x.GUID == targetNodeGuid);
                    if (targetNode == null)
                    {
                        Debug.LogWarning($"Target node not found for GUID: {targetNodeGuid}");
                        continue;
                    }

                    Port outputPort = null;

                    // Определяем outputPort в зависимости от типа узла
                    if (nodeList[i] is SpeechNode speechNode)
                    {
                        foreach (var port in speechNode.outputContainer.Children())
                        {
                            if (port is Port portElement && portElement.portName == connection.PortName)
                            {
                                outputPort = portElement;
                                break;
                            }
                        }
                        if (outputPort == null)
                        {
                            outputPort = speechNode.InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
                            outputPort.portName = connection.PortName;
                            speechNode.outputContainer.Add(outputPort);
                            speechNode.RefreshPorts();
                            speechNode.RefreshExpandedState();
                        }
                    }
                    else if (nodeList[i] is OptionNode optionNode)
                    {
                        outputPort = optionNode.outputContainer[0].Q<Port>();
                    }
                    else if (nodeList[i] is EntryNode entryNode)
                    {
                        outputPort = entryNode.outputContainer[0].Q<Port>();
                    }
                    else if (nodeList[i] is IntConditionNode || nodeList[i] is StringConditionNode)
                    {
                        foreach (var port in nodeList[i].outputContainer.Children())
                        {
                            if (port is Port portElement && portElement.portName == connection.PortName)
                            {
                                outputPort = portElement;
                                break;
                            }
                        }
                        if (outputPort == null)
                        {
                            Debug.LogWarning($"Port '{connection.PortName}' not found on condition node {nodeList[i].GUID}");
                        }
                    }
                    else if (nodeList[i] is TimerNode timerNode)
                    {
                        foreach (var port in timerNode.outputContainer.Children())
                        {
                            if (port is Port portElement && portElement.portName == connection.PortName)
                            {
                                outputPort = portElement;
                                break;
                            }
                        }
                        if (outputPort == null)
                        {
                            // Восстанавливаем порт, если его нет (например, после загрузки)
                            outputPort = timerNode.InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
                            outputPort.portName = connection.PortName;
                            timerNode.outputContainer.Add(outputPort);
                            timerNode.RefreshPorts();
                            timerNode.RefreshExpandedState();
                        }
                    }
                    else if (nodeList[i] is PauseNode pauseNode)
                    {
                        foreach (var port in pauseNode.outputContainer.Children())
                        {
                            if (port is Port portElement && portElement.portName == connection.PortName)
                            {
                                outputPort = portElement;
                                break;
                            }
                        }
                        if (outputPort == null)
                        {
                            // Восстанавливаем порт, если его нет (например, после загрузки)
                            outputPort = pauseNode.InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
                            outputPort.portName = connection.PortName;
                            pauseNode.outputContainer.Add(outputPort);
                            pauseNode.RefreshPorts();
                            pauseNode.RefreshExpandedState();
                        }
                    }
                    else if (nodeList[i] is ModifyIntNode modifyNode)
                    {
                        outputPort = modifyNode.outputContainer[0].Q<Port>();
                    }
                    else if (nodeList[i] is EndNode endNode)
                    {
                        outputPort = endNode.outputContainer[0].Q<Port>();
                    }
                    else if (nodeList[i] is EventNode eventNode)
                    {
                        outputPort = eventNode.outputContainer[0].Q<Port>();
                    }
                    else if (nodeList[i] is WireNode wireNode)
                    {
                        foreach (var port in wireNode.outputContainer.Children())
                        {
                            if (port is Port portElement && portElement.portName == connection.PortName)
                            {
                                outputPort = portElement;
                                break;
                            }
                        }
                        if (outputPort == null)
                        {
                            // Восстанавливаем порт, если его нет
                            outputPort = wireNode.InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
                            outputPort.portName = connection.PortName; // Должно быть "Output"
                            wireNode.outputContainer.Add(outputPort);
                            wireNode.RefreshPorts();
                            wireNode.RefreshExpandedState();
                        }
                    }
                    else if (nodeList[i] is CharacterButtonPressNode charButtonPressNode)
                    {
                        foreach (var port in charButtonPressNode.outputContainer.Children())
                        {
                            if (port is Port portElement && portElement.portName == connection.PortName)
                            {
                                outputPort = portElement;
                                break;
                            }
                        }
                        if (outputPort == null)
                        {
                            // Восстанавливаем порт, если его нет
                            outputPort = charButtonPressNode.InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
                            outputPort.portName = connection.PortName; // Должно быть "Output"
                            charButtonPressNode.outputContainer.Add(outputPort);
                            charButtonPressNode.RefreshPorts();
                            charButtonPressNode.RefreshExpandedState();
                        }
                    }
                    else if (nodeList[i] is ChatSwitchNode chatSwitchNode)
                    {
                        foreach (var port in chatSwitchNode.outputContainer.Children())
                        {
                            if (port is Port portElement && portElement.portName == connection.PortName)
                            {
                                outputPort = portElement;
                                break;
                            }
                        }
                        if (outputPort == null)
                        {
                            // Восстанавливаем порт, если его нет
                            outputPort = chatSwitchNode.InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
                            outputPort.portName = "Output"; // ВСЕГДА используем "Output" для ChatSwitchNode
                            chatSwitchNode.outputContainer.Add(outputPort);
                            chatSwitchNode.RefreshPorts();
                            chatSwitchNode.RefreshExpandedState();
                        }
                    }

                    // Получаем inputPort у целевого узла
                    Port inputPort = null;
                    if (targetNode.inputContainer.childCount > 0)
                    {
                        inputPort = targetNode.inputContainer[0] as Port;
                    }

                    // Соединяем порты
                    if (outputPort != null && inputPort != null)
                    {
                        LinkNodes(outputPort, inputPort);
                    }
                    else
                    {
                        Debug.LogWarning($"Failed to connect {nodeList[i].GUID} -> {targetNodeGuid}. outputPort: {outputPort != null}, inputPort: {inputPort != null}");
                    }
                }
            }
        }
        catch (Exception e)
        {
            Debug.LogError($"Error connecting nodes: {e.Message}\n{e.StackTrace}");
        }
    }

    /// <summary>
    /// Связывание двух портов
    /// </summary>
    private void LinkNodes(Port output, Port input)
    {
        var tempEdge = new Edge { output = output, input = input };
        tempEdge.input.Connect(tempEdge);
        tempEdge.output.Connect(tempEdge);
        targetGraphView.Add(tempEdge);
    }

    /// <summary>
    /// Восстановление свойств черной доски
    /// </summary>
    private void CreateExposedProperties()
    {
        targetGraphView.ClearBlackBoardAndExposedProperties();
        // Загружаем Int свойства
        foreach (var prop in containerCache.IntExposedProperties)
        {
            var newProp = new IntExposedProperty
            {
                PropertyName = prop.PropertyName,
                IntValue = prop.IntValue,
                MinValue = prop.MinValue,
                MaxValue = prop.MaxValue
            };
            // Заменяем на существующий метод для добавления Int свойства
            targetGraphView.IntExposedProperties.Add(newProp);
            targetGraphView.AddIntPropertyToBlackBoard(newProp);
        }
        // Загружаем String свойства
        foreach (var prop in containerCache.StringExposedProperties)
        {
            var newProp = new StringExposedProperty
            {
                PropertyName = prop.PropertyName,
                StringValue = prop.StringValue
            };
            // Заменяем на существующий метод для добавления String свойства
            targetGraphView.StringExposedProperties.Add(newProp);
            targetGraphView.AddStringPropertyToBlackBoard(newProp);
        }
        // Принудительно обновляем все выпадающие списки после загрузки свойств
        var propertyNodes = targetGraphView.nodes.ToList().OfType<IPropertyNode>();
        foreach (var node in propertyNodes)
            node.RefreshPropertyDropdown();
    }

    /// <summary>
    /// Очистка текущего графа перед загрузкой
    /// </summary>
    private void ClearGraph()
    {
        var nodesToRemove = this.nodes.ToList().Where(node => !(node is EntryNode)).ToList();
        foreach (var node in nodesToRemove)
        {
            var edgesToRemove = this.edges
                .Where(e => e.input.node == node || e.output.node == node)
                .ToList();
            foreach (var edge in edgesToRemove)
                RemoveElement(edge);
            RemoveElement(node);
        }

        // Добавляем очистку внутренних коллекций узлов
        if (containerCache != null)
        {
            containerCache.ChatSwitchNodeDatas.Clear();
            // Можно также очистить другие коллекции если необходимо
        }

        ClearBlackBoardAndExposedProperties();
        BaseCharacterGuid = string.Empty;

        // Очищаем все внутренние списки узлов в графе
        targetGraphView?.nodes?.ToList().ForEach(n => {
            if (!(n is EntryNode)) targetGraphView?.RemoveElement(n);
        });
    }
    #endregion

    /// <summary>
    /// Загружает граф из уже загруженного DialogueContainer
    /// </summary>
    public void LoadGraphFromContainer(DialogueContainer container)
    {
        if (container == null)
        {
            Debug.LogError("Cannot load null container");
            return;
        }

        // Сохраняем ссылку на контейнер
        targetGraphView.containerCache = container;
        containerCache = container;

        // Очищаем стеки отмены
        targetGraphView.ClearUndoRedoStacks();

        // Полностью очищаем граф перед загрузкой
        ClearGraph();

        // Создаем узлы и связи
        CreateNodes();
        ConnectNodes();
        CreateExposedProperties();

        // Помечаем, что изменения сохранены
        targetGraphView.MarkUnsavedChangeWithoutFile();
    }

    private void LoadDialogueFromFile(DialogueContainer container)
    {
        if (container == null) return;

        // Проверка, не загружен ли уже этот контейнер
        if (graphView.containerCache == container)
        {
            return;
        }

        var saveUtility = GraphSaveUtility.GetInstance(graphView);
        saveUtility.LoadGraphFromContainer(container);

        // Обновляем GUID базового персонажа в графе
        graphView.BaseCharacterGuid = container.BaseCharacterGuid;

        // Обновляем отображение Base Character в тулбаре
        var baseCharField = rootVisualElement.Q<ObjectField>("Base Character");
        if (baseCharField != null)
        {
            baseCharField.SetValueWithoutNotify(
                AssetDatabaseHelper.LoadAssetFromGuid<CharacterData>(container.BaseCharacterGuid)
            );
        }

        // Сбрасываем состояние "без файла"
        graphView._hasUnsavedChangesWithoutFile = false;
        graphView._unsavedChangesWarningShown = false;
    }

    private DialogueSettingsData LoadDialogueSettings()
    {
        string[] guids = AssetDatabase.FindAssets("t:DialogueSettingsData");
        if (guids.Length > 0)
        {
            string path = AssetDatabase.GUIDToAssetPath(guids[0]);
            return AssetDatabase.LoadAssetAtPath<DialogueSettingsData>(path);
        }
        return null;
    }

    /// <summary>
    /// Сохраняет граф в существующий DialogueContainer
    /// </summary>
    public void SaveGraphToExistingContainer(DialogueContainer existingContainer)
    {
        if (existingContainer == null)
        {
            Debug.LogError("Cannot save to null container");
            return;
        }

        // === ОЧИЩАЕМ ВСЕ СПИСКИ, ВКЛЮЧАЯ TimerNodeDatas ===
        existingContainer.NodeLinks.Clear();
        existingContainer.SpeechNodeDatas.Clear();
        existingContainer.OptionNodeDatas.Clear();
        existingContainer.IntConditionNodeDatas.Clear();
        existingContainer.StringConditionNodeDatas.Clear();
        existingContainer.ModifyIntNodeDatas.Clear();
        existingContainer.EndNodeDatas.Clear();
        existingContainer.SpeechNodeImageDatas.Clear();
        existingContainer.OptionNodeImageDatas.Clear();
        existingContainer.TimerNodeDatas.Clear();
        existingContainer.PauseNodeDatas.Clear();
        existingContainer.WireNodeDatas.Clear();
        existingContainer.IntExposedProperties.Clear();
        existingContainer.StringExposedProperties.Clear();
        existingContainer.SpeechRandNodeDatas.Clear();
        existingContainer.NoteNodeDatas.Clear();
        existingContainer.CharacterIntConditionNodeDatas.Clear();
        existingContainer.RandomBranchNodeDatas.Clear();
        existingContainer.CharacterModifyIntNodeDatas.Clear();
        existingContainer.EventNodeDatas.Clear();
        existingContainer.DebugLogNodeDatas.Clear();
        existingContainer.DebugWarningNodeDatas.Clear();
        existingContainer.DebugErrorNodeDatas.Clear();
        existingContainer.CharacterButtonPressNodeDatas.Clear();

        targetGraphView.ClearUndoRedoStacks();

        // === Сохраняем новые данные ===
        SaveNodes(existingContainer);
        SaveExposedProperties(existingContainer);

        EditorUtility.SetDirty(existingContainer);
        AssetDatabase.SaveAssets();
        EditorUtility.SetDirty(existingContainer);
        AssetDatabase.SaveAssets();
    }
}


// ============ Statistics =============
// Total Files: 1
// Total Size: 55,70 KB
// Total Lines: 1279
// Classes: 1
// Methods: 50
// Comments: 114
// =====================================
