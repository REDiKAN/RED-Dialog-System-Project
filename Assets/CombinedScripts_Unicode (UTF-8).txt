// ===== Combined Scripts Header =====
// Generation Time: 11.10.2025 18:49:58
// Total Files: 62
// =================================

//==== File 1 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\BaseNodeData.cs ====
using UnityEngine;
using System;

[System.Serializable]
public abstract class BaseNodeData
{
    public string Guid;
    public Vector2 Position;
}


//==== File 2 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\CharacterManager.cs ====
using System.Collections.Generic;
using UnityEngine;

public class CharacterManager : MonoBehaviour
{
    private static CharacterManager _instance;
    public static CharacterManager Instance => _instance;

    private Dictionary<string, CharacterData> characterCache = new Dictionary<string, CharacterData>();

    private void Awake()
    {
        if (_instance != null)
            Destroy(gameObject);
        else
        {
            _instance = this;
            DontDestroyOnLoad(gameObject);
            LoadAllCharacters();
        }
    }

    /// <summary>
    /// ��������� ���� ���������� �� Resources/Characters
    /// </summary>
    private void LoadAllCharacters()
    {
        var characters = Resources.LoadAll<CharacterData>("Characters");
        foreach (var character in characters)
            characterCache[character.name] = character;
    }

    /// <summary>
    /// �������� ��������� �� �����
    /// </summary>
    /// <param name="characterName">��� ���������</param>
    /// <returns>CharacterData ��� null</returns>
    public CharacterData GetCharacter(string characterName)
    {
        if (characterCache.TryGetValue(characterName, out var character))
            return character;

        Debug.LogError($"�������� {characterName} �� ������ � Resources/Characters");
        return null;
    }
}


//==== File 3 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\ChatPanel.cs ====
using UnityEngine;
using UnityEngine.UI;

public class ChatPanel : MonoBehaviour
{
    [SerializeField] private ScrollRect scrollRect;
    [SerializeField] private Transform contentContainer;

    [Header("Prefabs")]
    [SerializeField] private SpeechTextMessage speechTextMessagePrefab;
    [SerializeField] private OptionTextMessage optionTextMessagePrefab;

    /// <summary>
    /// ��������� ��������� � ���
    /// </summary>
    /// <param name="message">������ ���������</param>
    public void AddMessage(Message message, MessageType messageType)
    {
        // ��������� ������������ ������
        if (speechTextMessagePrefab == null)
        {
            Debug.LogError("Message prefab �� �������� � ChatPanel");
            return;
        }

        if (contentContainer == null)
        {
            Debug.LogError("Content container �� �������� � ChatPanel");
            return;
        }

        if (scrollRect == null)
        {
            Debug.LogError("ScrollRect �� �������� � ChatPanel");
            return;
        }

        // ��������� ���������
        if (message.Type == SenderType.NPC)
        {
            GameObject messageGO = Instantiate(speechTextMessagePrefab.gameObject, contentContainer);
            // ����������: ��������� NPC ��������� � ����� ������ (� �� � ������)
            messageGO.transform.SetAsLastSibling();
            if (messageGO.TryGetComponent(out SpeechTextMessage speechText))
                speechText.InitializationContent(message);
        }
        else if (message.Type == SenderType.Player)
        {
            GameObject messageGO = Instantiate(optionTextMessagePrefab.gameObject, contentContainer);
            // ��������� ��������� ������ � ����� ������
            messageGO.transform.SetAsLastSibling();
            if (messageGO.TryGetComponent(out OptionTextMessage optionText))
                optionText.InitializationContent(message);
        }
        else if (message.Type == SenderType.System)
        {
            // ��������� ���������
            //if (textComponent != null)
            //{
            //    textComponent.text = message.Text;
            //    Debug.Log(textComponent.text);
            //    // ����� �������� ���������� ��� ��������� ���������
            //}
        }

        // ������������� ����
        if (scrollRect.content != null)
            scrollRect.verticalNormalizedPosition = 1;
    }
}

//==== File 4 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\ConditionHandler.cs ====
using DialogueSystem;
using System.Collections.Generic;
using UnityEngine;
/// <summary>
/// ���������� ������� ��� ���������� �����
/// </summary>
public static class ConditionHandler
{
    /// <summary>
    /// ��������� �������� �������
    /// </summary>
    /// <param name="condition">������ ���� �������</param>
    /// <param name="variables">������� �������� ����������</param>
    /// <returns>��������� �������� �������</returns>
    public static bool EvaluateIntCondition(IntConditionNodeData condition, Dictionary<string, int> variables)
    {
        if (!variables.TryGetValue(condition.SelectedProperty, out int value))
        {
            Debug.LogError($"���������� {condition.SelectedProperty} �� ������� � �������");
            return false;
        }

        switch (condition.Comparison)
        {
            case ComparisonType.Equal:
                return value == condition.CompareValue;
            case ComparisonType.NotEqual:
                return value != condition.CompareValue;
            case ComparisonType.Greater:
                return value > condition.CompareValue;
            case ComparisonType.Less:
                return value < condition.CompareValue;
            case ComparisonType.GreaterOrEqual:
                return value >= condition.CompareValue;
            case ComparisonType.LessOrEqual:
                return value <= condition.CompareValue;
            default:
                return false;
        }
    }

    /// <summary>
    /// ��������� ��������� �������
    /// </summary>
    /// <param name="condition">������ ���� �������</param>
    /// <param name="variables">������� ��������� ����������</param>
    /// <returns>��������� �������� �������</returns>
    public static bool EvaluateStringCondition(StringConditionNodeData condition, Dictionary<string, string> variables)
    {
        if (!variables.TryGetValue(condition.SelectedProperty, out string value))
        {
            Debug.LogError($"���������� {condition.SelectedProperty} �� ������� � �������");
            return false;
        }

        switch (condition.Comparison)
        {
            case StringComparisonType.Equal:
                return value == condition.CompareValue;
            case StringComparisonType.NotEqual:
                return value != condition.CompareValue;
            case StringComparisonType.IsNullOrEmpty:
                return string.IsNullOrEmpty(value);
            default:
                return false;
        }
    }
}

//==== File 5 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\DialogueManager.cs ====
using UnityEngine;
using System.Collections.Generic;
using System.Linq;
using UnityEngine.UI;
using UnityEngine.EventSystems;
using UnityEngine.Events;
using System;
using System.Collections;
using DialogueSystem;

/// <summary>
/// Управляет выполнением диалогов в реальном времени
/// </summary>
public class DialogueManager : MonoBehaviour
{
    [Header("UI References")]
    [SerializeField] private ChatPanel chatPanel;
    [SerializeField] private OptionPanel optionPanel;

    [Header("Dialogue Settings")]
    [SerializeField] private float messageDelay = 0.5f; // Задержка между сообщениями

    [SerializeField] private DialogueContainer currentDialogue;
    private object currentNode; // Исправлено: BaseNodeData -> object (ошибки 1,9)
    private Dictionary<string, int> intVariables = new Dictionary<string, int>();
    private Dictionary<string, string> stringVariables = new Dictionary<string, string>();
    private List<object> visitedNodes = new List<object>(); // Исправлено: BaseNodeData -> object

    private void Start()
    {
        // Подписываемся на событие выбора опции
        if (optionPanel != null)
        {
            optionPanel.onOptionSelected += HandleOptionSelection;
        }
        else
        {
            Debug.LogError("OptionPanel not assigned in DialogueManager");
        }

        if (chatPanel == null)
        {
            Debug.LogError("ChatPanel not assigned in DialogueManager");
        }

        StartDialogue(currentDialogue);
    }
    /// <summary>
    /// Запускает диалог по указанному контейнеру
    /// </summary>
    /// <param name="dialogueContainer">Контейнер диалога для запуска</param>
    public void StartDialogue(DialogueContainer dialogueContainer)
    {
        currentDialogue = dialogueContainer;
        ResetVariables();
        visitedNodes.Clear();

        // Инициализация переменных из Exposed Properties
        foreach (var prop in currentDialogue.IntExposedProperties)
        {
            intVariables[prop.PropertyName] = prop.IntValue;
        }

        foreach (var prop in currentDialogue.StringExposedProperties)
        {
            stringVariables[prop.PropertyName] = prop.StringValue;
        }

        // Начинаем диалог с EntryNode
        currentNode = currentDialogue.EntryNodeData;
        ProcessNextNode();
    }

    /// <summary>
    /// Сбрасывает все переменные диалога к значениям по умолчанию
    /// </summary>
    private void ResetVariables()
    {
        intVariables.Clear();
        stringVariables.Clear();
    }

    private void ProcessNextNode()
    {
        if (currentNode == null)
            return;

        if (!visitedNodes.Contains(currentNode))
            visitedNodes.Add(currentNode);

        switch (currentNode)
        {
            case EntryNodeData entryNode:
                ProcessEntryNode(entryNode);
                break;
            case SpeechNodeData speechNode:
                ProcessSpeechNode(speechNode);
                break;
            case SpeechNodeImageData speechImageNode:
                ProcessSpeechImageNode(speechImageNode);
                break;
            case IntConditionNodeData intCondition:
                ProcessIntCondition(intCondition);
                break;
            case StringConditionNodeData stringCondition:
                ProcessStringCondition(stringCondition);
                break;
            case ModifyIntNodeData modifyNode:
                ProcessModifyIntNode(modifyNode);
                break;
            case EndNodeData endNode:
                ProcessEndNode(endNode);
                break;
            case OptionNodeData optionNode:
                ProcessOptionNode(optionNode);
                break;
            case OptionNodeImageData optionImageNode:
                ProcessOptionImageNode(optionImageNode);
                break;
            case EventNodeData eventNode:
                eventNode.Event.Invoke();
                var nextLink = currentDialogue.NodeLinks.FirstOrDefault(l => l.BaseNodeGuid == eventNode.Guid);
                if (nextLink != null)
                {
                    currentNode = GetNodeByGuid(nextLink.TargetNodeGuid);
                    ProcessNextNode();
                } else currentNode = null;
                break;
            case CharacterIntConditionNodeData charIntCondition:
                ProcessCharacterIntCondition(charIntCondition);
                break;
            case CharacterModifyIntNodeData charModifyInt:
                ProcessCharacterModifyInt(charModifyInt);
                break;
            default:
                Debug.LogWarning($"Неизвестный тип узла: {currentNode?.GetType().Name}");
                currentNode = null;
                break;
        }
    }

    /// <summary>
    /// Обрабатывает EntryNodeData
    /// </summary>
    /// <param name="entryNode">Данные начального узла</param>
    private void ProcessEntryNode(EntryNodeData entryNode)
    {
        // Находим следующий узел после EntryNode
        var nextLink = currentDialogue.NodeLinks
            .FirstOrDefault(l => l.BaseNodeGuid == entryNode.Guid);

        if (nextLink != null)
        {
            currentNode = GetNodeByGuid(nextLink.TargetNodeGuid);
            ProcessNextNode();
        }
        else
        {
            // Если нет следующего узла, завершаем диалог
            currentNode = null;
        }
    }

    /// <summary>
    /// Обрабатывает SpeechNodeData
    /// </summary>
    /// <param name="speechNode">Данные узла речи</param>
    private void ProcessSpeechNode(SpeechNodeData speechNode)
    {
        CharacterData speaker = GetCharacterByGuid(speechNode.SpeakerGuid);
        var message = new Message
        {
            Type = SenderType.NPC,
            Text = speechNode.DialogueText,
            Image = null,
            Audio = AssetLoader.LoadAudioClip(speechNode.AudioClipGuid),
            Sender = speaker
        };
        chatPanel.AddMessage(message, MessageType.Speech);

        if (message.Audio != null)
        {
            StartCoroutine(PlayAudioAfterDelay(message.Audio, messageDelay));
        }

        var outgoingLinks = currentDialogue.NodeLinks
            .Where(l => l.BaseNodeGuid == speechNode.Guid)
            .ToList();

        // Проверяем: есть ли исходящие связи к OptionNode?
        var optionLinks = outgoingLinks.Where(link =>
        {
            var target = GetNodeByGuid(link.TargetNodeGuid);
            return target is OptionNodeData || target is OptionNodeImageData;
        }).ToList();

        if (optionLinks.Any())
        {
            // Режим выбора опций — как раньше
            var options = new List<Option>();
            foreach (var linkToOption in optionLinks)
            {
                var optionNode = GetNodeByGuid(linkToOption.TargetNodeGuid);
                if (optionNode == null) continue;

                string text = "Изображение";
                if (optionNode is OptionNodeData opt)
                    text = !string.IsNullOrEmpty(opt.ResponseText) ? opt.ResponseText : "Неизвестный вариант";

                var nextLinkAfterOption = currentDialogue.NodeLinks
                    .FirstOrDefault(l => l.BaseNodeGuid == ((BaseNodeData)optionNode).Guid);
                if (nextLinkAfterOption != null)
                {
                    options.Add(new Option
                    {
                        Text = text,
                        NextNodeGuid = nextLinkAfterOption.TargetNodeGuid
                    });
                }
            }

            if (options.Count > 0 && optionPanel != null)
            {
                optionPanel.ShowOptions(options);
            }
            else
            {
                Debug.LogError("Нет валидных вариантов для отображения!");
                currentNode = null;
            }
            return;
        }

        // Нет Option — проверяем: есть ли Speech-связи?
        var speechLinks = outgoingLinks.Where(link =>
        {
            var target = GetNodeByGuid(link.TargetNodeGuid);
            return target is SpeechNodeData || target is SpeechNodeImageData;
        }).ToList();

        if (speechLinks.Any())
        {
            // Цепочка Speech → Speech: запускаем следующее сообщение с задержкой
            if (speechLinks.Count > 1)
            {
                Debug.LogWarning($"SpeechNode {speechNode.Guid} имеет несколько исходящих Speech-связей. Будет использована первая.");
            }

            string nextGuid = speechLinks.First().TargetNodeGuid;
            StartCoroutine(DelayedGoToNode(nextGuid));
            return;
        }

        // Нет ни Option, ни Speech — линейный переход (к Condition, Modify, End и т.д.)
        var nextLinearLink = outgoingLinks.FirstOrDefault();
        if (nextLinearLink != null)
        {
            currentNode = GetNodeByGuid(nextLinearLink.TargetNodeGuid);
            ProcessNextNode();
        }
        else
        {
            currentNode = null;
        }
    }

    /// <summary>
    /// Обрабатывает SpeechNodeImageData
    /// </summary>
    /// <param name="speechImageNode">Данные узла изображения речи</param>
    private void ProcessSpeechImageNode(SpeechNodeImageData speechImageNode)
    {
        CharacterData speaker = GetCharacterByGuid(speechImageNode.SpeakerGuid);
        var message = new Message
        {
            Type = SenderType.NPC,
            Text = null,
            Image = AssetLoader.LoadSprite(speechImageNode.ImageSpriteGuid),
            Audio = null,
            Sender = speaker
        };
        chatPanel.AddMessage(message, MessageType.SpeechImage);

        var outgoingLinks = currentDialogue.NodeLinks
            .Where(l => l.BaseNodeGuid == speechImageNode.Guid)
            .ToList();

        // Проверяем: есть ли исходящие связи к OptionNode?
        var optionLinks = outgoingLinks.Where(link =>
        {
            var target = GetNodeByGuid(link.TargetNodeGuid);
            return target is OptionNodeData || target is OptionNodeImageData;
        }).ToList();

        if (optionLinks.Any())
        {
            var options = new List<Option>();
            foreach (var linkToOption in optionLinks)
            {
                var optionNode = GetNodeByGuid(linkToOption.TargetNodeGuid);
                if (optionNode == null) continue;

                string text = "Изображение";
                if (optionNode is OptionNodeData opt)
                    text = !string.IsNullOrEmpty(opt.ResponseText) ? opt.ResponseText : "Неизвестный вариант";

                var nextLinkAfterOption = currentDialogue.NodeLinks
                    .FirstOrDefault(l => l.BaseNodeGuid == ((BaseNodeData)optionNode).Guid);
                if (nextLinkAfterOption != null)
                {
                    options.Add(new Option
                    {
                        Text = text,
                        NextNodeGuid = nextLinkAfterOption.TargetNodeGuid
                    });
                }
            }

            if (options.Count > 0 && optionPanel != null)
            {
                optionPanel.ShowOptions(options);
            }
            else
            {
                Debug.LogError("Нет валидных вариантов для отображения!");
                currentNode = null;
            }
            return;
        }

        // Нет Option — проверяем Speech-связи
        var speechLinks = outgoingLinks.Where(link =>
        {
            var target = GetNodeByGuid(link.TargetNodeGuid);
            return target is SpeechNodeData || target is SpeechNodeImageData;
        }).ToList();

        if (speechLinks.Any())
        {
            if (speechLinks.Count > 1)
            {
                Debug.LogWarning($"SpeechImageNode {speechImageNode.Guid} имеет несколько исходящих Speech-связей. Будет использована первая.");
            }

            string nextGuid = speechLinks.First().TargetNodeGuid;
            StartCoroutine(DelayedGoToNode(nextGuid));
            return;
        }

        // Линейный переход
        var nextLinearLink = outgoingLinks.FirstOrDefault();
        if (nextLinearLink != null)
        {
            currentNode = GetNodeByGuid(nextLinearLink.TargetNodeGuid);
            ProcessNextNode();
        }
        else
        {
            currentNode = null;
        }
    }

    private IEnumerator DelayedGoToNode(string nextNodeGuid)
    {
        yield return new WaitForSeconds(messageDelay);
        currentNode = GetNodeByGuid(nextNodeGuid);
        ProcessNextNode();
    }

    /// <summary>
    /// Обрабатывает OptionNodeData
    /// </summary>
    private void ProcessOptionNode(OptionNodeData optionNode)
    {
        // Создаем список вариантов ответа
        var options = new List<Option>();

        // Находим все связи от этого узла
        var optionLinks = currentDialogue.NodeLinks
            .Where(l => l.BaseNodeGuid == optionNode.Guid)
            .ToList();

        foreach (var link in optionLinks)
        {
            var targetNode = GetNodeByGuid(link.TargetNodeGuid);
            string optionText = "Вариант ответа";

            if (targetNode is OptionNodeData optionTarget)
            {
                optionText = !string.IsNullOrEmpty(optionTarget.ResponseText) ?
                    optionTarget.ResponseText : "Вариант ответа";
            }
            else if (targetNode is OptionNodeImageData)
            {
                optionText = "Изображение";
            }

            options.Add(new Option
            {
                Text = optionText,
                NextNodeGuid = link.TargetNodeGuid
            });
        }

        // Показываем варианты ответа
        if (options.Count > 0 && optionPanel != null)
        {
            optionPanel.ShowOptions(options);
            currentNode = optionNode;
        }
        else
        {
            Debug.LogWarning($"No options found for OptionNode {optionNode.Guid}");

            // Пытаемся найти следующий узел
            var nextLink = currentDialogue.NodeLinks.FirstOrDefault(l => l.BaseNodeGuid == optionNode.Guid);
            if (nextLink != null)
            {
                currentNode = GetNodeByGuid(nextLink.TargetNodeGuid);
                ProcessNextNode();
            }
            else
            {
                currentNode = null;
            }
        }
    }

    /// <summary>
    /// Обрабатывает OptionNodeImageData
    /// </summary>
    /// <param name="optionImageNode">Данные узла изображения вариантов ответа</param>
    private void ProcessOptionImageNode(OptionNodeImageData optionImageNode)
    {
        // Получаем варианты ответов из узла
        var options = new List<Option>();

        // Получаем связанные OptionNodeData для всех выходов
        var optionLinks = currentDialogue.NodeLinks
            .Where(l => l.BaseNodeGuid == optionImageNode.Guid)
            .ToList();

        foreach (var link in optionLinks)
        {
            var targetNode = GetNodeByGuid(link.TargetNodeGuid);
            if (targetNode is OptionNodeData optionTarget)
            {
                options.Add(new Option
                {
                    Text = optionTarget.ResponseText,
                    NextNodeGuid = link.TargetNodeGuid
                });
            }
            else if (targetNode is OptionNodeImageData optionImageTarget)
            {
                // Для изображений вариантов ответа
                options.Add(new Option
                {
                    Text = "Изображение", // Исправлено: OptionNodeImageData не имеет ResponseText
                    NextNodeGuid = link.TargetNodeGuid
                });
            }
        }

        // Показываем панель вариантов ответов
        optionPanel.ShowOptions(options);

        // Устанавливаем текущий узел как OptionNode для последующей обработки выбора
        currentNode = optionImageNode;
    }

    /// <summary>
    /// Обрабатывает IntConditionNodeData
    /// </summary>
    /// <param name="intCondition">Данные числового условия</param>
    private void ProcessIntCondition(IntConditionNodeData intCondition)
    {
        // Проверяем условие
        bool conditionResult = ConditionHandler.EvaluateIntCondition(
            intCondition, intVariables);

        // Определяем следующий узел в зависимости от результата
        var nextLinks = currentDialogue.NodeLinks
            .Where(l => l.BaseNodeGuid == intCondition.Guid)
            .ToList();

        // Находим подходящий выход
        foreach (var link in nextLinks)
        {
            if (link.PortName == "True" && conditionResult)
            {
                currentNode = GetNodeByGuid(link.TargetNodeGuid);
                ProcessNextNode();
                return;
            }
            else if (link.PortName == "False" && !conditionResult)
            {
                currentNode = GetNodeByGuid(link.TargetNodeGuid);
                ProcessNextNode();
                return;
            }
        }

        // Если подходящий выход не найден, завершаем диалог
        Debug.LogWarning($"Не найден подходящий выход для условия IntConditionNode {intCondition.Guid}");
        currentNode = null;
    }

    /// <summary>
    /// Обрабатывает StringConditionNodeData
    /// </summary>
    /// <param name="stringCondition">Данные строкового условия</param>
    private void ProcessStringCondition(StringConditionNodeData stringCondition)
    {
        // Проверяем условие
        bool conditionResult = ConditionHandler.EvaluateStringCondition(
            stringCondition, stringVariables);

        // Определяем следующий узел в зависимости от результата
        var nextLinks = currentDialogue.NodeLinks
            .Where(l => l.BaseNodeGuid == stringCondition.Guid)
            .ToList();

        // Находим подходящий выход
        foreach (var link in nextLinks)
        {
            if (link.PortName == "True" && conditionResult)
            {
                currentNode = GetNodeByGuid(link.TargetNodeGuid);
                ProcessNextNode();
                return;
            }
            else if (link.PortName == "False" && !conditionResult)
            {
                currentNode = GetNodeByGuid(link.TargetNodeGuid);
                ProcessNextNode();
                return;
            }
        }

        // Если подходящий выход не найден, завершаем диалог
        Debug.LogWarning($"Не найден подходящий выход для условия StringConditionNode {stringCondition.Guid}");
        currentNode = null;
    }

    /// <summary>
    /// Обрабатывает ModifyIntNodeData
    /// </summary>
    /// <param name="modifyNode">Данные модификатора числа</param>
    private void ProcessModifyIntNode(ModifyIntNodeData modifyNode)
    {
        // Проверяем наличие переменной
        if (!intVariables.ContainsKey(modifyNode.SelectedProperty))
        {
            Debug.LogError($"Переменная {modifyNode.SelectedProperty} не найдена в intVariables");
            currentNode = null;
            return;
        }

        // Применяем операцию
        switch (modifyNode.Operator)
        {
            case OperatorType.Set:
                intVariables[modifyNode.SelectedProperty] = modifyNode.Value;
                break;
            case OperatorType.Add:
                intVariables[modifyNode.SelectedProperty] += modifyNode.Value;
                break;
            case OperatorType.Subtract:
                intVariables[modifyNode.SelectedProperty] -= modifyNode.Value;
                break;
            case OperatorType.Multiply:
                intVariables[modifyNode.SelectedProperty] *= modifyNode.Value;
                break;
            case OperatorType.Divide:
                if (modifyNode.Value != 0)
                    intVariables[modifyNode.SelectedProperty] /= modifyNode.Value;
                else
                    Debug.LogWarning("Деление на ноль в ModifyIntNode");
                break;
            case OperatorType.Increment:
                intVariables[modifyNode.SelectedProperty]++;
                break;
            case OperatorType.Decrement:
                intVariables[modifyNode.SelectedProperty]--;
                break;
        }

        // Находим следующий узел
        var nextLink = currentDialogue.NodeLinks
            .FirstOrDefault(l => l.BaseNodeGuid == modifyNode.Guid);

        if (nextLink != null)
        {
            currentNode = GetNodeByGuid(nextLink.TargetNodeGuid);
            ProcessNextNode();
        }
        else
        {
            currentNode = null;
        }
    }

    /// <summary>
    /// Обрабатывает EndNodeData
    /// </summary>
    /// <param name="endNode">Данные конечного узла</param>
    private void ProcessEndNode(EndNodeData endNode)
    {
        // Добавляем системное сообщение о завершении диалога
        var message = new Message
        {
            Type = SenderType.System,
            Text = "Диалог завершен"
        };
        chatPanel.AddMessage(message, MessageType.System);

        // Если указан следующий диалог, запускаем его
        if (!string.IsNullOrEmpty(endNode.NextDialogueName))
        {
            DialogueContainer nextDialogue = Resources.Load<DialogueContainer>(endNode.NextDialogueName);
            if (nextDialogue != null)
            {
                StartDialogue(nextDialogue);
            }
            else
            {
                Debug.LogError($"Диалог {endNode.NextDialogueName} не найден в ресурсах");
            }
        }
        else
        {
            // Завершаем текущий диалог
            currentNode = null;
        }
    }

    /// <summary>
    /// Обработка выбора опции игроком с задержкой перед следующим сообщением
    /// </summary>
    public void HandleOptionSelection(string nextNodeGuid)
    {
        // Сразу скрываем панель
        if (optionPanel != null)
            optionPanel.Hide();

        // Получаем текст опции через обратную связь
        var linkToNext = currentDialogue.NodeLinks
            .FirstOrDefault(l => l.TargetNodeGuid == nextNodeGuid);

        if (linkToNext != null)
        {
            var optionNode = GetNodeByGuid(linkToNext.BaseNodeGuid);
            string optionText = "Изображение";

            if (optionNode is OptionNodeData opt)
                optionText = !string.IsNullOrEmpty(opt.ResponseText) ? opt.ResponseText : "Неизвестный вариант";

            var message = new Message
            {
                Type = SenderType.Player,
                Text = optionText // ← без префикса!
            };
            chatPanel.AddMessage(message, MessageType.OptionText);
        }

        // Устанавливаем следующий узел и продолжаем
        currentNode = GetNodeByGuid(nextNodeGuid);
        ProcessNextNode(); // ← сразу, без задержки
    }

    /// <summary>
    /// Задержка перед обработкой следующего узла (для плавности диалога)
    /// </summary>
    private IEnumerator DelayedProcessNextNode()
    {
        yield return new WaitForSeconds(messageDelay);
        ProcessNextNode();
    }

    /// <summary>
    /// Получает узел по его GUID
    /// </summary>
    /// <param name="guid">GUID узла</param>
    /// <returns>BaseNodeData или null</returns>
    private object GetNodeByGuid(string guid)
    {
        if (string.IsNullOrEmpty(guid))
            return null;

        // Ищем в всех типах узлов
        var speechNode = currentDialogue.SpeechNodeDatas.FirstOrDefault(n => n.Guid == guid);
        if (speechNode != null) return speechNode;

        var speechImageNode = currentDialogue.SpeechNodeImageDatas.FirstOrDefault(n => n.Guid == guid);
        if (speechImageNode != null) return speechImageNode;

        var optionNode = currentDialogue.OptionNodeDatas.FirstOrDefault(n => n.Guid == guid);
        if (optionNode != null) return optionNode;

        var optionImageNode = currentDialogue.OptionNodeImageDatas.FirstOrDefault(n => n.Guid == guid);
        if (optionImageNode != null) return optionImageNode;

        var intConditionNode = currentDialogue.IntConditionNodeDatas.FirstOrDefault(n => n.Guid == guid);
        if (intConditionNode != null) return intConditionNode;

        var stringConditionNode = currentDialogue.StringConditionNodeDatas.FirstOrDefault(n => n.Guid == guid);
        if (stringConditionNode != null) return stringConditionNode;

        var modifyIntNode = currentDialogue.ModifyIntNodeDatas.FirstOrDefault(n => n.Guid == guid);
        if (modifyIntNode != null) return modifyIntNode;

        var endNode = currentDialogue.EndNodeDatas.FirstOrDefault(n => n.Guid == guid);
        if (endNode != null) return endNode;

        var charIntConditionNode = currentDialogue.CharacterIntConditionNodeDatas.FirstOrDefault(n => n.Guid == guid);
        if (charIntConditionNode != null) return charIntConditionNode;

        var charModifyIntNode = currentDialogue.CharacterModifyIntNodeDatas.FirstOrDefault(n => n.Guid == guid);
        if (charModifyIntNode != null) return charModifyIntNode;

        return currentDialogue.EntryNodeData;
    }

    /// <summary>
    /// Воспроизводит аудио с задержкой после отображения текста
    /// </summary>
    /// <param name="audioClip">Аудио клип для воспроизведения</param>
    /// <param name="delay">Задержка в секундах</param>
    /// <returns>Корутину для воспроизведения аудио</returns>
    private IEnumerator PlayAudioAfterDelay(AudioClip audioClip, float delay)
    {
        yield return new WaitForSeconds(delay);
        AudioSource.PlayClipAtPoint(audioClip, Camera.main.transform.position);
    }

    /// <summary>
    /// Сбрасывает текущий диалог
    /// </summary>
    public void ResetDialogue()
    {
        currentDialogue = null;
        currentNode = null;
        visitedNodes.Clear();
        ResetVariables();
    }

    /// <summary>
    /// Получает персонажа по GUID (заглушка для runtime)
    /// </summary>
    /// <param name="guid">GUID персонажа</param>
    /// <returns>CharacterData или null</returns>
    private CharacterData GetCharacterByGuid(string guid)
    {
        // В runtime нет AssetDatabase, поэтому используем заглушку
        // В реальной системе нужно реализовать загрузку из Resources
        return null;
    }

    /// <summary>
    /// Вспомогательный класс для загрузки ассетов в runtime
    /// </summary>
    public static class AssetLoader
    {
        /// <summary>
        /// Загружает аудио клип по GUID (заглушка для runtime)
        /// </summary>
        /// <param name="guid">GUID аудио</param>
        /// <returns>AudioClip или null</returns>
        public static AudioClip LoadAudioClip(string guid)
        {
            // В runtime нет AssetDatabase, поэтому используем заглушку
            // В реальной системе нужно реализовать загрузку из Resources
            return null;
        }

        /// <summary>
        /// Загружает спрайт по GUID (заглушка для runtime)
        /// </summary>
        /// <param name="guid">GUID спрайта</param>
        /// <returns>Sprite или null</returns>
        public static Sprite LoadSprite(string guid)
        {
            // В runtime нет AssetDatabase, поэтому используем заглушку
            // В реальной системе нужно реализовать загрузку из Resources
            return null;
        }
    }

    private void ProcessCharacterIntCondition(CharacterIntConditionNodeData condition)
    {
        var character = CharacterManager.Instance.GetCharacter(condition.CharacterName);
        if (character == null)
        {
            Debug.LogError($"Character '{condition.CharacterName}' not found for condition node.");
            currentNode = null;
            return;
        }

        if (!character.TryGetVariable(condition.SelectedVariable, out var variable))
        {
            Debug.LogError($"Variable '{condition.SelectedVariable}' not found on character '{condition.CharacterName}'.");
            currentNode = null;
            return;
        }

        bool result = false;
        switch (condition.Comparison)
        {
            case ComparisonType.Equal: result = variable.Value == condition.CompareValue; break;
            case ComparisonType.NotEqual: result = variable.Value != condition.CompareValue; break;
            case ComparisonType.Greater: result = variable.Value > condition.CompareValue; break;
            case ComparisonType.Less: result = variable.Value < condition.CompareValue; break;
            case ComparisonType.GreaterOrEqual: result = variable.Value >= condition.CompareValue; break;
            case ComparisonType.LessOrEqual: result = variable.Value <= condition.CompareValue; break;
            default: result = false; break;
        }

        var nextLinks = currentDialogue.NodeLinks.Where(l => l.BaseNodeGuid == condition.Guid).ToList();
        foreach (var link in nextLinks)
        {
            if ((link.PortName == "True" && result) || (link.PortName == "False" && !result))
            {
                currentNode = GetNodeByGuid(link.TargetNodeGuid);
                ProcessNextNode();
                return;
            }
        }
        Debug.LogWarning($"No matching output port for CharacterIntConditionNode {condition.Guid}");
        currentNode = null;
    }

    private void ProcessCharacterModifyInt(CharacterModifyIntNodeData modify)
    {
        var character = CharacterManager.Instance.GetCharacter(modify.CharacterName);
        if (character == null)
        {
            Debug.LogError($"Character '{modify.CharacterName}' not found for modify node.");
            currentNode = null;
            return;
        }

        if (!character.TryGetVariable(modify.SelectedVariable, out var variable))
        {
            Debug.LogError($"Variable '{modify.SelectedVariable}' not found on character '{modify.CharacterName}'.");
            currentNode = null;
            return;
        }

        switch (modify.Operator)
        {
            case OperatorType.Set: variable.Value = modify.Value; break;
            case OperatorType.Add: variable.Value += modify.Value; break;
            case OperatorType.Subtract: variable.Value -= modify.Value; break;
            case OperatorType.Multiply: variable.Value *= modify.Value; break;
            case OperatorType.Divide:
                if (modify.Value != 0) variable.Value /= modify.Value;
                else Debug.LogWarning("Division by zero in CharacterModifyIntNode");
                break;
            case OperatorType.Increment: variable.Value++; break;
            case OperatorType.Decrement: variable.Value--; break;
        }

        var nextLink = currentDialogue.NodeLinks.FirstOrDefault(l => l.BaseNodeGuid == modify.Guid);
        if (nextLink != null)
        {
            currentNode = GetNodeByGuid(nextLink.TargetNodeGuid);
            ProcessNextNode();
        }
        else currentNode = null;
    }
}

//==== File 6 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Message.cs ====
using UnityEngine;

/// <summary>
/// ������ ������ ��� ��������� � ����
/// </summary>
[System.Serializable]
public class Message
{
    /// <summary>
    /// ��� ���������: NPC, ����� ��� ���������
    /// </summary>
    public SenderType Type;

    /// <summary>
    /// ����� ��������� (��� ��������� ���������)
    /// </summary>
    public string Text;

    /// <summary>
    /// ����������� ��� ��������� (������)
    /// </summary>
    public Sprite Image;

    /// <summary>
    /// ����� ��� ��������� ( AudioClip )
    /// </summary>
    public AudioClip Audio;

    /// <summary>
    /// ��������, ����������� ��������� (��� NPC)
    /// </summary>
    public CharacterData Sender;
}

/// <summary>
/// ���� ��������� � ����
/// </summary>
public enum SenderType
{
    NPC,      // ��������� �� NPC
    Player,   // ��������� �� ������
    System    // ��������� ��������� (��������, "������ ��������")
}

public enum MessageType
{
    System,
    Speech, SpeechText, SpeechImage, SpeechAudio,
    OptionText, OptionImage, OptionAudio,
    Event, Log
}



//==== File 7 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\MessageObject.cs ====
using UnityEngine;

public interface IMessageObject
{
    void InitializationContent(Message contentMessage);
    void SetCharacterAvatar(CharacterData characte);
    void SetCharacterName(CharacterData character);
}


//==== File 8 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Option.cs ====
using System;

/// <summary>
/// ������ �������� ������
/// </summary>
[Serializable]
public class Option
{
    public string Text; // ����� ��������
    public string NextNodeGuid; // GUID ���������� ����
}

//==== File 9 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\OptionPanel.cs ====
using System;
using System.Collections.Generic;
using TMPro;
using UnityEngine;
using UnityEngine.UI;

public class OptionPanel : MonoBehaviour
{
    [SerializeField] private GameObject optionButtonPrefab;
    [SerializeField] private Transform contentContainer;

    public event Action<string> onOptionSelected;

    /// <summary>
    /// ���������� ������ � ���������� �������
    /// </summary>
    public void ShowOptions(List<Option> options)
    {
        if (optionButtonPrefab == null || contentContainer == null)
        {
            Debug.LogError("OptionPanel references not set!");
            return;
        }

        // ������� ���������� ������
        foreach (Transform child in contentContainer)
            Destroy(child.gameObject);

        // ������� ������ ��� ������� ��������
        foreach (var option in options)
        {
            var buttonGO = Instantiate(optionButtonPrefab, contentContainer);
            var button = buttonGO.GetComponent<Button>();
            var buttonText = buttonGO.GetComponentInChildren<TMP_Text>();

            if (buttonText != null)
                buttonText.text = option.Text;
            else
                Debug.LogError("Text component not found in option button prefab");

            if (button != null)
            {
                button.onClick.AddListener(() =>
                {
                    onOptionSelected?.Invoke(option.NextNodeGuid);
                    // ������� ��� ������ � �������� ������ � �� ������ ��� � DialogueManager
                    // ����� ������ �������� ������� � ������� ����� � HandleOptionSelection
                }); ;
            }
        }

        gameObject.SetActive(true);
    }

    /// <summary>
    /// �������� ������ ���������
    /// </summary>
    public void Hide()
    {
        gameObject.SetActive(false);
    }
}

//==== File 10 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\OptionTextMessage.cs ====
using UnityEngine;
using TMPro;

public class OptionTextMessage : MonoBehaviour, IMessageObject
{
    [Header("Message Data")]
    [SerializeField] private TMP_Text textMessage;
    public void InitializationContent(Message contentMessage)
    {
        if (!string.IsNullOrEmpty(contentMessage.Text))
            textMessage.text = contentMessage.Text;
        else textMessage.text = "";

        SetCharacterAvatar(contentMessage.Sender);
        SetCharacterName(contentMessage.Sender);
    }

    public void SetCharacterAvatar(CharacterData characte)
    {
        
    }

    public void SetCharacterName(CharacterData character)
    {
        
    }
}


//==== File 11 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\SpeechTextMessage.cs ====
using UnityEngine.UI;
using UnityEngine;
using TMPro;

public class SpeechTextMessage : MonoBehaviour, IMessageObject
{
    [Header("Character Data")]
    [SerializeField] private Image characterAvatar;
    [SerializeField] private TMP_Text characterName;

    [Header("Message Data")]
    [SerializeField] private TMP_Text textMessage;

    private RectTransform _rectTransform;
    private ContentSizeFitter _contentSizeFitter;

    private void Awake()
    {
        _rectTransform = GetComponent<RectTransform>();
        _contentSizeFitter = GetComponent<ContentSizeFitter>();

        if (_contentSizeFitter == null)
            _contentSizeFitter = gameObject.AddComponent<ContentSizeFitter>();

        // �����: ��� ������ �� ������, ������ � ����������� ����� RectTransform
        _contentSizeFitter.horizontalFit = ContentSizeFitter.FitMode.Unconstrained;
        _contentSizeFitter.verticalFit = ContentSizeFitter.FitMode.PreferredSize;

        // ��������� TMP
        if (textMessage != null)
        {
            textMessage.enableWordWrapping = true;
            textMessage.textWrappingMode = TextWrappingModes.Normal;
            textMessage.overflowMode = TextOverflowModes.Overflow; // �� ��������
        }
    }

    public void InitializationContent(Message contentMessage)
    {
        if (textMessage == null)
        {
            Debug.LogError("textMessage is not assigned!");
            return;
        }

        textMessage.text = !string.IsNullOrEmpty(contentMessage.Text) ? contentMessage.Text : "";

        // ������������� ������������ ������ = 80% ������
        float maxWidth = Screen.width * 0.8f;

        // ������������ ������ ����� RectTransform
        _rectTransform.SetSizeWithCurrentAnchors(RectTransform.Axis.Horizontal, maxWidth);

        // ������������� ��������� �����, ����� ������� ��������
        textMessage.ForceMeshUpdate();

        SetCharacterAvatar(contentMessage.Sender);
        SetCharacterName(contentMessage.Sender);
    }

    public void SetCharacterAvatar(CharacterData character)
    {
        if (characterAvatar != null && character != null && character.Icon != null)
            characterAvatar.sprite = character.Icon;
    }

    public void SetCharacterName(CharacterData character)
    {
        if (characterName != null && character != null)
        {
            characterName.text = character.FirstName;
            characterName.color = character.NameColor;
        }
    }
}

//==== File 12 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph.cs ====
using System.Linq;
using UnityEditor;
using UnityEditor.UIElements;
using UnityEngine;
using UnityEngine.UIElements;

/// <summary>
/// Главное окно редактора диалоговых графов
/// Содержит тулбар и область для редактирования графа
/// </summary>
public class DialogueGraph : EditorWindow
{
    public DialogueGraphView graphView;
    private string fileName = "New Narrative";

    /// <summary>
    /// Открывает окно редактора диалоговых графов
    /// </summary>
    [MenuItem("Dialog System/Open Graph Editor")]
    public static void OpenDialogueGraphWindow()
    {
        var window = GetWindow<DialogueGraph>();
        window.titleContent = new GUIContent("Dialogue Graph");
    }

    /// <summary>
    /// Инициализация окна редактора
    /// </summary>
    private void OnEnable()
    {
        ConstructGraphView();
        GenerateToolbar();
    }

    /// <summary>
    /// Создает область для редактирования графа
    /// </summary>
    private void ConstructGraphView()
    {
        graphView = new DialogueGraphView(this)
        {
            name = "Dialogue Graph"
        };

        graphView.StretchToParentSize();
        rootVisualElement.Add(graphView);
    }

    /// <summary>
    /// Генерация тулбара с новыми элементами управления
    /// </summary>
    private void GenerateToolbar()
    {
        var toolbar = new Toolbar();

        // Поле выбора существующего файла диалога
        var dialogueAssetField = new ObjectField("Dialogue File")
        {
            objectType = typeof(DialogueContainer),
            value = null
        };
        dialogueAssetField.name = "Dialogue File"; // важно для поиска через Q
        dialogueAssetField.RegisterValueChangedCallback(evt =>
        {
            if (evt.newValue is DialogueContainer container)
            {
                LoadDialogueFromFile(container);
            }
        });
        toolbar.Add(dialogueAssetField);

        // Кнопка создания нового диалога
        toolbar.Add(new Button(CreateNewDialogue) { text = "Create New..." });

        // Кнопка загрузки через проводник
        toolbar.Add(new Button(LoadDialogueFromFileBrowser) { text = "Load File..." });

        // Кнопка сохранения
        toolbar.Add(new Button(SaveCurrentDialogue) { text = "Save" });

        // Base Character field (в конце)
        var baseCharacterField = new ObjectField("Base Character")
        {
            objectType = typeof(CharacterData),
            value = AssetDatabaseHelper.LoadAssetFromGuid<CharacterData>(graphView.BaseCharacterGuid)
        };
        baseCharacterField.RegisterValueChangedCallback(evt =>
        {
            var character = evt.newValue as CharacterData;
            graphView.BaseCharacterGuid = AssetDatabaseHelper.GetAssetGuid(character);
            UpdateAllSpeechNodesSpeaker(character);
            graphView.MarkUnsavedChangeWithoutFile(); // ← добавлено
        });
        toolbar.Add(baseCharacterField);

        rootVisualElement.Add(toolbar);
    }

    /// <summary>
    /// Создаёт новый диалог и сохраняет его по указанному пользователем пути
    /// </summary>
    private void CreateNewDialogue()
    {
        string path = EditorUtility.SaveFilePanelInProject(
            "Create New Dialogue",
            "NewDialogue",
            "asset",
            "Choose location and name for the new dialogue file"
        );
        if (string.IsNullOrEmpty(path))
            return;

        // Создаём контейнер
        var newContainer = ScriptableObject.CreateInstance<DialogueContainer>();

        // Сохраняем текущее состояние графа в контейнер
        var saveUtility = GraphSaveUtility.GetInstance(graphView);
        // Временно сохраняем в контейнер без записи в AssetDatabase
        saveUtility.SaveGraphToExistingContainer(newContainer);

        // Сохраняем файл
        AssetDatabase.CreateAsset(newContainer, path);
        AssetDatabase.SaveAssets();

        // Обновляем ObjectField
        var assetField = rootVisualElement.Q<ObjectField>("Dialogue File");
        if (assetField != null)
            assetField.SetValueWithoutNotify(newContainer);

        // Загружаем (это сбросит флаги)
        LoadDialogueFromFile(newContainer);

        // Сбрасываем состояние "без файла"
        graphView._hasUnsavedChangesWithoutFile = false;
        graphView._unsavedChangesWarningShown = false;

        Debug.Log($"Created new dialogue: {path}");
    }

    /// <summary>
    /// Загружает диалог из выбранного в ObjectField контейнера
    /// </summary>
    private void LoadDialogueFromFile(DialogueContainer container)
    {
        if (container == null) return;

        var saveUtility = GraphSaveUtility.GetInstance(graphView);
        saveUtility.LoadGraphFromContainer(container);

        // Обновляем GUID базового персонажа в графе
        graphView.BaseCharacterGuid = container.BaseCharacterGuid;

        // Обновляем отображение Base Character в тулбаре
        var baseCharField = rootVisualElement.Q<ObjectField>("Base Character");
        if (baseCharField != null)
        {
            baseCharField.SetValueWithoutNotify(
                AssetDatabaseHelper.LoadAssetFromGuid<CharacterData>(container.BaseCharacterGuid)
            );
        }
    }

    /// <summary>
    /// Открывает проводник для выбора существующего .asset файла диалога
    /// </summary>
    private void LoadDialogueFromFileBrowser()
    {
        string path = EditorUtility.OpenFilePanel(
            "Load Dialogue File",
            Application.dataPath,
            "asset"
        );

        if (string.IsNullOrEmpty(path)) return;

        // Преобразуем абсолютный путь в относительный от Assets
        if (!path.StartsWith(Application.dataPath))
        {
            EditorUtility.DisplayDialog("Invalid Path", "Please select a file inside the Assets folder.", "OK");
            return;
        }

        string relativePath = "Assets" + path.Substring(Application.dataPath.Length);
        var container = AssetDatabase.LoadAssetAtPath<DialogueContainer>(relativePath);

        if (container == null)
        {
            EditorUtility.DisplayDialog("Invalid File", "Selected file is not a valid DialogueContainer.", "OK");
            return;
        }

        // Обновляем ObjectField
        var assetField = rootVisualElement.Q<ObjectField>("Dialogue File");
        if (assetField != null)
            assetField.SetValueWithoutNotify(container);

        LoadDialogueFromFile(container);

        graphView._hasUnsavedChangesWithoutFile = false;
        graphView._unsavedChangesWarningShown = false;
    }

    /// <summary>
    /// Сохраняет текущий граф в уже загруженный/созданный файл
    /// </summary>
    private void SaveCurrentDialogue()
    {
        var container = GetCurrentLoadedContainer();
        if (container == null)
        {
            EditorUtility.DisplayDialog("No File", "No dialogue file is currently loaded. Please create or load one first.", "OK");
            return;
        }

        var saveUtility = GraphSaveUtility.GetInstance(graphView);
        saveUtility.SaveGraphToExistingContainer(container);
        EditorUtility.DisplayDialog("Saved", "Dialogue saved successfully!", "OK");
    }

    /// <summary>
    /// Вспомогательный метод: получает текущий загруженный контейнер по пути
    /// </summary> 
    private DialogueContainer GetCurrentLoadedContainer()
    {
        var assetField = rootVisualElement.Q<ObjectField>("Dialogue File");
        return assetField?.value as DialogueContainer;
    }

    /// <summary>
    /// Обрабатывает запрос на сохранение или загрузку данных
    /// </summary>
    private void RequestDataOperation(bool save)
    {
        if (string.IsNullOrEmpty(fileName))
        {
            EditorUtility.DisplayDialog("Invalid file name!", "Please enter a valid file name.", "OK");
            return;
        }

        var saveUtility = GraphSaveUtility.GetInstance(graphView);
        if (save)
            saveUtility.SaveGraph(fileName);
        else
            saveUtility.LoadGraph(fileName);
    }

    /// <summary>
    /// Очищает ресурсы при закрытии окна
    /// </summary>
    private void OnDisable()
    {
        rootVisualElement.Remove(graphView);
    }

    private void UpdateAllSpeechNodesSpeaker(CharacterData character)
    {
        foreach (var node in graphView.nodes.ToList().OfType<SpeechNode>())
        {
            node.SetSpeaker(character);
        }
    }


}

//==== File 13 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\EventNodeHelperSO.cs ====
using UnityEngine.Events;
using UnityEngine;

public class EventNodeHelperSO : ScriptableObject { public UnityEvent Event = new UnityEvent(); }


//==== File 14 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\MarkdownToTMP.cs ====
// Assets/Scripts/Editor/MarkdownToTMP.cs
using System.Text.RegularExpressions;
using System;

public static class MarkdownToTMP
{
    public static string Convert(string markdown)
    {
        if (string.IsNullOrEmpty(markdown))
            return markdown;

        string result = markdown;

        // --- �������������� �����
        result = Regex.Replace(result, @"^\s*---\s*$", "<sprite name=\"Divider\">", RegexOptions.Multiline);

        // --- ���������
        result = Regex.Replace(result, @"^######\s+(.*)$", "<size=90%><b>$1</b></size>", RegexOptions.Multiline);
        result = Regex.Replace(result, @"^#####\s+(.*)$", "<size=100%><b>$1</b></size>", RegexOptions.Multiline);
        result = Regex.Replace(result, @"^####\s+(.*)$", "<size=105%><b>$1</b></size>", RegexOptions.Multiline);
        result = Regex.Replace(result, @"^###\s+(.*)$", "<size=110%><b>$1</b></size>", RegexOptions.Multiline);
        result = Regex.Replace(result, @"^##\s+(.*)$", "<size=115%><b>$1</b></size>", RegexOptions.Multiline);
        result = Regex.Replace(result, @"^#\s+(.*)$", "<size=120%><b>$1</b></size>", RegexOptions.Multiline);

        // --- ������
        result = Regex.Replace(result, @"^\s*-\s+(.+)$", "� $1\n", RegexOptions.Multiline);
        result = Regex.Replace(result, @"^\s*\d+\.\s+(.+)$", "$0\n", RegexOptions.Multiline);

        // --- ������
        result = Regex.Replace(result, @"^\s*>\s+(.+)$", "<i><color=#888888>�$1�</color></i>", RegexOptions.Multiline);

        // --- ���� ����
        result = Regex.Replace(result, @"```([\s\S]*?)```", match =>
        {
            string code = match.Groups[1].Value;
            return $"<color=#ddd>{EscapeTMP(code)}</color>";
        }, RegexOptions.Multiline);

        // --- ������-���
        result = Regex.Replace(result, @"`([^`]+)`", "<color=#aaa>$1</color>");

        // --- ������
        result = Regex.Replace(result, @"\[([^\]]+)\]\(([^)]+)\)", "<link=\"$2\"><u>$1</u></link>");

        // --- �����������
        result = Regex.Replace(result, @"!\[([^\]]*)\]\(([^)]+)\)", "<sprite name=\"$1\">");

        // --- ����� � ������������ (3 �������)
        for (int i = 0; i < 3; i++)
        {
            result = Regex.Replace(result, @"\*\*([^*]+)\*\*", "<b>$1</b>");
            result = Regex.Replace(result, @"\*([^*]+)\*", "<i>$1</i>");
            result = Regex.Replace(result, @"~~([^~]+)~~", "<s>$1</s>");
            result = Regex.Replace(result, @"__([^_]+)__", "<u>$1</u>");
        }

        return result.TrimEnd('\n');
    }

    private static string EscapeTMP(string text)
    {
        return text?.Replace("<", "<").Replace(">", ">");
    }

}


//==== File 15 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\TextEditorModalWindow.cs ====
// Assets/Scripts/Editor/TextEditorModalWindow.cs
using UnityEngine;
using UnityEngine.UIElements;
using UnityEditor;
using UnityEditor.UIElements;
using System;
using System.Collections.Generic;

public class TextEditorModalWindow : VisualElement
{
    private IMGUIContainer _imguiContainer;
    private string _text;
    private int _selectionStart;
    private int _selectionEnd;
    private Label _guidLabel;
    private string _nodeGuid;
    private Action<string> _onTextChanged;

    public TextEditorModalWindow(string initialText, string nodeGuid, Action<string> onTextChanged)
    {
        _text = initialText ?? "";
        _nodeGuid = nodeGuid;
        _onTextChanged = onTextChanged;

        style.flexDirection = FlexDirection.Column;
        style.backgroundColor = new StyleColor(new Color(0.15f, 0.15f, 0.15f));
        style.borderTopWidth = style.borderBottomWidth = style.borderLeftWidth = style.borderRightWidth = 1;
        style.borderTopColor = style.borderBottomColor = style.borderLeftColor = style.borderRightColor = new StyleColor(new Color(0.3f, 0.3f, 0.3f));
        style.paddingTop = style.paddingBottom = 8;
        style.paddingLeft = style.paddingRight = 8;
        style.minWidth = 400;
        style.maxWidth = 700;
        style.minHeight = 300;
        style.maxHeight = 600;

        // Заголовок окна
        var header = new VisualElement { style = { flexDirection = FlexDirection.Row, justifyContent = Justify.SpaceBetween, alignItems = Align.Center, marginBottom = 5 } };
        var title = new Label("Edit Text") { style = { fontSize = 12, unityFontStyleAndWeight = FontStyle.Bold } };
        var closeButton = new Button(() => Close()) { text = "×" };
        closeButton.style.width = 24;
        closeButton.style.height = 20;
        closeButton.style.marginLeft = 10;
        header.Add(title);
        header.Add(closeButton);
        Add(header);

        // === Панель форматирования ===
        var formatHeader = new Label("Formatting Tools")
        {
            style =
            {
                fontSize = 10,
                color = Color.gray,
                alignSelf = Align.FlexStart,
                marginBottom = 4
            }
        };
        Add(formatHeader);

        // --- Контейнер для всех кнопок форматирования ---
        var formattingGroup = new VisualElement
        {
            style =
    {
        //backgroundColor = new StyleColor(new Color(0.2f, 0.2f, 0.2f)),
        paddingTop = 8,
        paddingBottom = 8,
        paddingLeft = 8,
        paddingRight = 8,
        //borderRadius = 4,
        marginBottom = 8,
        flexWrap = Wrap.Wrap,
        flexDirection = FlexDirection.Row,
        alignItems = Align.FlexStart,
        justifyContent = Justify.FlexStart,
        minHeight = 36 // Минимум под 1 строку кнопок
    }
        };
        formattingGroup.style.flexGrow = 0; // Не растягивать по высоте принудительно

        // Базовое форматирование
        AddButton(formattingGroup, "B", "<b>", "</b>", "жирный текст");
        AddButton(formattingGroup, "I", "<i>", "</i>", "курсив");
        AddButton(formattingGroup, "S", "<s>", "</s>", "зачёркнутый");
        AddButton(formattingGroup, "U", "<u>", "</u>", "подчёркнутый");

        // Расширенное форматирование
        var btnColor = new Button(OpenColorPicker) { text = "Цвет" };
        var btnSize = new Button(OpenSizePicker) { text = "Размер" };
        var btnSprite = new Button(OpenSpritePicker) { text = "Спрайт" };
        var btnLink = new Button(OpenLinkPicker) { text = "Ссылка" };
        var btnAlign = new Button(OpenAlignPicker) { text = "Выравн." };
        var btnGradient = new Button(() => WrapSelection("<gradient>", "</gradient>", "градиент")) { text = "Град." };
        var btnOutline = new Button(() => WrapSelection("<outline>", "</outline>", "обводка")) { text = "Outline" };
        var btnSoftShadow = new Button(() => WrapSelection("<soft-shadow>", "</soft-shadow>", "тень")) { text = "Shadow" };

        var advancedButtons = new[] { btnColor, btnSize, btnSprite, btnLink, btnAlign, btnGradient, btnOutline, btnSoftShadow };
        foreach (var btn in advancedButtons)
        {
            btn.style.marginRight = 4;
            btn.style.marginBottom = 4; // ← Добавлен нижний отступ для переноса
            btn.style.height = 24;
            formattingGroup.Add(btn);
        }

        Add(formattingGroup);

        // --- Кнопки конвертации (отдельно) ---
        var convertToolbar = new VisualElement { style = { flexDirection = FlexDirection.Row, justifyContent = Justify.FlexEnd } };
        var btnToTMP = new Button(ConvertToTMP) { text = "→ TMP" };
        btnToTMP.style.backgroundColor = new StyleColor(new Color(0.2f, 0.4f, 0.6f));
        btnToTMP.style.color = Color.white;
        btnToTMP.style.marginLeft = 4;

        var btnToMD = new Button(ConvertToMarkdown) { text = "← MD" };
        btnToMD.style.backgroundColor = new StyleColor(new Color(0.4f, 0.2f, 0.6f));
        btnToMD.style.color = Color.white;
        btnToMD.style.marginLeft = 4;

        convertToolbar.Add(btnToTMP);
        convertToolbar.Add(btnToMD);
        Add(convertToolbar);

        // IMGUI Container для текстового поля
        _imguiContainer = new IMGUIContainer(() =>
        {
            EditorGUI.BeginChangeCheck();
            var rect = GUILayoutUtility.GetRect(0, 1000, 200, 600);
            var newText = EditorGUI.TextArea(rect, _text);
            if (Event.current.type == EventType.Repaint)
            {
                var editor = (TextEditor)GUIUtility.GetStateObject(typeof(TextEditor), GUIUtility.keyboardControl);
                _selectionStart = editor.cursorIndex;
                _selectionEnd = editor.selectIndex;
            }
            if (EditorGUI.EndChangeCheck())
            {
                _text = newText;
                _onTextChanged?.Invoke(_text);
            }
        });
        _imguiContainer.style.flexGrow = 1;
        Add(_imguiContainer);

        // Кнопки Copy / Paste / Clear
        var buttonRow = new VisualElement { style = { flexDirection = FlexDirection.Row, justifyContent = Justify.SpaceBetween } };
        var copyBtn = new Button(() => EditorGUIUtility.systemCopyBuffer = _text) { text = "Copy" };
        var pasteBtn = new Button(() =>
        {
            if (!string.IsNullOrEmpty(EditorGUIUtility.systemCopyBuffer))
            {
                _text = EditorGUIUtility.systemCopyBuffer;
                _onTextChanged?.Invoke(_text);
            }
        })
        { text = "Paste" };
        var clearBtn = new Button(() =>
        {
            _text = "";
            _onTextChanged?.Invoke("");
        })
        { text = "Clear" };
        buttonRow.Add(copyBtn);
        buttonRow.Add(pasteBtn);
        buttonRow.Add(clearBtn);
        Add(buttonRow);

        // GUID узла
        _guidLabel = new Label($"Node GUID: {_nodeGuid}") { style = { fontSize = 9, color = Color.gray, marginTop = 8 } };
        Add(_guidLabel);
    }

    private void AddButton(VisualElement parent, string label, string openTag, string closeTag, string placeholder)
    {
        var btn = new Button(() => WrapSelection(openTag, closeTag, placeholder)) { text = label };
        btn.style.marginRight = 4;
        btn.style.width = 40;
        btn.style.height = 24;
        parent.Add(btn);
    }

    private void WrapSelection(string openTag, string closeTag, string placeholder)
    {
        string selected = _text.Substring(Math.Min(_selectionStart, _selectionEnd), Math.Abs(_selectionEnd - _selectionStart));
        bool hadSelection = !string.IsNullOrEmpty(selected);
        if (!hadSelection)
        {
            selected = placeholder;
            _selectionStart = _selectionEnd;
        }
        string newText = _text.Substring(0, Math.Min(_selectionStart, _selectionEnd)) + openTag + selected + closeTag + _text.Substring(Math.Max(_selectionStart, _selectionEnd));
        _text = newText;
        int newCursorPos = Math.Min(_selectionStart, _selectionEnd) + openTag.Length;
        _selectionStart = newCursorPos;
        _selectionEnd = newCursorPos + selected.Length;
        _onTextChanged?.Invoke(_text);
        _imguiContainer.MarkDirtyRepaint();
    }

    private void OpenColorPicker()
    {
        string selected = GetSelectedOrPlaceholder("цветной текст");
        var modal = CreateModalBase();
        var colorField = new ColorField("Цвет") { value = Color.white };
        var confirm = new Button(() =>
        {
            string hex = ColorUtility.ToHtmlStringRGB(colorField.value);
            WrapSelection($"<color=#{hex}>", "</color>", selected);
            modal.RemoveFromHierarchy();
            _imguiContainer.MarkDirtyRepaint();
        })
        { text = "OK" };
        AddModalButtons(modal, confirm, () => modal.RemoveFromHierarchy());
        modal.Add(new Label("Выберите цвет:"));
        modal.Add(colorField);
        this.parent?.Add(modal);
    }

    private void OpenSizePicker()
    {
        var modal = CreateModalBase();
        var intField = new IntegerField("Значение (%)") { value = 100 };
        var confirm = new Button(() =>
        {
            WrapSelection($"<size={intField.value}%>", "</size>", "текст");
            modal.RemoveFromHierarchy();
            _imguiContainer.MarkDirtyRepaint();
        })
        { text = "OK" };
        AddModalButtons(modal, confirm, () => modal.RemoveFromHierarchy());
        modal.Add(new Label("Введите размер (%):"));
        modal.Add(intField);
        this.parent?.Add(modal);
    }

    private void OpenSpritePicker()
    {
        var modal = CreateModalBase();
        var textField = new TextField("Имя спрайта") { value = "my_sprite" };
        var confirm = new Button(() =>
        {
            if (!string.IsNullOrWhiteSpace(textField.value))
            {
                string tag = $"<sprite name=\"{textField.value.Trim()}\">";
                string newText = _text.Substring(0, _selectionStart) + tag + _text.Substring(_selectionEnd);
                _text = newText;
                _selectionStart = _selectionEnd = _selectionStart + tag.Length;
                _onTextChanged?.Invoke(_text);
            }
            modal.RemoveFromHierarchy();
            _imguiContainer.MarkDirtyRepaint();
        })
        { text = "OK" };
        AddModalButtons(modal, confirm, () => modal.RemoveFromHierarchy());
        modal.Add(new Label("Введите имя спрайта:"));
        modal.Add(textField);
        this.parent?.Add(modal);
    }

    private void OpenLinkPicker()
    {
        var modal = CreateModalBase();
        var textField = new TextField("URL") { value = "https://example.com" };
        var confirm = new Button(() =>
        {
            if (!string.IsNullOrWhiteSpace(textField.value))
            {
                string url = textField.value.Trim();
                string openTag = $"<link=\"{url}\"><u>";
                string closeTag = "</u></link>";
                WrapSelection(openTag, closeTag, "ссылка");
            }
            modal.RemoveFromHierarchy();
            _imguiContainer.MarkDirtyRepaint();
        })
        { text = "OK" };
        AddModalButtons(modal, confirm, () => modal.RemoveFromHierarchy());
        modal.Add(new Label("Введите URL ссылки:"));
        modal.Add(textField);
        this.parent?.Add(modal);
    }

    private void OpenAlignPicker()
    {
        var modal = CreateModalBase();
        var choices = new List<string> { "left", "center", "right", "justified" };
        var dropdown = new DropdownField(choices, 0);
        var confirm = new Button(() =>
        {
            string align = choices[dropdown.index];
            WrapSelection($"<align={align}>", "</align>", "выровненный текст");
            modal.RemoveFromHierarchy();
            _imguiContainer.MarkDirtyRepaint();
        })
        { text = "OK" };
        var cancel = new Button(() => modal.RemoveFromHierarchy()) { text = "Отмена" };
        var btnRow = new VisualElement { style = { flexDirection = FlexDirection.Row, marginTop = 5 } };
        btnRow.Add(confirm);
        btnRow.Add(cancel);
        modal.Add(new Label("Выберите выравнивание:"));
        modal.Add(dropdown);
        modal.Add(btnRow);
        this.parent?.Add(modal);
    }

    private string GetSelectedOrPlaceholder(string placeholder)
    {
        string selected = _text.Substring(Math.Min(_selectionStart, _selectionEnd), Math.Abs(_selectionEnd - _selectionStart));
        if (string.IsNullOrEmpty(selected))
        {
            selected = placeholder;
            _selectionStart = _selectionEnd;
        }
        return selected;
    }

    private VisualElement CreateModalBase()
    {
        var modal = new VisualElement();
        modal.style.backgroundColor = new StyleColor(new Color(0.2f, 0.2f, 0.2f));
        modal.style.paddingTop = 10;
        modal.style.paddingBottom = 10;
        modal.style.paddingLeft = 10;
        modal.style.paddingRight = 10;
        modal.style.marginTop = 10;
        modal.style.marginBottom = 10;
        modal.style.borderTopLeftRadius = 4;
        modal.style.borderTopRightRadius = 4;
        modal.style.borderBottomLeftRadius = 4;
        modal.style.borderBottomRightRadius = 4;
        return modal;
    }

    private void AddModalButtons(VisualElement modal, Button confirm, Action onCancel)
    {
        var btnRow = new VisualElement { style = { flexDirection = FlexDirection.Row, marginTop = 5 } };
        btnRow.Add(confirm);
        btnRow.Add(new Button(() => { onCancel(); }) { text = "Отмена" });
        modal.Add(btnRow);
    }

    public void UpdateText(string newText)
    {
        _text = newText ?? "";
        _imguiContainer.MarkDirtyRepaint();
    }

    public void Close()
    {
        this.RemoveFromHierarchy();
    }

    private void ConvertToTMP()
    {
        if (string.IsNullOrEmpty(_text)) return;
        string tmpText = MarkdownToTMP.Convert(_text);
        _text = tmpText;
        _onTextChanged?.Invoke(_text);
        _imguiContainer.MarkDirtyRepaint();
    }

    private void ConvertToMarkdown()
    {
        if (string.IsNullOrEmpty(_text)) return;
        string markdown = TMPToMarkdown.Convert(_text);
        _text = markdown;
        _onTextChanged?.Invoke(_text);
        _imguiContainer.MarkDirtyRepaint();
    }
}

//==== File 16 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\TMPToMarkdown.cs ====
// Assets/Scripts/Editor/TMPToMarkdown.cs
using System.Text.RegularExpressions;

public static class TMPToMarkdown
{
    public static string Convert(string tmp)
    {
        if (string.IsNullOrEmpty(tmp))
            return tmp;

        string result = tmp;

        // �������� �������������� (������ ������� �����)
        result = Regex.Replace(result, @"<b>([^<]+)</b>", "**$1**", RegexOptions.IgnoreCase);
        result = Regex.Replace(result, @"<i>([^<]+)</i>", "*$1*", RegexOptions.IgnoreCase);
        result = Regex.Replace(result, @"<s>([^<]+)</s>", "~~$1~~", RegexOptions.IgnoreCase);
        result = Regex.Replace(result, @"<u>([^<]+)</u>", "__$1__", RegexOptions.IgnoreCase);

        return result;
    }
}

//==== File 17 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\DialogueGraphView.cs ====
using UnityEditor.Experimental.GraphView;
using System.Collections.Generic;
using UnityEngine.UIElements;
using UnityEngine;
using System.Linq;
using UnityEditor;
using System;
using UnityEditor.UIElements;

/// <summary>
/// Граф для редактирования диалогов с ограничениями на соединения узлов
/// Обеспечивает правильное подключение SpeechNode и OptionNode
/// </summary>
public class DialogueGraphView : GraphView
{
    public readonly Vector2 DefaultNodeSize = new Vector2(250, 300);
    public Blackboard Blackboard;

    public List<ExposedProperty> ExposedProperties = new List<ExposedProperty>();

    public List<IntExposedProperty> IntExposedProperties = new List<IntExposedProperty>();
    public List<StringExposedProperty> StringExposedProperties = new List<StringExposedProperty>();

    private VisualElement[] BlackboardSections;

    private EditorWindow editorWindow;
    private NodeSearchWindow searchWindow;

    public bool _hasUnsavedChangesWithoutFile = false;
    public bool _unsavedChangesWarningShown = false;

    private string _baseCharacterGuid;
    public string BaseCharacterGuid
    {
        get => _baseCharacterGuid;
        set
        {
            if (_baseCharacterGuid != value)
            {
                _baseCharacterGuid = value;
                OnBaseCharacterChanged();
            }
        }
    }

    public DialogueGraphView(EditorWindow editorWindow)
    {
        this.editorWindow = editorWindow;

        // Загружаем стили для графа
        styleSheets.Add(Resources.Load<StyleSheet>("DialogueGraph"));

        // Настраиваем масштабирование
        SetupZoom(ContentZoomer.DefaultMinScale, ContentZoomer.DefaultMaxScale);

        // Добавляем манипуляторы для перемещения и выделения
        this.AddManipulator(new ContentDragger());
        this.AddManipulator(new SelectionDragger());
        this.AddManipulator(new RectangleSelector());

        // Добавляем сетку в качестве фона
        var grid = new GridBackground();
        Insert(0, grid);
        grid.StretchToParentSize();

        // Создаем стартовый узел
        AddElement(NodeFactory.CreateEntryNode(new Vector2(100, 200)));

        // Добавляем окно поиска узлов
        AddSearchWindow();

        // Создаем черную доску для свойств
        GenerateBlackBoard();

        // Регистрируем обработчик нажатия клавиш для удаления узлов
        this.RegisterCallback<KeyDownEvent>(OnKeyDown);
    }

    /// <summary>
    /// Добавляет окно поиска узлов в граф
    /// </summary>
    private void AddSearchWindow()
    {
        searchWindow = ScriptableObject.CreateInstance<NodeSearchWindow>();
        searchWindow.Init(editorWindow, this);

        // Настраиваем создание узлов через окно поиска
        nodeCreationRequest = context =>
            SearchWindow.Open(new SearchWindowContext(context.screenMousePosition), searchWindow);
    }

    /// <summary>
    /// Обработчик нажатия клавиш для удаления узлов
    /// </summary>
    private void OnKeyDown(KeyDownEvent evt)
    {
        if (evt.keyCode == KeyCode.Delete)
        {
            // Проверяем, есть ли в выделении EntryNode
            if (selection.OfType<BaseNode>().Any(node => node.EntryPoint))
            {
                EditorUtility.DisplayDialog("Cannot Delete", "The entry point node cannot be deleted.", "OK");
                evt.StopPropagation();
                return;
            }

            // Удаляем выбранные элементы
            DeleteSelection();
            evt.StopPropagation();
        }
    }

    /// <summary>
    /// Определяет совместимые порты для соединения с учетом ограничений
    /// SpeechNode можно соединять только с OptionNode, OptionNode можно соединять только с SpeechNode
    /// </summary>
    public override List<Port> GetCompatiblePorts(Port startPort, NodeAdapter nodeAdapter)
    {
        var compatiblePorts = new List<Port>();

        // Перебираем все порты в графе
        ports.ForEach(port =>
        {
            // Пропускаем тот же порт, порт того же узла и порты с тем же направлением
            if (startPort != port &&
                startPort.node != port.node &&
                startPort.direction != port.direction)
            {
                // Проверяем ограничения на соединения узлов
                if (IsConnectionAllowed(startPort, port))
                {
                    compatiblePorts.Add(port);
                }
            }
        });

        return compatiblePorts;
    }

    /// <summary>
    /// Проверяет, разрешено ли соединение между портами
    /// SpeechNode может соединяться только с OptionNode, OptionNode может соединяться только с SpeechNode
    /// EndNode может соединяться только с OptionNode
    /// </summary>
    private bool IsConnectionAllowed(Port startPort, Port targetPort)
    {
        var startNode = startPort.node as BaseNode;
        var targetNode = targetPort.node as BaseNode;

        // Определяем типы узлов
        bool IsCondition(BaseNode n) => n is IntConditionNode or StringConditionNode;
        bool IsSpeech(BaseNode n) => n is SpeechNode;
        bool IsSpeechImage(BaseNode n) => n is SpeechNodeImage;
        bool IsOption(BaseNode n) => n is OptionNode;
        bool IsOptionImage(BaseNode n) => n is OptionNodeImage;
        bool IsModify(BaseNode n) => n is ModifyIntNode;
        bool IsEnd(BaseNode n) => n is EndNode;
        bool IsEntry(BaseNode n) => n is EntryNode;
        bool IsEvent(BaseNode n) => n is EventNode;

        // Специальная логика для EventNode на выходе
        if (startPort.direction == Direction.Output && IsEvent(startNode))
        {
            // Найти входную ноду, подключённую к EventNode.Input
            var inputPort = startNode.inputContainer.Children().OfType<Port>().FirstOrDefault();
            if (inputPort?.connections != null)
            {
                // Исправление 1: используем FirstOrDefault() вместо индексации
                var connection = inputPort.connections.FirstOrDefault();
                if (connection != null)
                {
                    var sourceNode = connection.output.node as BaseNode;
                    if (sourceNode != null)
                    {
                        // Наследуем правила от sourceNode
                        return (sourceNode, targetNode) switch
                        {
                            (SpeechNode _, _) when IsSpeech(targetNode) || IsOption(targetNode) || IsCondition(targetNode) || IsModify(targetNode) || IsEnd(targetNode) => true,
                            (SpeechNodeImage _, _) when IsSpeech(targetNode) || IsOption(targetNode) || IsCondition(targetNode) || IsModify(targetNode) || IsEnd(targetNode) => true,
                            (OptionNode _, _) when IsSpeech(targetNode) || IsCondition(targetNode) || IsModify(targetNode) || IsEnd(targetNode) => true,
                            (OptionNodeImage _, _) when IsSpeech(targetNode) || IsCondition(targetNode) || IsModify(targetNode) || IsEnd(targetNode) => true,
                            (IntConditionNode _, _) when IsSpeech(targetNode) || IsOption(targetNode) || IsModify(targetNode) || IsEnd(targetNode) => true,
                            (StringConditionNode _, _) when IsSpeech(targetNode) || IsOption(targetNode) || IsModify(targetNode) || IsEnd(targetNode) => true,
                            (ModifyIntNode _, _) when IsSpeech(targetNode) || IsOption(targetNode) || IsCondition(targetNode) || IsEnd(targetNode) => true,
                            (EntryNode _, _) when IsSpeech(targetNode) => true,
                            _ => false
                        };
                    }
                }
            }
            // Если вход не подключён — разрешаем всё (или ничего, по желанию)
            return true; // или false, если хотите запретить
        }

        // Стандартная логика для всех остальных нод
        if (startPort.direction == Direction.Output)
        {
            return (startNode, targetNode) switch
            {
                (EntryNode _, _) when IsSpeech(targetNode) => true,
                (SpeechNode _, _) when IsSpeech(targetNode) || IsOption(targetNode) || IsCondition(targetNode) || IsModify(targetNode) || IsEnd(targetNode) => true,
                (SpeechNodeImage _, _) when IsSpeech(targetNode) || IsOption(targetNode) || IsCondition(targetNode) || IsModify(targetNode) || IsEnd(targetNode) => true,
                (OptionNode _, _) when IsSpeech(targetNode) || IsCondition(targetNode) || IsModify(targetNode) || IsEnd(targetNode) => true,
                (OptionNodeImage _, _) when IsSpeech(targetNode) || IsCondition(targetNode) || IsModify(targetNode) || IsEnd(targetNode) => true,
                (IntConditionNode _, _) when IsSpeech(targetNode) || IsOption(targetNode) || IsModify(targetNode) || IsEnd(targetNode) => true,
                (StringConditionNode _, _) when IsSpeech(targetNode) || IsOption(targetNode) || IsModify(targetNode) || IsEnd(targetNode) => true,
                (ModifyIntNode _, _) when IsSpeech(targetNode) || IsOption(targetNode) || IsCondition(targetNode) || IsEnd(targetNode) => true,
                _ => false
            };
        }

        // Для input портов — зеркальная логика (или разрешить всё)
        return true;
    }

    /// <summary>
    /// Проверяет, подключен ли узел условия к SpeechNode
    /// </summary>
    private bool IsConditionNodeConnectedToSpeech(BaseConditionNode conditionNode)
    {
        if (conditionNode == null) return false;

        var inputPort = conditionNode.inputContainer.Children().FirstOrDefault() as Port;
        return inputPort != null && inputPort.connections.Any(edge =>
            edge.output.node is SpeechNode);
    }

    /// <summary>
    /// Проверяет, подключен ли узел условия к OptionNode
    /// </summary>
    private bool IsConditionNodeConnectedToOption(BaseConditionNode conditionNode)
    {
        if (conditionNode == null) return false;

        var inputPort = conditionNode.inputContainer.Children().FirstOrDefault() as Port;
        return inputPort != null && inputPort.connections.Any(edge =>
            edge.output.node is OptionNode);
    }

    /// <summary>
    /// Создает узел указанного типа в заданной позиции
    /// </summary>
    public void CreateNode(System.Type nodeType, Vector2 position)
    {
        var node = NodeFactory.CreateNode(nodeType, position);
        if (node != null)
        {
            AddElement(node);
            MarkUnsavedChangeWithoutFile();
        }
    }

    /// <summary>
    /// Создать черную доску для exposed properties с поддержкой скроллинга
    /// </summary>
    private void GenerateBlackBoard()
    {
        Blackboard = new Blackboard(this);
        Blackboard.title = "Exposed Properties";

        // Устанавливаем фиксированные размеры для Blackboard
        Blackboard.style.minWidth = 300;
        Blackboard.style.maxWidth = 400;
        Blackboard.style.minHeight = 200;
        Blackboard.style.maxHeight = 500;

        // Создаем основной скроллвью
        var scrollView = new ScrollView();
        scrollView.style.flexGrow = 1;
        scrollView.verticalScrollerVisibility = ScrollerVisibility.Auto;
        scrollView.horizontalScrollerVisibility = ScrollerVisibility.Hidden;

        // Создаем секции для разных типов свойств
        var intSection = new BlackboardSection { title = "Int Properties (0)" };
        var stringSection = new BlackboardSection { title = "String Properties (0)" };

        // Добавляем секции в скроллвью
        scrollView.Add(intSection);
        scrollView.Add(stringSection);

        // Добавляем скроллвью в Blackboard
        Blackboard.Add(scrollView);

        // Сохраняем ссылки на секции для последующего использования
        IntSection = intSection;
        StringSection = stringSection;

        // Функционал добавления новых свойств
        Blackboard.addItemRequested = blackboard =>
        {
            var menu = new GenericMenu();
            menu.AddItem(new GUIContent("Add Int Property"), false, () =>
            {
                var newProperty = new IntExposedProperty();
                IntExposedProperties.Add(newProperty);
                AddIntPropertyToBlackBoard(newProperty);
                UpdateSectionTitles();
            });
            menu.AddItem(new GUIContent("Add String Property"), false, () =>
            {
                var newProperty = new StringExposedProperty();
                StringExposedProperties.Add(newProperty);
                AddStringPropertyToBlackBoard(newProperty);
                UpdateSectionTitles();
            });
            menu.ShowAsContext();
        };

        // Функционал редактирования имен свойств
        Blackboard.editTextRequested = (blackboard, element, newValue) =>
        {
            var oldPropertyName = ((BlackboardField)element).text;

            // Проверяем уникальность имени свойства
            if (IntExposedProperties.Any(x => x.PropertyName == newValue) ||
                StringExposedProperties.Any(x => x.PropertyName == newValue))
            {
                EditorUtility.DisplayDialog("Error", "This property name already exists, please choose another one.", "OK");
                return;
            }

            // Обновляем имя в Int свойствах
            var intPropertyIndex = IntExposedProperties.FindIndex(x => x.PropertyName == oldPropertyName);
            if (intPropertyIndex >= 0)
            {
                IntExposedProperties[intPropertyIndex].PropertyName = newValue;
                ((BlackboardField)element).text = newValue;

                // Обновляем все узлы, которые используют это свойство
                RefreshAllPropertyNodes();
                return;
            }

            // Обновляем имя в String свойствах
            var stringPropertyIndex = StringExposedProperties.FindIndex(x => x.PropertyName == oldPropertyName);
            if (stringPropertyIndex >= 0)
            {
                StringExposedProperties[stringPropertyIndex].PropertyName = newValue;
                ((BlackboardField)element).text = newValue;

                // Обновляем все узлы, которые используют это свойство
                RefreshAllPropertyNodes();
            }
        };

        // Добавляем кнопку очистки всех свойств
        var clearButton = new Button(ClearAllProperties)
        {
            text = "Clear All Properties"
        };

        clearButton.style.marginTop = 5;
        clearButton.style.marginLeft = 5;
        clearButton.style.marginRight = 5;
        clearButton.style.marginBottom = 5;
        Blackboard.Add(clearButton);

        // Добавляем Blackboard в граф
        Add(Blackboard);

        // Обновляем отображение количества свойств
        UpdateSectionTitles();
    }

    // Добавьте эти поля в класс DialogueGraphView:
    private BlackboardSection IntSection;
    private BlackboardSection StringSection;

    /// <summary>
    /// Добавляет Int-свойство в Blackboard и в список IntExposedProperties
    /// </summary>
    private void AddIntPropertyToBlackBoard(IntExposedProperty intProperty)
    {
        var container = new VisualElement();
        container.style.marginBottom = 5;
        var blackboardField = new BlackboardField
        {
            text = intProperty.PropertyName,
            typeText = "Int"
        };
        // Поля для редактирования параметров свойства
        var nameField = new TextField("Name:") { value = intProperty.PropertyName };
        var minField = new IntegerField("Min:") { value = intProperty.MinValue };
        var maxField = new IntegerField("Max:") { value = intProperty.MaxValue };
        var valueField = new IntegerField("Value:") { value = intProperty.IntValue };

        // Обработчики изменений
        nameField.RegisterValueChangedCallback(evt =>
        {
            intProperty.PropertyName = evt.newValue;
            blackboardField.text = evt.newValue;
            UpdateSectionTitles();
            RefreshAllPropertyNodes();
            MarkUnsavedChangeWithoutFile(); // ← добавлено
        });
        minField.RegisterValueChangedCallback(evt =>
        {
            intProperty.MinValue = evt.newValue;
            if (intProperty.IntValue < evt.newValue)
                valueField.value = evt.newValue;
            MarkUnsavedChangeWithoutFile(); // ← добавлено
        });
        maxField.RegisterValueChangedCallback(evt =>
        {
            intProperty.MaxValue = evt.newValue;
            if (intProperty.IntValue > evt.newValue)
                valueField.value = evt.newValue;
            MarkUnsavedChangeWithoutFile(); // ← добавлено
        });
        valueField.RegisterValueChangedCallback(evt =>
        {
            intProperty.IntValue = Mathf.Clamp(evt.newValue, intProperty.MinValue, intProperty.MaxValue);
            valueField.value = intProperty.IntValue;
            MarkUnsavedChangeWithoutFile(); // ← добавлено
        });

        container.Add(blackboardField);
        container.Add(nameField);
        container.Add(minField);
        container.Add(maxField);
        container.Add(valueField);

        // Добавляем в секцию Int
        IntSection.Add(container);

        // Контекстное меню для удаления
        blackboardField.AddManipulator(new ContextualMenuManipulator(evt =>
        {
            evt.menu.AppendAction("Delete", action =>
            {
                int usageCount = 0;
                var conditionNodes = nodes.ToList().OfType<IntConditionNode>();
                var modifyNodes = nodes.ToList().OfType<ModifyIntNode>();
                foreach (var node in conditionNodes)
                    if (node.SelectedProperty == intProperty.PropertyName) usageCount++;
                foreach (var node in modifyNodes)
                    if (node.SelectedProperty == intProperty.PropertyName) usageCount++;

                if (EditorUtility.DisplayDialog("Confirm Delete",
                    $"Property '{intProperty.PropertyName}' is used in {usageCount} nodes.\nDelete anyway?",
                    "Delete", "Cancel"))
                {
                    RemoveIntProperty(intProperty, container);
                }
            });
        }));
    }

    /// <summary>
    /// Добавляет String-свойство в Blackboard и в список StringExposedProperties
    /// </summary>
    private void AddStringPropertyToBlackBoard(StringExposedProperty stringProperty)
    {
        var container = new VisualElement();
        container.style.marginBottom = 5;
        var blackboardField = new BlackboardField
        {
            text = stringProperty.PropertyName,
            typeText = "String"
        };
        var nameField = new TextField("Name:") { value = stringProperty.PropertyName };
        var valueField = new TextField("Value:") { value = stringProperty.StringValue };

        nameField.RegisterValueChangedCallback(evt =>
        {
            stringProperty.PropertyName = evt.newValue;
            blackboardField.text = evt.newValue;
            UpdateSectionTitles();
            RefreshAllPropertyNodes();
            MarkUnsavedChangeWithoutFile(); // ← добавлено
        });
        valueField.RegisterValueChangedCallback(evt =>
        {
            stringProperty.StringValue = evt.newValue;
            MarkUnsavedChangeWithoutFile(); // ← добавлено
        });

        container.Add(blackboardField);
        container.Add(nameField);
        container.Add(valueField);

        StringSection.Add(container);

        blackboardField.AddManipulator(new ContextualMenuManipulator(evt =>
        {
            evt.menu.AppendAction("Delete", action =>
            {
                int usageCount = 0;
                var conditionNodes = nodes.ToList().OfType<StringConditionNode>();
                foreach (var node in conditionNodes)
                    if (node.SelectedProperty == stringProperty.PropertyName) usageCount++;

                if (EditorUtility.DisplayDialog("Confirm Delete",
                    $"Property '{stringProperty.PropertyName}' is used in {usageCount} condition nodes.\nDelete anyway?",
                    "Delete", "Cancel"))
                {
                    RemoveStringProperty(stringProperty, container);
                }
            });
        }));
    }

    /// <summary>
    /// Удаляет Int-свойство из Blackboard и из списка
    /// </summary>
    private void RemoveIntProperty(IntExposedProperty property, VisualElement container)
    {
        IntExposedProperties.Remove(property);

        // Очищаем использование в узлах
        var conditionNodes = nodes.ToList().OfType<IntConditionNode>();
        var modifyNodes = nodes.ToList().OfType<ModifyIntNode>();
        foreach (var node in conditionNodes)
        {
            if (node.SelectedProperty == property.PropertyName)
            {
                node.SelectedProperty = "";
                Debug.LogWarning($"Variable {property.PropertyName} was removed but was used in IntConditionNode {node.GUID}");
            }
        }
        foreach (var node in modifyNodes)
        {
            if (node.SelectedProperty == property.PropertyName)
            {
                node.SelectedProperty = "";
                Debug.LogWarning($"Variable {property.PropertyName} was removed but was used in ModifyIntNode {node.GUID}");
            }
        }

        RefreshAllPropertyNodes();
        IntSection.Remove(container);
        UpdateSectionTitles();
        MarkUnsavedChangeWithoutFile(); // ← добавлено
    }

    /// <summary>
    /// Удаляет String-свойство из Blackboard и из списка
    /// </summary>
    private void RemoveStringProperty(StringExposedProperty property, VisualElement container)
    {
        StringExposedProperties.Remove(property);

        // Очищаем использование в узлах
        var conditionNodes = nodes.ToList().OfType<StringConditionNode>();
        foreach (var node in conditionNodes)
        {
            if (node.SelectedProperty == property.PropertyName)
            {
                node.SelectedProperty = "";
                Debug.LogWarning($"Variable {property.PropertyName} was removed but was used in StringConditionNode {node.GUID}");
            }
        }

        RefreshAllPropertyNodes();
        StringSection.Remove(container);
        UpdateSectionTitles();
        MarkUnsavedChangeWithoutFile(); // ← добавлено
    }

    /// <summary>
    /// Вспомогательный метод для обновления заголовков секций с количеством свойств
    /// </summary>
    private void UpdateSectionTitles()
    {
        if (IntSection != null)
        {
            IntSection.title = $"Int Properties ({IntExposedProperties.Count})";
        }

        if (StringSection != null)
        {
            StringSection.title = $"String Properties ({StringExposedProperties.Count})";
        }
    }

    /// <summary>
    /// Вспомогательный метод для обновления всех узлов, использующих свойства
    /// </summary>
    private void RefreshAllPropertyNodes()
    {
        var allPropertyNodes = nodes.ToList().OfType<IPropertyNode>();
        foreach (var node in allPropertyNodes)
        {
            node.RefreshPropertyDropdown();
        }
    }

    /// <summary>
    /// Полностью очищает все exposed properties из Blackboard
    /// </summary>
    private void ClearAllProperties()
    {
        if (!EditorUtility.DisplayDialog("Clear All Properties",
            "Are you sure you want to remove all exposed properties?", "Yes", "No"))
        {
            return;
        }

        IntExposedProperties.Clear();
        StringExposedProperties.Clear();

        IntSection?.Clear();
        StringSection?.Clear();

        RefreshAllPropertyNodes();
        UpdateSectionTitles();
        Debug.Log("All exposed properties cleared successfully");
        MarkUnsavedChangeWithoutFile(); // ← добавлено
    }

    /// <summary>
    /// Очистить черную доску и exposed properties (для совместимости со старым кодом)
    /// </summary>
    public void ClearBlackBoardAndExposedProperties()
    {
        ClearAllProperties();
    }

    /// <summary>
    /// Добавляет свойство на черную доску
    /// </summary>
    // <summary>
    /// Добавляет свойство на черную доску
    /// </summary>
    public void AddPropertyToBlackBoard(object property)
    {
        if (property is IntExposedProperty intProperty)
        {
            IntExposedProperties.Add(intProperty);

            var container = new VisualElement();
            var blackboardField = new BlackboardField
            {
                text = intProperty.PropertyName,
                typeText = "Int"
            };

            // Поля для редактирования int свойства
            var nameField = new TextField("Name:") { value = intProperty.PropertyName };
            var minField = new IntegerField("Min:") { value = intProperty.MinValue };
            var maxField = new IntegerField("Max:") { value = intProperty.MaxValue };
            var valueField = new IntegerField("Value:") { value = intProperty.IntValue };

            // Обработчики изменений
            nameField.RegisterValueChangedCallback(evt =>
            {
                intProperty.PropertyName = evt.newValue;
                blackboardField.text = evt.newValue;
            });

            minField.RegisterValueChangedCallback(evt =>
            {
                intProperty.MinValue = evt.newValue;
                if (intProperty.IntValue < evt.newValue)
                    valueField.value = evt.newValue;
            });

            maxField.RegisterValueChangedCallback(evt =>
            {
                intProperty.MaxValue = evt.newValue;
                if (intProperty.IntValue > evt.newValue)
                    valueField.value = evt.newValue;
            });

            valueField.RegisterValueChangedCallback(evt =>
            {
                intProperty.IntValue = Mathf.Clamp(evt.newValue, intProperty.MinValue, intProperty.MaxValue);
                valueField.value = intProperty.IntValue;
            });

            container.Add(blackboardField);
            container.Add(nameField);
            container.Add(minField);
            container.Add(maxField);
            container.Add(valueField);

            Blackboard[0].Add(container); // Добавляем в секцию int свойств

            blackboardField.AddManipulator(new ContextualMenuManipulator(evt =>
            {
                evt.menu.AppendAction("Delete", action =>
                {
                // Находим использование свойства
                int usageCount = 0;
                var conditionNodes = nodes.ToList().OfType<IntConditionNode>();
                var modifyNodes = nodes.ToList().OfType<ModifyIntNode>();

                foreach (var node in conditionNodes)
                {
                    if (node.SelectedProperty == intProperty.PropertyName)
                        usageCount++;
                }

                foreach (var node in modifyNodes)
                {
                    if (node.SelectedProperty == intProperty.PropertyName)
                        usageCount++;
                }

                    // Диалог подтверждения
                    if (EditorUtility.DisplayDialog("Confirm Delete",
                        $"Property '{intProperty.PropertyName}' is used in {usageCount} nodes.\nDelete anyway?",
                        "Delete", "Cancel"))
                    {
                        // Удаляем из списка
                        IntExposedProperties.Remove(intProperty);

                        // Обновляем все узлы, которые использовали это свойство
                        foreach (var node in conditionNodes)
                        {
                            if (node.SelectedProperty == intProperty.PropertyName)
                            {
                                node.SelectedProperty = "";
                                Debug.LogError($"Error: Variable {intProperty.PropertyName} was removed but is still used in IntConditionNode {node.GUID}");
                            }
                        }

                        foreach (var node in modifyNodes)
                        {
                            if (node.SelectedProperty == intProperty.PropertyName)
                            {
                                node.SelectedProperty = "";
                                Debug.LogError($"Error: Variable {intProperty.PropertyName} was removed but is still used in ModifyIntNode {node.GUID}");
                            }
                        }

                        // ОБНОВЛЯЕМ ВСЕ УЗЛЫ С ВЫПАДАЮЩИМИ СПИСКАМИ
                        var allPropertyNodes = nodes.ToList().OfType<IPropertyNode>();
                        foreach (var node in allPropertyNodes)
                        {
                            node.RefreshPropertyDropdown();
                        }

                        // Находим и удаляем визуальный элемент по имени свойства
                        var containers = Blackboard[0].Children().ToList();
                        foreach (var cont in containers)
                        {
                            var field = cont.Q<BlackboardField>();
                            if (field != null && field.text == intProperty.PropertyName)
                            {
                                Blackboard[0].Remove(cont);
                                break;
                            }
                        }
                    }
                });
            }));
        }
        else if (property is StringExposedProperty stringProperty)
        {
            StringExposedProperties.Add(stringProperty);

            var container = new VisualElement();
            var blackboardField = new BlackboardField
            {
                text = stringProperty.PropertyName,
                typeText = "String"
            };

            var nameField = new TextField("Name:") { value = stringProperty.PropertyName };
            var valueField = new TextField("Value:") { value = stringProperty.StringValue };

            nameField.RegisterValueChangedCallback(evt =>
            {
                stringProperty.PropertyName = evt.newValue;
                blackboardField.text = evt.newValue;
            });

            valueField.RegisterValueChangedCallback(evt =>
            {
                stringProperty.StringValue = evt.newValue;
            });

            container.Add(blackboardField);
            container.Add(nameField);
            container.Add(valueField);

            Blackboard[1].Add(container); // Добавляем в секцию string свойств

            // Добавляем контекстное меню для string свойств
            blackboardField.AddManipulator(new ContextualMenuManipulator(evt =>
            {
                evt.menu.AppendAction("Delete", action =>
                {
                    // Находим использование свойства
                    int usageCount = 0;
                    var conditionNodes = nodes.ToList().OfType<StringConditionNode>();
                    foreach (var node in conditionNodes)
                    {
                        if (node.SelectedProperty == stringProperty.PropertyName)
                            usageCount++;
                    }

                    // Диалог подтверждения
                    if (EditorUtility.DisplayDialog("Confirm Delete",
                        $"Property '{stringProperty.PropertyName}' is used in {usageCount} condition nodes.\nDelete anyway?",
                        "Delete", "Cancel"))
                    {
                        // Удаляем из списка
                        StringExposedProperties.Remove(stringProperty);

                        // Обновляем все узлы, которые использовали это свойство
                        foreach (var node in nodes.ToList().OfType<StringConditionNode>())
                        {
                            if (node.SelectedProperty == stringProperty.PropertyName)
                            {
                                node.SelectedProperty = "";
                                Debug.LogError($"Error: Variable {stringProperty.PropertyName} was removed but is still used in StringConditionNode {node.GUID}");
                            }
                        }

                        // ОБНОВЛЯЕМ ВСЕ УЗЛЫ С ВЫПАДАЮЩИМИ СПИСКАМИ
                        var allPropertyNodes = nodes.ToList().OfType<IPropertyNode>();
                        foreach (var node in allPropertyNodes)
                        {
                            node.RefreshPropertyDropdown();
                        }

                        // Находим и удаляем визуальный элемент по имени свойства
                        var containers = Blackboard[1].Children().ToList();
                        foreach (var cont in containers)
                        {
                            var field = cont.Q<BlackboardField>();
                            if (field != null && field.text == stringProperty.PropertyName)
                            {
                                Blackboard[1].Remove(cont);
                                break;
                            }
                        }
                    }
                });
            }));
        }
    }

    /// <summary>
    /// Удаляет выбранные элементы из графа
    /// </summary>
    private void DeleteSelection()
    {
        var selectionCopy = selection.ToList();
        bool hadChange = false;
        foreach (var selectedElement in selectionCopy)
        {
            if (selectedElement is BaseNode node)
            {
                // Используем this.edges, а не Edges
                var edgesToRemove = this.edges
                    .Where(e => e.input.node == node || e.output.node == node)
                    .ToList(); // ← ToList() делает его IList
                foreach (var edge in edgesToRemove)
                {
                    RemoveElement(edge);
                }
                RemoveElement(node);
                hadChange = true;
            }
            else if (selectedElement is Edge edge)
            {
                RemoveElement(edge);
                hadChange = true;
            }
        }
        if (hadChange)
            MarkUnsavedChangeWithoutFile();
    }

    // Метод для обработки изменений базового персонажа
    private void OnBaseCharacterChanged()
    {
        // Можно добавить дополнительную логику при изменении базового персонажа
        Debug.Log($"Base character changed to: {BaseCharacterGuid}");
    }

    /// <summary>
    /// Публичный метод для полной очистки графа (кроме EntryNode)
    /// </summary>
    private void ClearGraph()
    {
        // Удаляем все узлы, кроме EntryPoint
        var nodesToRemove = this.nodes.ToList().Where(node => !(node is EntryNode)).ToList();
        foreach (var node in nodesToRemove)
        {
            // Удаляем связанные рёбра
            var edgesToRemove = this.edges
                .Where(e => e.input.node == node || e.output.node == node)
                .ToList();
            foreach (var edge in edgesToRemove)
                RemoveElement(edge);

            RemoveElement(node);
        }
        // Очищаем Blackboard и exposed properties
        ClearBlackBoardAndExposedProperties();
        // Сбрасываем BaseCharacterGuid
        BaseCharacterGuid = string.Empty;
    }

    /// <summary>
    /// Отмечает, что были внесены изменения без привязки к файлу.
    /// Вызывается при добавлении/удалении узлов, связей, изменении Blackboard или Base Character.
    /// </summary>
    public void MarkUnsavedChangeWithoutFile()
    {
        var assetField = this.parent?.parent?.Q<ObjectField>("Dialogue File");
        if (assetField?.value == null)
        {
            _hasUnsavedChangesWithoutFile = true;
            if (!_unsavedChangesWarningShown)
            {
                _unsavedChangesWarningShown = true;
                Debug.LogWarning("Диалог не был выбран");
            }
        }
        else
        {
            // Если файл уже выбран, сбрасываем флаг
            _hasUnsavedChangesWithoutFile = false;
            _unsavedChangesWarningShown = false;
        }
    }
}

//==== File 18 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\DialogueNode.cs ====
using UnityEditor.Experimental.GraphView;
using UnityEngine.UIElements;
using UnityEngine;

public class DialogueNode : BaseNode
{
    public string DialogueText { get; set; }
    private TextField textField;

    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Dialogue Node";
        DialogueText = "New Dialogue";

        // ��������� ������� ����
        var inputPort = InstantiatePort(Orientation.Horizontal, Direction.Input, Port.Capacity.Multi, typeof(float));
        inputPort.portName = "Input";
        inputContainer.Add(inputPort);

        // ��������� �������� ����
        var outputPort = InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
        outputPort.portName = "Next";
        outputContainer.Add(outputPort);

        // ��������� ���� ��� �������
        textField = new TextField(string.Empty);
        textField.multiline = true;
        textField.RegisterValueChangedCallback(evt =>
        {
            DialogueText = evt.newValue;
            title = DialogueText.Length > 15 ? DialogueText.Substring(0, 15) + "..." : DialogueText;
        });
        textField.SetValueWithoutNotify(DialogueText);
        mainContainer.Add(textField);

        RefreshExpandedState();
        RefreshPorts();
    }
}


//==== File 19 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\NodeSearchWindow.cs ====
using UnityEditor.Experimental.GraphView;
using System.Collections.Generic;
using UnityEngine.UIElements;
using UnityEditor;
using UnityEngine;
using System;
using System.Linq;

/// <summary>
/// ���� ������ ����� ��� ����������� �����
/// ��������� ��������� ����� ���� ����� �����
/// </summary>
public class NodeSearchWindow : ScriptableObject, ISearchWindowProvider
{
    private DialogueGraphView graphView;
    private EditorWindow editorWindow;
    private Texture2D indentationIcon;

    /// <summary>
    /// ������������� ���� ������
    /// </summary>
    public void Init(EditorWindow editorWindow, DialogueGraphView graphView)
    {
        this.graphView = graphView;
        this.editorWindow = editorWindow;

        // ������� ���������� ������ ��� ��������
        indentationIcon = new Texture2D(1, 1);
        indentationIcon.SetPixel(0, 0, new Color(0, 0, 0, 0));
        indentationIcon.Apply();
    }

    /// <summary>
    /// ������� ������ ��������� ��� ������
    /// </summary>
    public List<SearchTreeEntry> CreateSearchTree(SearchWindowContext context)
    {
        return new List<SearchTreeEntry>
    {
        new SearchTreeGroupEntry(new GUIContent("Create Node"), 0),
        new SearchTreeGroupEntry(new GUIContent("Dialogue Nodes"), 1),
        new SearchTreeGroupEntry(new GUIContent("Speech Nodes"), 2),
        new SearchTreeEntry(new GUIContent("Speech (Text)", indentationIcon)) { userData = typeof(SpeechNodeText), level = 3 },
        new SearchTreeEntry(new GUIContent("Speech (Audio)", indentationIcon)) { userData = typeof(SpeechNodeAudio), level = 3 },
        new SearchTreeEntry(new GUIContent("Speech (Image)", indentationIcon)) { userData = typeof(SpeechNodeImage), level = 3 },
        new SearchTreeGroupEntry(new GUIContent("Option Nodes"), 2),
        new SearchTreeEntry(new GUIContent("Option (Text)", indentationIcon)) { userData = typeof(OptionNodeText), level = 3 },
        new SearchTreeEntry(new GUIContent("Option (Audio)", indentationIcon)) { userData = typeof(OptionNodeAudio), level = 3 },
        new SearchTreeEntry(new GUIContent("Option (Image)", indentationIcon)) { userData = typeof(OptionNodeImage), level = 3 },
        new SearchTreeGroupEntry(new GUIContent("Condition Nodes"), 1),
        new SearchTreeEntry(new GUIContent("Condition (Int)", indentationIcon)) { userData = typeof(IntConditionNode), level = 2 },
        new SearchTreeEntry(new GUIContent("Condition (String)", indentationIcon)) { userData = typeof(StringConditionNode), level = 2 },
        new SearchTreeGroupEntry(new GUIContent("Utility Nodes"), 1),
        new SearchTreeEntry(new GUIContent("Entry Node", indentationIcon)) { userData = typeof(EntryNode), level = 2 },
        new SearchTreeEntry(new GUIContent("End Node", indentationIcon)) { userData = typeof(EndNode), level = 2 },
        new SearchTreeGroupEntry(new GUIContent("Action Nodes"), 1),
        new SearchTreeEntry(new GUIContent("Modify Int", indentationIcon)) { userData = typeof(ModifyIntNode), level = 2 },
        new SearchTreeEntry(new GUIContent("Event", indentationIcon)) { userData = typeof(EventNode), level = 2 },
        new SearchTreeEntry(new GUIContent("Character Condition (Int)", indentationIcon)) { userData = typeof(CharacterIntConditionNode), level = 2 },
        new SearchTreeEntry(new GUIContent("Character Modify Int", indentationIcon)) { userData = typeof(CharacterModifyIntNode), level = 2 },
    };
    }

    /// <summary>
    /// ������������ ����� �������� � ���� ������
    /// </summary>
    public bool OnSelectEntry(SearchTreeEntry searchTreeEntry, SearchWindowContext context)
    {
        // ������������ ���������� ���� � ��������� ���������� �����
        var worldMousePosition = editorWindow.rootVisualElement.ChangeCoordinatesTo(
            editorWindow.rootVisualElement.parent,
            context.screenMousePosition - editorWindow.position.position
        );

        var localMousePosition = graphView.contentViewContainer.WorldToLocal(worldMousePosition);

        // ������� ���� ���������� ����
        if (searchTreeEntry.userData is Type nodeType)
        {
            // Проверка на попытку создания второго EntryNode
            if (nodeType == typeof(EntryNode))
            {
                var existingEntryNodes = graphView.nodes.ToList().Where(node => node is EntryNode);
                if (existingEntryNodes.Any())
                {
                    EditorUtility.DisplayDialog("Cannot Create Start Node",
                        "Only one Start Node is allowed in the graph.", "OK");
                    return false;
                }
            }

            graphView.CreateNode(nodeType, localMousePosition);
            return true;
        }

        return false;
    }
}

//==== File 20 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\Characters\CharacterData.cs ====
using UnityEngine;
using System.Collections.Generic;

[CreateAssetMenu(fileName = "NewCharacter", menuName = "Dialogue System/Character Data")]
public class CharacterData : ScriptableObject
{
    [Header("Basic Info")]
    public string FirstName = "New";
    public string LastName = "Character";
    public Sprite Icon;
    [TextArea(3, 10)] public string Description = "";
    public Color NameColor = Color.white;

    [Header("Variables")]
    public List<CharacterVariable> Variables = new List<CharacterVariable>();

    public void AddVariable(string variableName = "NewVariable", int initialValue = 0)
    {
        Variables.Add(new CharacterVariable(variableName, initialValue));
    }

    public void RemoveVariable(int index)
    {
        if (index >= 0 && index < Variables.Count)
            Variables.RemoveAt(index);
    }

    public bool TryGetVariable(string variableName, out CharacterVariable variable)
    {
        variable = Variables.Find(v => v.VariableName == variableName);
        return variable != null;
    }
}

[System.Serializable]
public class CharacterVariable
{
    public string VariableName = "NewVariable";
    public int Value = 0;

    public CharacterVariable(string name, int value)
    {
        VariableName = name;
        Value = value;
    }
}

//==== File 21 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Characters\CharacterEditorWindow.cs ====
using UnityEditor;
using UnityEngine;
using System.Collections.Generic;
using System.Linq;

public class CharacterEditorWindow : EditorWindow
{
    private List<CharacterData> characters = new List<CharacterData>();
    private CharacterData selectedCharacter;
    private Vector2 scrollPosition;
    private string searchString = "";

    // ��������� ���������� ��� ���������
    private Vector2 characterListScrollPosition;
    private Vector2 variablesScrollPosition;
    private int variableToRemove = -1;

    [MenuItem("Dialog System/Character Editor")]
    public static void ShowWindow()
    {
        GetWindow<CharacterEditorWindow>("Character Editor");
    }

    private void OnEnable()
    {
        RefreshCharacterList();
    }

    private void OnGUI()
    {
        DrawToolbar();

        EditorGUILayout.BeginHorizontal();
        DrawCharacterList();
        DrawCharacterDetails();
        EditorGUILayout.EndHorizontal();

        // ������������ �������� ���������� ����� ��������� GUI
        if (variableToRemove != -1)
        {
            selectedCharacter.RemoveVariable(variableToRemove);
            variableToRemove = -1;
            GUIUtility.ExitGUI(); // ������� �� �������� GUI �����
        }
    }

    private void DrawToolbar()
    {
        EditorGUILayout.BeginHorizontal(EditorStyles.toolbar);

        if (GUILayout.Button("Create New", EditorStyles.toolbarButton))
        {
            CreateNewCharacter();
        }

        if (GUILayout.Button("Save", EditorStyles.toolbarButton) && selectedCharacter != null)
        {
            SaveCharacter();
        }

        if (GUILayout.Button("Delete", EditorStyles.toolbarButton) && selectedCharacter != null)
        {
            DeleteCharacter();
        }

        GUILayout.FlexibleSpace();

        searchString = EditorGUILayout.TextField(searchString, EditorStyles.toolbarSearchField, GUILayout.Width(200));

        EditorGUILayout.EndHorizontal();
    }

    private void DrawCharacterList()
    {
        EditorGUILayout.BeginVertical(GUILayout.Width(250));
        EditorGUILayout.LabelField("Characters", EditorStyles.boldLabel);

        // ��������� ��������� ��� ������ ����������
        characterListScrollPosition = EditorGUILayout.BeginScrollView(characterListScrollPosition, GUILayout.ExpandHeight(true));

        var filteredCharacters = string.IsNullOrEmpty(searchString)
            ? characters
            : characters.Where(c => c.name.ToLower().Contains(searchString.ToLower())).ToList();

        foreach (var character in filteredCharacters)
        {
            var isSelected = selectedCharacter == character;
            if (GUILayout.Toggle(isSelected, character.name, EditorStyles.toolbarButton) && !isSelected)
            {
                selectedCharacter = character;
            }
        }

        EditorGUILayout.EndScrollView();
        EditorGUILayout.EndVertical();
    }

    private void DrawCharacterDetails()
    {
        EditorGUILayout.BeginVertical(GUILayout.ExpandWidth(true));

        if (selectedCharacter == null)
        {
            EditorGUILayout.HelpBox("Select a character or create a new one", UnityEditor.MessageType.Info);
            EditorGUILayout.EndVertical();
            return;
        }

        EditorGUI.BeginChangeCheck();

        // Basic Info
        EditorGUILayout.LabelField("Basic Information", EditorStyles.boldLabel);
        selectedCharacter.FirstName = EditorGUILayout.TextField("First Name", selectedCharacter.FirstName);
        selectedCharacter.LastName = EditorGUILayout.TextField("Last Name", selectedCharacter.LastName);
        selectedCharacter.Icon = (Sprite)EditorGUILayout.ObjectField("Icon", selectedCharacter.Icon, typeof(Sprite), false);
        selectedCharacter.Description = EditorGUILayout.TextArea(selectedCharacter.Description, GUILayout.Height(60));
        selectedCharacter.NameColor = EditorGUILayout.ColorField("Name Color", selectedCharacter.NameColor);

        EditorGUILayout.Space();

        // Variables
        EditorGUILayout.LabelField("Variables", EditorStyles.boldLabel);

        // ��������� ��������� ��� ������ ����������
        variablesScrollPosition = EditorGUILayout.BeginScrollView(variablesScrollPosition, GUILayout.Height(200));

        for (int i = 0; i < selectedCharacter.Variables.Count; i++)
        {
            EditorGUILayout.BeginHorizontal();

            selectedCharacter.Variables[i].VariableName = EditorGUILayout.TextField(
                GUIContent.none,
                selectedCharacter.Variables[i].VariableName);

            selectedCharacter.Variables[i].Value = EditorGUILayout.IntField(
                GUIContent.none,
                selectedCharacter.Variables[i].Value);

            if (GUILayout.Button("X", GUILayout.Width(20)))
            {
                // ���������� ������ ��� ��������, �� ������� ����� ��������� GUI
                variableToRemove = i;
            }

            EditorGUILayout.EndHorizontal();
        }

        EditorGUILayout.EndScrollView();

        if (GUILayout.Button("Add Variable"))
        {
            selectedCharacter.AddVariable();
        }

        if (EditorGUI.EndChangeCheck())
        {
            EditorUtility.SetDirty(selectedCharacter);
        }

        EditorGUILayout.EndVertical();
    }

    private void CreateNewCharacter()
    {
        var newCharacter = CreateInstance<CharacterData>();
        newCharacter.name = "NewCharacter";

        var path = EditorUtility.SaveFilePanelInProject(
            "Create Character",
            "NewCharacter",
            "asset",
            "Please enter a file name to save the character");

        if (!string.IsNullOrEmpty(path))
        {
            AssetDatabase.CreateAsset(newCharacter, path);
            AssetDatabase.SaveAssets();
            RefreshCharacterList();
            selectedCharacter = newCharacter;
        }
    }

    private void SaveCharacter()
    {
        EditorUtility.SetDirty(selectedCharacter);
        AssetDatabase.SaveAssets();
        Debug.Log($"Character {selectedCharacter.name} saved successfully");
    }

    private void DeleteCharacter()
    {
        if (EditorUtility.DisplayDialog(
            "Delete Character",
            $"Are you sure you want to delete {selectedCharacter.name}?",
            "Delete",
            "Cancel"))
        {
            var path = AssetDatabase.GetAssetPath(selectedCharacter);
            AssetDatabase.DeleteAsset(path);
            RefreshCharacterList();
            selectedCharacter = null;
        }
    }

    private void RefreshCharacterList()
    {
        characters.Clear();
        var guids = AssetDatabase.FindAssets("t:CharacterData");

        foreach (var guid in guids)
        {
            var path = AssetDatabase.GUIDToAssetPath(guid);
            var character = AssetDatabase.LoadAssetAtPath<CharacterData>(path);
            if (character != null)
                characters.Add(character);
        }
    }
}

//==== File 22 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\CharacterIntConditionNode.cs ====
using System.Collections.Generic;
using UnityEngine.UIElements;
using System.Linq;
using UnityEngine;
using DialogueSystem;
using UnityEditor;

public class CharacterIntConditionNode : BaseConditionNode
{
    public string CharacterName = "";
    public string SelectedVariable = "";
    public ComparisonType Comparison;
    public int CompareValue;

    private TextField characterNameField;
    private DropdownField variableDropdown;
    private DropdownField comparisonDropdown;
    private IntegerField valueField;

    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Character Condition (Int)";

        characterNameField = new TextField("Character Name");
        characterNameField.RegisterValueChangedCallback(evt =>
        {
            CharacterName = evt.newValue;
            RefreshVariableDropdown();
        });
        mainContainer.Add(characterNameField);

        variableDropdown = new DropdownField("Variable") { choices = new List<string>() };
        variableDropdown.RegisterValueChangedCallback(evt => SelectedVariable = evt.newValue);
        mainContainer.Add(variableDropdown);

        comparisonDropdown = new DropdownField(System.Enum.GetNames(typeof(ComparisonType)).ToList(), "Comparison");
        comparisonDropdown.RegisterValueChangedCallback(evt =>
            Comparison = (ComparisonType)System.Enum.Parse(typeof(ComparisonType), evt.newValue));
        mainContainer.Add(comparisonDropdown);

        valueField = new IntegerField("Value");
        valueField.RegisterValueChangedCallback(evt => CompareValue = evt.newValue);
        mainContainer.Add(valueField);

        RefreshExpandedState();
        RefreshPorts();
    }

    public void SetInitialData(string characterName, string variable, ComparisonType comp, int value)
    {
        CharacterName = characterName;
        SelectedVariable = variable;
        Comparison = comp;
        CompareValue = value;
    }

    public void UpdateUIFromData()
    {
        characterNameField?.SetValueWithoutNotify(CharacterName);
        RefreshVariableDropdown();
        variableDropdown?.SetValueWithoutNotify(SelectedVariable);
        comparisonDropdown?.SetValueWithoutNotify(Comparison.ToString());
        valueField.value = CompareValue;
    }

    private void RefreshVariableDropdown()
    {
        var choices = new List<string>();
        if (!string.IsNullOrEmpty(CharacterName))
        {
#if UNITY_EDITOR
            string[] guids = UnityEditor.AssetDatabase.FindAssets($"t:CharacterData {CharacterName}");
            if (guids.Length > 0)
            {
                string path = UnityEditor.AssetDatabase.GUIDToAssetPath(guids[0]);
                var charData = UnityEditor.AssetDatabase.LoadAssetAtPath<CharacterData>(path);
                if (charData != null)
                    choices = charData.Variables.Select(v => v.VariableName).ToList();
            }
#endif
        }
        variableDropdown.choices = choices;
        if (!string.IsNullOrEmpty(SelectedVariable) && choices.Contains(SelectedVariable))
            variableDropdown.value = SelectedVariable;
        else if (choices.Count > 0)
            variableDropdown.value = choices[0];
    }
}

//==== File 23 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\CharacterModifyIntNode.cs ====
using UnityEditor.Experimental.GraphView;
using System.Collections.Generic;
using UnityEngine.UIElements;
using DialogueSystem;
using System.Linq;
using UnityEngine;
using UnityEditor;

public class CharacterModifyIntNode : BaseNode
{
    public string CharacterName = "";
    public string SelectedVariable = "";
    public OperatorType Operator;
    public int Value;

    private TextField characterNameField;
    private DropdownField variableDropdown;
    private DropdownField operatorDropdown;
    private IntegerField valueField;

    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Character Modify Int";

        var inputPort = InstantiatePort(Orientation.Horizontal, Direction.Input, Port.Capacity.Single, typeof(float));
        inputPort.portName = "Input";
        inputContainer.Add(inputPort);

        var outputPort = InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
        outputPort.portName = "Output";
        outputContainer.Add(outputPort);

        characterNameField = new TextField("Character Name");
        characterNameField.RegisterValueChangedCallback(evt =>
        {
            CharacterName = evt.newValue;
            RefreshVariableDropdown();
        });
        mainContainer.Add(characterNameField);

        variableDropdown = new DropdownField("Variable") { choices = new List<string>() };
        variableDropdown.RegisterValueChangedCallback(evt => SelectedVariable = evt.newValue);
        mainContainer.Add(variableDropdown);

        operatorDropdown = new DropdownField("Operator", System.Enum.GetNames(typeof(OperatorType)).ToList());
        operatorDropdown.RegisterValueChangedCallback(evt =>
        {
            Operator = (OperatorType)System.Enum.Parse(typeof(OperatorType), evt.newValue);
            UpdateValueFieldVisibility();
        });
        mainContainer.Add(operatorDropdown);

        valueField = new IntegerField("Value");
        valueField.RegisterValueChangedCallback(evt => Value = evt.newValue);
        mainContainer.Add(valueField);

        UpdateValueFieldVisibility();
        RefreshExpandedState();
        RefreshPorts();
    }

    private void UpdateValueFieldVisibility()
    {
        valueField.style.display = (Operator == OperatorType.Increment || Operator == OperatorType.Decrement)
            ? DisplayStyle.None : DisplayStyle.Flex;
    }

    public void UpdateUIFromData()
    {
        characterNameField?.SetValueWithoutNotify(CharacterName);
        RefreshVariableDropdown();
        variableDropdown?.SetValueWithoutNotify(SelectedVariable);
        operatorDropdown?.SetValueWithoutNotify(Operator.ToString());
        valueField.value = Value;
    }

    private void RefreshVariableDropdown()
    {
        var choices = new List<string>();
        if (!string.IsNullOrEmpty(CharacterName))
        {
#if UNITY_EDITOR
            string[] guids = UnityEditor.AssetDatabase.FindAssets($"t:CharacterData {CharacterName}");
            if (guids.Length > 0)
            {
                string path = UnityEditor.AssetDatabase.GUIDToAssetPath(guids[0]);
                var charData = UnityEditor.AssetDatabase.LoadAssetAtPath<CharacterData>(path);
                if (charData != null)
                    choices = charData.Variables.Select(v => v.VariableName).ToList();
            }
#endif
        }
        variableDropdown.choices = choices;
        if (!string.IsNullOrEmpty(SelectedVariable) && choices.Contains(SelectedVariable))
            variableDropdown.value = SelectedVariable;
        else if (choices.Count > 0)
            variableDropdown.value = choices[0];
    }
}

//==== File 24 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\EndNode.cs ====
using UnityEditor.Experimental.GraphView;
using UnityEngine.UIElements;
using UnityEditor.Search;
using UnityEngine;
using UnityEditor;

public class EndNode : BaseNode
{
    // ��������� ���� ��� drag-and-drop � ���������
    public DialogueContainer NextDialogueAsset { get; set; }

    private ObjectField nextDialogueField;

    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "End Node";

        // Input port
        var inputPort = InstantiatePort(Orientation.Horizontal, Direction.Input, Port.Capacity.Multi, typeof(float));
        inputPort.portName = "Input";
        inputContainer.Add(inputPort);

        // ObjectField ��� drag-and-drop
        nextDialogueField = new ObjectField("Next Dialogue")
        {
            objectType = typeof(DialogueContainer)
            // allowSceneObjects ���������� � UI Toolkit � �������
        };
        nextDialogueField.RegisterValueChangedCallback(evt =>
        {
            NextDialogueAsset = evt.newValue as DialogueContainer;
        });
        mainContainer.Add(nextDialogueField);

        RefreshExpandedState();
        RefreshPorts();
        styleSheets.Add(Resources.Load<StyleSheet>("EndNode"));
    }

    /// <summary>
    /// �������� ���� ������������ ����� Resources (��� .asset), ��� ������ ������, ���� �� � Resources.
    /// </summary>
    public string GetNextDialoguePath()
    {
        if (NextDialogueAsset == null)
            return string.Empty;

        string assetPath = AssetDatabase.GetAssetPath(NextDialogueAsset);
        if (string.IsNullOrEmpty(assetPath))
            return string.Empty;

        // ���������, ����� �� ���� ������ Assets/Resources/
        if (!assetPath.StartsWith("Assets/Resources/"))
        {
            Debug.LogWarning($"Dialogue asset '{NextDialogueAsset.name}' is not in Resources folder. It will not be loadable at runtime via Resources.Load.", NextDialogueAsset);
            return string.Empty; // ���������� ������ ������, ����� �� ������ �������
        }

        // ������� "Assets/Resources/" � ".asset"
        string relativePath = assetPath.Substring("Assets/Resources/".Length);
        if (relativePath.EndsWith(".asset"))
            relativePath = relativePath.Substring(0, relativePath.Length - 6);
        return relativePath;
    }

    /// <summary>
    /// ������������� ������ �� ������ �� ���� (������������ ��� ��������)
    /// </summary>
    public void SetNextDialogueFromPath(string path)
    {
        if (string.IsNullOrEmpty(path))
        {
            NextDialogueAsset = null;
            nextDialogueField?.SetValueWithoutNotify(null);
            return;
        }

        // ���� � Resources
        var asset = Resources.Load<DialogueContainer>(path);
        if (asset != null)
        {
            NextDialogueAsset = asset;
            nextDialogueField?.SetValueWithoutNotify(asset);
            return;
        }

        // ���� �� ������ � ���� ����� AssetDatabase (��� ���������)
        string fullPath = $"Assets/Resources/{path}.asset";
        var assetAtPath = AssetDatabase.LoadAssetAtPath<DialogueContainer>(fullPath);
        if (assetAtPath != null)
        {
            NextDialogueAsset = assetAtPath;
            nextDialogueField?.SetValueWithoutNotify(assetAtPath);
        }
        else
        {
            NextDialogueAsset = null;
            nextDialogueField?.SetValueWithoutNotify(null);
            Debug.LogWarning($"Could not restore DialogueContainer for path: {path}");
        }
    }
}

//==== File 25 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\EntryNode.cs ====
using UnityEditor.Experimental.GraphView;
using UnityEngine;
using UnityEngine.UIElements;

/// <summary>
/// ��������� ���� - ����� ����� � ���������� ����
/// �� ����� ���� ������ ��� ���������
/// </summary>
public class EntryNode : BaseNode
{
    /// <summary>
    /// ������������� ���������� ����
    /// </summary>
    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "START";
        EntryPoint = true;

        // ������� �������� ����
        var outputPort = InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
        outputPort.portName = "Next";
        outputContainer.Add(outputPort);

        // ��������� �������� � �����������
        capabilities &= ~Capabilities.Movable;
        capabilities &= ~Capabilities.Deletable;

        // ��������� ���������� ��������� ����
        RefreshExpandedState();
        RefreshPorts();

        // ��������� ����������� ����� ��� ���������� ����
        styleSheets.Add(Resources.Load<StyleSheet>("DefNode"));
    }
}

//==== File 26 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\EventNode.cs ====
// Assets/Scripts/Editor/DialogueGraph/Nodes/EventNode.cs
using UnityEditor;
using UnityEditor.Experimental.GraphView;
using UnityEngine;
using UnityEngine.Events;
using UnityEngine.UIElements;

public class EventNode : BaseNode
{
    public UnityEvent RuntimeEvent = new UnityEvent();

    private VisualElement _eventContainer;
    private EventNodeHelperSO _helperSO;

    public EventNode()
    {
        this.RegisterCallback<DetachFromPanelEvent>(OnDetachedFromPanel);
    }

    private void OnDetachedFromPanel(DetachFromPanelEvent evt)
    {
        if (_helperSO != null)
        {
            UnityEngine.Object.DestroyImmediate(_helperSO);
            _helperSO = null;
        }
    }

    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Event Node";

        // Input
        var inputPort = InstantiatePort(Orientation.Horizontal, Direction.Input, Port.Capacity.Multi, typeof(float));
        inputPort.portName = "Input";
        inputContainer.Add(inputPort);

        // Output
        var outputPort = InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
        outputPort.portName = "Next";
        outputContainer.Add(outputPort);

        // Создаём временный ScriptableObject для редактирования
        _helperSO = ScriptableObject.CreateInstance<EventNodeHelperSO>();
        _helperSO.Event = RuntimeEvent;

        _eventContainer = new IMGUIContainer(() =>
        {
            var so = new SerializedObject(_helperSO);
            var prop = so.FindProperty("Event");
            EditorGUILayout.PropertyField(prop, true);
            so.ApplyModifiedProperties();

            // Синхронизируем обратно в RuntimeEvent
            RuntimeEvent = _helperSO.Event;
        });

        mainContainer.Add(_eventContainer);

        RefreshExpandedState();
        RefreshPorts();
    }
}

//==== File 27 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\IntConditionNode.cs ====
using System.Collections.Generic;
using UnityEngine.UIElements;
using System.Linq;
using UnityEngine;
using DialogueSystem;

public class IntConditionNode : BaseConditionNode, IPropertyNode
{
    public string SelectedProperty;
    public ComparisonType Comparison;
    public int CompareValue;

    private DropdownField propertyDropdown;
    private DropdownField comparisonDropdown;
    private IntegerField valueField;

    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Condition (Int)";

        // Property dropdown
        propertyDropdown = new DropdownField("Property");
        propertyDropdown.choices = new List<string>();
        propertyDropdown.RegisterValueChangedCallback(evt =>
        {
            SelectedProperty = evt.newValue;
        });
        mainContainer.Add(propertyDropdown);

        // Comparison dropdown
        comparisonDropdown = new DropdownField("Comparison");
        comparisonDropdown.choices = System.Enum.GetNames(typeof(ComparisonType)).ToList();
        comparisonDropdown.RegisterValueChangedCallback(evt =>
        {
            Comparison = (ComparisonType)System.Enum.Parse(typeof(ComparisonType), evt.newValue);
        });
        mainContainer.Add(comparisonDropdown);

        // Value field
        valueField = new IntegerField("Value");
        valueField.RegisterValueChangedCallback(evt => CompareValue = evt.newValue);
        mainContainer.Add(valueField);

        // �������� ������� ��� ���������� � ������
        this.RegisterCallback<AttachToPanelEvent>(OnAttachToPanel);
    }

    private void OnAttachToPanel(AttachToPanelEvent evt)
    {
        // ������ ���� �������� � ���� � ����� �������� ������ � DialogueGraphView
        RefreshPropertyDropdown();
        this.UnregisterCallback<AttachToPanelEvent>(OnAttachToPanel);
    }
    public void SetInitialData(string property, ComparisonType comparison, int value)
    {
        SelectedProperty = property;
        Comparison = comparison;
        CompareValue = value;
    }
    public void RefreshPropertyDropdown()
    {
        // �������� �������� �� �����
        var graphView = GetFirstAncestorOfType<DialogueGraphView>();
        if (graphView != null && propertyDropdown != null)
        {
            propertyDropdown.choices = graphView.IntExposedProperties
                .Where(p => p != null)
                .Select(p => p.PropertyName)
                .ToList();

            // ���� ���� ��������, �������� ������ �� ���������
            if (propertyDropdown.choices.Count > 0 && string.IsNullOrEmpty(SelectedProperty))
            {
                propertyDropdown.value = propertyDropdown.choices[0];
                SelectedProperty = propertyDropdown.choices[0];
            }
            else if (!string.IsNullOrEmpty(SelectedProperty))
            {
                propertyDropdown.value = SelectedProperty;
            }
        }
    }

    /// <summary>
    /// ��������� UI-�������� �� ������ ������� �������� �����.
    /// �������� ����� �������� ������ � ���������� ���� � ����.
    /// </summary>
    public void UpdateUIFromData()
    {
        if (propertyDropdown != null && comparisonDropdown != null && valueField != null)
        {
            propertyDropdown.value = SelectedProperty;
            comparisonDropdown.value = Comparison.ToString();
            valueField.value = CompareValue;
        }
    }
}

//==== File 28 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\ModifyIntNode.cs ====
using UnityEditor.Experimental.GraphView;
using UnityEngine.UIElements;
using DialogueSystem;
using UnityEngine;
using System.Collections.Generic;
using System.Linq;

public class ModifyIntNode : BaseNode, IPropertyNode
{
    public string SelectedProperty;
    public OperatorType Operator;
    public int Value;

    private DropdownField propertyDropdown;
    private DropdownField operatorDropdown;
    private IntegerField valueField;

    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Modify Int";

        // Input port
        var inputPort = InstantiatePort(Orientation.Horizontal, Direction.Input, Port.Capacity.Single, typeof(float));
        inputPort.portName = "Input";
        inputContainer.Add(inputPort);

        // Output port
        var outputPort = InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
        outputPort.portName = "Output";
        outputContainer.Add(outputPort);

        // Property dropdown
        propertyDropdown = new DropdownField("Property");
        propertyDropdown.choices = new List<string>();
        propertyDropdown.RegisterValueChangedCallback(evt =>
        {
            SelectedProperty = evt.newValue;
        });
        mainContainer.Add(propertyDropdown);

        // Operator dropdown
        operatorDropdown = new DropdownField("Operator");
        operatorDropdown.choices = System.Enum.GetNames(typeof(OperatorType)).ToList();
        operatorDropdown.RegisterValueChangedCallback(evt =>
        {
            Operator = (OperatorType)System.Enum.Parse(typeof(OperatorType), evt.newValue);
            UpdateValueFieldVisibility();
        });
        mainContainer.Add(operatorDropdown);

        // Value field
        valueField = new IntegerField("Value");
        valueField.RegisterValueChangedCallback(evt => Value = evt.newValue);
        mainContainer.Add(valueField);

        UpdateValueFieldVisibility();

        // ����������� ���������� ������ ������� �� �������, ����� ���� ����� �������� � ����
        this.RegisterCallback<AttachToPanelEvent>(OnAttachToPanel);

        RefreshExpandedState();
        RefreshPorts();
    }

    private void OnAttachToPanel(AttachToPanelEvent evt)
    {
        // ������ ���� �������� � ���� � ����� �������� ������ � DialogueGraphView
        RefreshPropertyDropdown();
        this.UnregisterCallback<AttachToPanelEvent>(OnAttachToPanel);
    }

    private void UpdateValueFieldVisibility()
    {
        valueField.style.display = (Operator == OperatorType.Increment ||
                                  Operator == OperatorType.Decrement) ?
                                  DisplayStyle.None : DisplayStyle.Flex;
    }

    /// <summary>
    /// ��������� UI-�������� �� ������ ������� �������� �����.
    /// ���������� ��� �������� ���� �� DialogueContainer.
    /// </summary>
    public void UpdateUIFromData()
    {
        if (propertyDropdown != null && operatorDropdown != null && valueField != null)
        {
            propertyDropdown.value = SelectedProperty;
            operatorDropdown.value = Operator.ToString();
            valueField.value = Value;
            UpdateValueFieldVisibility();
        }
    }

    public void RefreshPropertyDropdown()
    {
        // �������� �������� �� �����
        var graphView = GetFirstAncestorOfType<DialogueGraphView>();
        if (graphView != null && propertyDropdown != null)
        {
            propertyDropdown.choices = graphView.IntExposedProperties
                .Where(p => p != null)
                .Select(p => p.PropertyName)
                .ToList();

            // ���� ���� ��������, �������� ������ �� ���������
            if (propertyDropdown.choices.Count > 0 && string.IsNullOrEmpty(SelectedProperty))
            {
                propertyDropdown.value = propertyDropdown.choices[0];
                SelectedProperty = propertyDropdown.choices[0];
            }
            else if (!string.IsNullOrEmpty(SelectedProperty) &&
                     propertyDropdown.choices.Contains(SelectedProperty))
            {
                propertyDropdown.value = SelectedProperty;
            }
            else if (!string.IsNullOrEmpty(SelectedProperty))
            {
                // ���� �������� ���� �������, ���������� �����
                propertyDropdown.value = "";
                SelectedProperty = "";
            }
        }
    }
}

//==== File 29 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\OptionNode.cs ====
using UnityEditor.Experimental.GraphView;
using UnityEngine.UIElements;
using UnityEngine;
using UnityEditor.Search;

/// <summary>
/// ���� �������� ������ ������ - �������� ����� ������ � �������
/// ����� ���� ��������� ������ � SpeechNode
/// </summary>
public class OptionNode : BaseNode
{
    public string ResponseText { get; set; } // ����� ������
    public AudioClip AudioClip { get; set; } // ��������� �������

    protected TextField responseTextField;
    protected ObjectField audioField;

    /// <summary>
    /// ������������� ���� �������� ������ ������
    /// </summary>
    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Option Node";
        ResponseText = "New Response";

        // ������� ������� ���� (������ ���� �����������)
        var inputPort = InstantiatePort(Orientation.Horizontal, Direction.Input, Port.Capacity.Single, typeof(float));
        inputPort.portName = "Input";
        inputContainer.Add(inputPort);

        // ������� �������� ���� (������ ���� �����������)
        var outputPort = InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
        outputPort.portName = "Next";
        outputContainer.Add(outputPort);

        // ���� ��� ������ ������
        responseTextField = new TextField("Response Text:");
        responseTextField.multiline = true;
        responseTextField.RegisterValueChangedCallback(evt =>
        {
            ResponseText = evt.newValue;
            //title = ResponseText.Length > 15 ? ResponseText.Substring(0, 15) + "..." : ResponseText;
        });
        responseTextField.SetValueWithoutNotify(ResponseText);
        mainContainer.Add(responseTextField);

        // ���� ��� ������ ����������
        audioField = new ObjectField("Audio Clip");
        audioField.objectType = typeof(AudioClip);
        audioField.RegisterValueChangedCallback(evt =>
        {
            AudioClip = evt.newValue as AudioClip;
        });
        mainContainer.Add(audioField);

        // ��������� ���������� ��������� ����
        RefreshExpandedState();
        RefreshPorts();

        // ��������� ����������� ����� ��� OptionNode
        styleSheets.Add(Resources.Load<StyleSheet>("DefNode"));
    }

    public virtual void SetResponseText(string text)
    {
        ResponseText = text;
        if (responseTextField != null)
            responseTextField.SetValueWithoutNotify(text);
    }
}

//==== File 30 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\OptionNodeAudio.cs ====
using UnityEngine;
using UnityEngine.UIElements;
using UnityEditor.Experimental.GraphView;

public class OptionNodeAudio : OptionNode
{
    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Option (Audio)";

        // ������� ��������� ����
        if (responseTextField != null)
        {
            mainContainer.Remove(responseTextField);
            responseTextField = null;
            ResponseText = string.Empty;
        }

        // ������������� ����
        styleSheets.Add(Resources.Load<StyleSheet>("OptionNodeAudio"));
    }
}

//==== File 31 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\OptionNodeImage.cs ====
using UnityEngine;
using UnityEngine.UIElements;
using UnityEditor.Experimental.GraphView;
using UnityEditor.Search;

public class OptionNodeImage : OptionNode
{
    public Sprite ImageSprite { get; set; }
    private ObjectField imageField;

    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Option (Image)";

        // ������� �������� ����
        if (responseTextField != null)
        {
            mainContainer.Remove(responseTextField);
            responseTextField = null;
            ResponseText = string.Empty;
        }

        if (audioField != null)
        {
            mainContainer.Remove(audioField);
            audioField = null;
            AudioClip = null;
        }

        // ��������� ���� ��� �����������
        imageField = new ObjectField("Image Sprite");
        imageField.objectType = typeof(Sprite);
        imageField.RegisterValueChangedCallback(evt =>
        {
            ImageSprite = evt.newValue as Sprite;
        });
        mainContainer.Add(imageField);

        // ������������� ����
        styleSheets.Add(Resources.Load<StyleSheet>("OptionNodeImage"));
    }
}


//==== File 32 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\OptionNodeText.cs ====
// Assets/Scripts/Editor/DialogueGraph/Nodes/OptionNodeText.cs
using UnityEngine;
using UnityEngine.UIElements;
using UnityEditor.Experimental.GraphView;

public class OptionNodeText : OptionNode
{
    private Label _previewLabel;
    private Button _editButton;
    private TextEditorModalWindow _modalWindow;

    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Option (Text)";

        if (responseTextField != null)
        {
            mainContainer.Remove(responseTextField);
            responseTextField = null;
        }

        _previewLabel = new Label(ResponseText)
        {
            style =
            {
                whiteSpace = WhiteSpace.Normal,
                overflow = Overflow.Visible,
                flexGrow = 1,
                flexShrink = 0,
                alignSelf = Align.Stretch
            }
        };
        _previewLabel.AddToClassList("option-text-preview");

        _editButton = new Button(OpenTextEditor) { text = "✎" };
        _editButton.style.position = Position.Absolute;
        _editButton.style.top = 2;
        _editButton.style.right = 2;
        _editButton.style.width = 24;
        _editButton.style.height = 20;
        _editButton.style.fontSize = 10;

        mainContainer.Add(_previewLabel);
        titleContainer.Add(_editButton);

        if (audioField != null)
        {
            mainContainer.Remove(audioField);
            audioField = null;
            AudioClip = null;
        }

        styleSheets.Add(Resources.Load<StyleSheet>("OptionNodeText"));

        _previewLabel.RegisterCallback<GeometryChangedEvent>(OnPreviewLabelResized);
    }

    private void OnPreviewLabelResized(GeometryChangedEvent evt)
    {
        var contentHeight = _previewLabel.layout.height;
        var minHeight = 80f;
        var newHeight = Mathf.Max(minHeight, contentHeight + 60);

        var rect = GetPosition();
        rect.height = newHeight;
        SetPosition(rect);
    }

    private void OpenTextEditor()
    {
        var graphView = GetFirstAncestorOfType<DialogueGraphView>();
        if (graphView == null) return;

        if (_modalWindow != null)
            _modalWindow.Close();

        _modalWindow = new TextEditorModalWindow(ResponseText, GUID, newText =>
        {
            ResponseText = newText;
            _previewLabel.text = ResponseText;
        });
        _modalWindow.style.position = Position.Absolute;
        _modalWindow.style.top = 30;
        _modalWindow.style.right = 0;
        graphView.Add(_modalWindow);
    }

    public override void SetResponseText(string text)
    {
        ResponseText = text ?? "";
        if (_previewLabel != null)
            _previewLabel.text = ResponseText;
    }
}

//==== File 33 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\SpeechNode.cs ====
using UnityEditor.Experimental.GraphView;
using UnityEngine.UIElements;
using UnityEngine;
using UnityEditor.Search;

/// <summary>
/// ���� ���� NPC - �������� ������ � �������
/// ����� ����� ��������� ��������� ���������� � OptionNode
/// </summary>
public class SpeechNode : BaseNode
{
    public string DialogueText { get; set; } // ����� �������
    public AudioClip AudioClip { get; set; } // ��������� �������

    protected TextField dialogueTextField;
    protected ObjectField audioField;

    public CharacterData Speaker;
    private ObjectField speakerField;



    /// <summary>
    /// ������������� ���� ���� NPC
    /// </summary>
    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Speech Node";
        DialogueText = "New Dialogue";

        // ������� ������� ���� � ������������ ������������� �����������
        var inputPort = InstantiatePort(Orientation.Horizontal, Direction.Input, Port.Capacity.Multi, typeof(float));
        inputPort.portName = "Input";
        inputContainer.Add(inputPort);

        // ������� �������� ���� � ������������ ������������� �����������
        var outputPort = InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Multi, typeof(float));
        outputPort.portName = "Next";
        outputContainer.Add(outputPort);

        // ���� ��� ������ �������
        dialogueTextField = new TextField("Dialogue Text:");
        dialogueTextField.multiline = true;
        dialogueTextField.RegisterValueChangedCallback(evt =>
        {
            DialogueText = evt.newValue;
            //title = DialogueText.Length > 15 ? DialogueText.Substring(0, 15) + "..." : DialogueText;
        });
        dialogueTextField.SetValueWithoutNotify(DialogueText);
        mainContainer.Add(dialogueTextField);

        // ���� ��� ������ ����������
        audioField = new ObjectField("Audio Clip");
        audioField.objectType = typeof(AudioClip);
        audioField.RegisterValueChangedCallback(evt =>
        {
            AudioClip = evt.newValue as AudioClip;
        });
        mainContainer.Add(audioField);

        speakerField = new ObjectField("Speaker");
        speakerField.objectType = typeof(CharacterData);
        speakerField.RegisterValueChangedCallback(evt =>
        {
            Speaker = evt.newValue as CharacterData;
        });
        mainContainer.Add(speakerField);

        // ��������� ���������� ��������� ����
        RefreshExpandedState();
        RefreshPorts();

        // ��������� ����������� ����� ��� SpeechNode
        styleSheets.Add(Resources.Load<StyleSheet>("DefNode"));
    }

    /// <summary>
    /// ������� ���� �� �����
    /// </summary>
    public Port GetPortByName(string portName)
    {
        foreach (var port in outputContainer.Children())
        {
            if (port is Port portElement && portElement.portName == portName)
            {
                return portElement;
            }
        }
        return null;
    }

    public void SetSpeaker(CharacterData speaker)
    {
        Speaker = speaker;
        if (speakerField != null)
        {
            speakerField.SetValueWithoutNotify(speaker);
        }
    }

    public virtual void SetDialogueText(string text)
    {
        DialogueText = text;
        if (dialogueTextField != null)
            dialogueTextField.SetValueWithoutNotify(text);
    }
}

//==== File 34 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\SpeechNodeAudio.cs ====
using UnityEngine;
using UnityEngine.UIElements;
using UnityEditor.Experimental.GraphView;

public class SpeechNodeAudio : SpeechNode
{
    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Speech (Audio)";

        // ������� ��������� ����
        if (dialogueTextField != null)
        {
            mainContainer.Remove(dialogueTextField);
            dialogueTextField = null;
            DialogueText = string.Empty;
        }

        // ������������� ����
        styleSheets.Add(Resources.Load<StyleSheet>("SpeechNodeAudio"));
    }
}

//==== File 35 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\SpeechNodeImage.cs ====
using UnityEngine;
using UnityEngine.UIElements;
using UnityEditor.Experimental.GraphView;
using UnityEditor.Search;

public class SpeechNodeImage : SpeechNode
{
    public Sprite ImageSprite { get; set; }
    private ObjectField imageField;

    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Speech (Image)";

        // ������� �������� ����
        if (dialogueTextField != null)
        {
            mainContainer.Remove(dialogueTextField);
            dialogueTextField = null;
            DialogueText = string.Empty;
        }

        if (audioField != null)
        {
            mainContainer.Remove(audioField);
            audioField = null;
            AudioClip = null;
        }

        // ��������� ���� ��� �����������
        imageField = new ObjectField("Image Sprite");
        imageField.objectType = typeof(Sprite);
        imageField.RegisterValueChangedCallback(evt =>
        {
            ImageSprite = evt.newValue as Sprite;
        });
        mainContainer.Add(imageField);

        // ������������� ����
        styleSheets.Add(Resources.Load<StyleSheet>("SpeechNodeImage"));
    }
}


//==== File 36 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\SpeechNodeText.cs ====
// Assets/Scripts/Editor/DialogueGraph/Nodes/SpeechNodeText.cs
using UnityEngine;
using UnityEngine.UIElements;
using UnityEditor.Experimental.GraphView;

public class SpeechNodeText : SpeechNode
{
    private Label _previewLabel;
    private Button _editButton;
    private TextEditorModalWindow _modalWindow;

    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Speech (Text)";

        // Удаляем стандартное текстовое поле
        if (dialogueTextField != null)
        {
            mainContainer.Remove(dialogueTextField);
            dialogueTextField = null;
        }

        // Создаём превью-лейбл с поддержкой роста по высоте
        _previewLabel = new Label(DialogueText)
        {
            style =
            {
                whiteSpace = WhiteSpace.Normal,
                overflow = Overflow.Visible, // ← Важно: не Hidden!
                flexGrow = 1,
                flexShrink = 0,
                alignSelf = Align.Stretch
            }
        };
        _previewLabel.AddToClassList("speech-text-preview");

        // Кнопка редактирования
        _editButton = new Button(OpenTextEditor) { text = "✎" };
        _editButton.style.position = Position.Absolute;
        _editButton.style.top = 2;
        _editButton.style.right = 2;
        _editButton.style.width = 24;
        _editButton.style.height = 20;
        _editButton.style.fontSize = 10;

        mainContainer.Add(_previewLabel);
        titleContainer.Add(_editButton);

        // Убираем аудио-поле
        if (audioField != null)
        {
            mainContainer.Remove(audioField);
            audioField = null;
            AudioClip = null;
        }

        styleSheets.Add(Resources.Load<StyleSheet>("SpeechNodeText"));

        // Подписываемся на изменение геометрии, чтобы обновлять высоту узла
        _previewLabel.RegisterCallback<GeometryChangedEvent>(OnPreviewLabelResized);
    }

    private void OnPreviewLabelResized(GeometryChangedEvent evt)
    {
        // Обновляем высоту узла на основе содержимого
        var contentHeight = _previewLabel.layout.height;
        var minHeight = 80f; // минимум для заголовка + отступов
        var newHeight = Mathf.Max(minHeight, contentHeight + 60); // + отступы и кнопка

        var rect = GetPosition();
        rect.height = newHeight;
        SetPosition(rect);
    }

    private void OpenTextEditor()
    {
        var graphView = GetFirstAncestorOfType<DialogueGraphView>();
        if (graphView == null) return;

        if (_modalWindow != null)
            _modalWindow.Close();

        _modalWindow = new TextEditorModalWindow(DialogueText, GUID, newText =>
        {
            DialogueText = newText;
            _previewLabel.text = DialogueText;
        });
        _modalWindow.style.position = Position.Absolute;
        _modalWindow.style.top = 30;
        _modalWindow.style.right = 0;
        graphView.Add(_modalWindow);
    }

    public override void SetDialogueText(string text)
    {
        DialogueText = text ?? "";
        if (_previewLabel != null)
            _previewLabel.text = DialogueText;
    }
}

//==== File 37 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Nodes\StringConditionNode.cs ====
using System.Collections.Generic;
using UnityEngine.UIElements;
using System.Linq;
using UnityEngine;
using DialogueSystem;
public class StringConditionNode : BaseConditionNode, IPropertyNode
{
    public string SelectedProperty;
    public StringComparisonType Comparison;
    public string CompareValue;

    private DropdownField propertyDropdown;
    private DropdownField comparisonDropdown;
    private TextField valueField;

    public enum StringComparisonType
    {
        Equal,
        NotEqual,
        IsNullOrEmpty
    }

    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);
        title = "Condition (String)";

        // Property dropdown
        propertyDropdown = new DropdownField("Property");
        propertyDropdown.choices = new List<string>();
        propertyDropdown.RegisterValueChangedCallback(evt =>
        {
            SelectedProperty = evt.newValue;
        });
        mainContainer.Add(propertyDropdown);

        // Comparison dropdown
        comparisonDropdown = new DropdownField("Comparison");
        comparisonDropdown.choices = System.Enum.GetNames(typeof(StringComparisonType)).ToList();
        comparisonDropdown.RegisterValueChangedCallback(evt =>
        {
            Comparison = (StringComparisonType)System.Enum.Parse(typeof(StringComparisonType), evt.newValue);
            valueField.SetEnabled(Comparison != StringComparisonType.IsNullOrEmpty);
        });
        mainContainer.Add(comparisonDropdown);

        // Value field
        valueField = new TextField("Value");
        valueField.RegisterValueChangedCallback(evt => CompareValue = evt.newValue);
        mainContainer.Add(valueField);

        // ���������� ����������� ������ ������� ��� ���������� ���� � ������
        this.RegisterCallback<AttachToPanelEvent>(OnAttachToPanel);
    }

    private void OnAttachToPanel(AttachToPanelEvent evt)
    {
        // ������ ���� �������� � ���� � ����� �������� ������ � DialogueGraphView
        RefreshPropertyDropdown();
        this.UnregisterCallback<AttachToPanelEvent>(OnAttachToPanel);
    }

    /// <summary>
    /// ������������� ��������� ������ ���� �� ������������� UI.
    /// ������������ ��� �������� ����������� �������.
    /// </summary>
    public void SetInitialData(string property, StringComparisonType comparison, string value)
    {
        SelectedProperty = property;
        Comparison = comparison;
        CompareValue = value;
    }

    public void RefreshPropertyDropdown()
    {
        propertyDropdown.RegisterValueChangedCallback(evt =>
        {
            SelectedProperty = evt.newValue;
        });

        // �������� �������� �� �����
        var graphView = GetFirstAncestorOfType<DialogueGraphView>();
        if (graphView != null && propertyDropdown != null)
        {
            propertyDropdown.choices = graphView.StringExposedProperties
                .Where(p => p != null)
                .Select(p => p.PropertyName)
                .ToList();

            // ���� ���� ��������, �������� ������ �� ���������
            if (propertyDropdown.choices.Count > 0 && string.IsNullOrEmpty(SelectedProperty))
            {
                propertyDropdown.value = propertyDropdown.choices[0];
                SelectedProperty = propertyDropdown.choices[0];
            }
            else if (!string.IsNullOrEmpty(SelectedProperty))
            {
                propertyDropdown.value = SelectedProperty;
            }
        }
    }

    /// <summary>
    /// ��������� UI-�������� �� ������ ������� �������� �����.
    /// �������� ����� �������� ������ � ���������� ���� � ����.
    /// </summary>
    public void UpdateUIFromData()
    {
        if (propertyDropdown != null && comparisonDropdown != null && valueField != null)
        {
            propertyDropdown.value = SelectedProperty;
            comparisonDropdown.value = Comparison.ToString();
            valueField.value = CompareValue;
            valueField.SetEnabled(Comparison != StringComparisonType.IsNullOrEmpty);
        }
    }
}

//==== File 38 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Utilities\AssetDatabaseHelper.cs ====
using UnityEditor;
using UnityEngine;

public static class AssetDatabaseHelper
{
    public static string GetAssetGuid(Object asset)
    {
        if (asset == null) return string.Empty;
        return AssetDatabase.AssetPathToGUID(AssetDatabase.GetAssetPath(asset));
    }

    public static T LoadAssetFromGuid<T>(string guid) where T : Object
    {
        if (string.IsNullOrEmpty(guid)) return null;
        string path = AssetDatabase.GUIDToAssetPath(guid);
        return AssetDatabase.LoadAssetAtPath<T>(path);
    }

    public static bool IsValidGuid(string guid)
    {
        if (string.IsNullOrEmpty(guid)) return false;
        string path = AssetDatabase.GUIDToAssetPath(guid);
        return !string.IsNullOrEmpty(path) && AssetDatabase.LoadAssetAtPath<Object>(path) != null;
    }
}


//==== File 39 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Utilities\DialogueValidator.cs ====
using UnityEngine;


public static class DialogueValidator
{
    public static void ValidateSpeechNodes(DialogueContainer container)
    {
        foreach (var nodeData in container.SpeechNodeDatas)
        {
            if (string.IsNullOrEmpty(nodeData.SpeakerGuid) ||
                !AssetDatabaseHelper.IsValidGuid(nodeData.SpeakerGuid))
            {
                Debug.LogError($"SpeechNode (GUID: {nodeData.Guid}) has no speaker assigned! Text: \"{nodeData.DialogueText}\"");
            }
        }
    }
}

//==== File 40 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Utilities\GraphSaveUtility.cs ====
using UnityEditor.Experimental.GraphView;
using System.Collections.Generic;
using UnityEngine.UIElements;
using System.Linq;
using UnityEngine;
using UnityEditor;
using System;
using UnityEngine.Events;

/// <summary>
/// Утилита для сохранения и загрузки диалоговых графов
/// </summary>
public class GraphSaveUtility
{
    private DialogueGraphView targetGraphView;
    private DialogueContainer containerCache;

    private List<BaseNode> GetNodes() => targetGraphView.nodes.ToList().Cast<BaseNode>().ToList();
    private List<Edge> GetEdges() => targetGraphView.edges.ToList();

    /// <summary>
    /// Получение экземпляра утилиты для сохранения
    /// </summary>
    public static GraphSaveUtility GetInstance(DialogueGraphView targetGraphView)
    {
        return new GraphSaveUtility { targetGraphView = targetGraphView };
    }

    #region Saving
    /// <summary>
    /// Сохранение графа в файл
    /// </summary>
    public void SaveGraph(string fileName)
    {
        // Создаем контейнер для данных диалога
        var dialogueContainer = ScriptableObject.CreateInstance<DialogueContainer>();

        // Сохраняем узлы и связи
        SaveNodes(dialogueContainer);

        // Сохраняем свойства черной доски
        SaveExposedProperties(dialogueContainer);

        // Создаем папку Resources если не существует
        if (!AssetDatabase.IsValidFolder("Assets/Resources"))
            AssetDatabase.CreateFolder("Assets", "Resources");

        // Сохраняем ассет
        AssetDatabase.CreateAsset(dialogueContainer, $"Assets/Resources/{fileName}.asset");
        AssetDatabase.SaveAssets();

        EditorUtility.DisplayDialog("Success", $"Graph saved as {fileName}", "OK");
    }

    /// <summary>
    /// Сохраняет узлы в контейнер
    /// </summary>
    private void SaveNodes(DialogueContainer dialogueContainer)
    {
        dialogueContainer.BaseCharacterGuid = targetGraphView.BaseCharacterGuid;

        // Сохраняем связи между узлами
        var edgesList = targetGraphView.edges.ToList();
        var connectedPorts = edgesList.Where(x => x.input.node != null).ToArray();
        foreach (var edge in connectedPorts)
        {;
            var outputNode = edge.output.node as BaseNode;
            var inputNode = edge.input.node as BaseNode;
            dialogueContainer.NodeLinks.Add(new NodeLinkData
            {
                BaseNodeGuid = outputNode.GUID,
                PortName = edge.output.portName,
                TargetNodeGuid = inputNode.GUID
            });
        }

        // Сохраняем данные узлов
        foreach (var node in GetNodes())
        {
            if (node.EntryPoint)
            {
                dialogueContainer.EntryNodeData = new EntryNodeData
                {
                    Guid = node.GUID,
                    Position = node.GetPosition().position
                };
            }
            else if (node is SpeechNodeText speechNodeText)
            {
                dialogueContainer.SpeechNodeDatas.Add(new SpeechNodeData
                {
                    Guid = speechNodeText.GUID,
                    DialogueText = speechNodeText.DialogueText,
                    Position = node.GetPosition().position,
                    AudioClipGuid = "",
                    SpeakerGuid = speechNodeText.Speaker ? AssetDatabaseHelper.GetAssetGuid(speechNodeText.Speaker) : "",
                    NodeType = "SpeechNodeText"
                });
            }
            else if (node is SpeechNodeAudio speechNodeAudio)
            {
                dialogueContainer.SpeechNodeDatas.Add(new SpeechNodeData
                {
                    Guid = speechNodeAudio.GUID,
                    DialogueText = "", // Аудио-ноды не используют текст
                    Position = node.GetPosition().position,
                    AudioClipGuid = speechNodeAudio.AudioClip ? AssetDatabase.AssetPathToGUID(AssetDatabase.GetAssetPath(speechNodeAudio.AudioClip)) : "",
                    SpeakerGuid = speechNodeAudio.Speaker ? AssetDatabaseHelper.GetAssetGuid(speechNodeAudio.Speaker) : "",
                    NodeType = "SpeechNodeAudio"
                });
            }
            else if (node is SpeechNodeImage speechNodeImage)
            {
                dialogueContainer.SpeechNodeImageDatas.Add(new SpeechNodeImageData
                {
                    Guid = speechNodeImage.GUID,
                    Position = node.GetPosition().position,
                    ImageSpriteGuid = speechNodeImage.ImageSprite ? AssetDatabase.AssetPathToGUID(AssetDatabase.GetAssetPath(speechNodeImage.ImageSprite)) : "",
                    SpeakerGuid = speechNodeImage.Speaker ? AssetDatabaseHelper.GetAssetGuid(speechNodeImage.Speaker) : "",
                    NodeType = "SpeechNodeImage"
                });
            }
            else if (node is OptionNodeText optionNodeText)
            {
                dialogueContainer.OptionNodeDatas.Add(new OptionNodeData
                {
                    Guid = optionNodeText.GUID,
                    ResponseText = optionNodeText.ResponseText,
                    Position = node.GetPosition().position,
                    AudioClipGuid = "",
                    NodeType = "OptionNodeText"
                });
            }
            else if (node is OptionNodeAudio optionNodeAudio)
            {
                dialogueContainer.OptionNodeDatas.Add(new OptionNodeData
                {
                    Guid = optionNodeAudio.GUID,
                    ResponseText = "", // Аудио-опции не используют текст
                    Position = node.GetPosition().position,
                    AudioClipGuid = optionNodeAudio.AudioClip ? AssetDatabase.AssetPathToGUID(AssetDatabase.GetAssetPath(optionNodeAudio.AudioClip)) : "",
                    NodeType = "OptionNodeAudio"
                });
            }
            else if (node is OptionNodeImage optionNodeImage)
            {
                dialogueContainer.OptionNodeImageDatas.Add(new OptionNodeImageData
                {
                    Guid = optionNodeImage.GUID,
                    Position = node.GetPosition().position,
                    ImageSpriteGuid = optionNodeImage.ImageSprite ? AssetDatabase.AssetPathToGUID(AssetDatabase.GetAssetPath(optionNodeImage.ImageSprite)) : "",
                    NodeType = "OptionNodeImage"
                });
            }
            else if (node is IntConditionNode intConditionNode)
            {
                dialogueContainer.IntConditionNodeDatas.Add(new IntConditionNodeData
                {
                    Guid = intConditionNode.GUID,
                    Position = node.GetPosition().position,
                    SelectedProperty = intConditionNode.SelectedProperty,
                    Comparison = intConditionNode.Comparison,
                    CompareValue = intConditionNode.CompareValue
                });
            }
            else if (node is StringConditionNode stringConditionNode)
            {
                dialogueContainer.StringConditionNodeDatas.Add(new StringConditionNodeData
                {
                    Guid = stringConditionNode.GUID,
                    Position = node.GetPosition().position,
                    SelectedProperty = stringConditionNode.SelectedProperty,
                    Comparison = (DialogueSystem.StringComparisonType)stringConditionNode.Comparison,
                    CompareValue = stringConditionNode.CompareValue
                });
            }
            else if (node is ModifyIntNode modifyIntNode)
            {
                dialogueContainer.ModifyIntNodeDatas.Add(new ModifyIntNodeData
                {
                    Guid = modifyIntNode.GUID,
                    Position = node.GetPosition().position,
                    SelectedProperty = modifyIntNode.SelectedProperty,
                    Operator = modifyIntNode.Operator,
                    Value = modifyIntNode.Value
                });
            }
            else if (node is EndNode endNode)
            {
                dialogueContainer.EndNodeDatas.Add(new EndNodeData
                {
                    Guid = endNode.GUID,
                    Position = node.GetPosition().position,
                    NextDialogueName = endNode.GetNextDialoguePath()
                });
            }
            else if (node is EventNode eventNode)
            {
                dialogueContainer.EventNodeDatas.Add(new EventNodeData
                {
                    Guid = eventNode.GUID,
                    Position = node.GetPosition().position,
                    Event = eventNode.RuntimeEvent
                });
            }
            else if (node is CharacterIntConditionNode charIntCond)
            {
                dialogueContainer.CharacterIntConditionNodeDatas.Add(new CharacterIntConditionNodeData
                {
                    Guid = charIntCond.GUID,
                    Position = node.GetPosition().position,
                    CharacterName = charIntCond.CharacterName,
                    SelectedVariable = charIntCond.SelectedVariable,
                    Comparison = charIntCond.Comparison,
                    CompareValue = charIntCond.CompareValue
                });
            }
            else if (node is CharacterModifyIntNode charModify)
            {
                dialogueContainer.CharacterModifyIntNodeDatas.Add(new CharacterModifyIntNodeData
                {
                    Guid = charModify.GUID,
                    Position = node.GetPosition().position,
                    CharacterName = charModify.CharacterName,
                    SelectedVariable = charModify.SelectedVariable,
                    Operator = charModify.Operator,
                    Value = charModify.Value
                });
            }
        }
    }

    /// <summary>
    /// Сохранение свойств черной доски
    /// </summary>
    private void SaveExposedProperties(DialogueContainer dialogueContainer)
    {
        // Очистка старых данных
        dialogueContainer.ExposedProperties.Clear(); // для обратной совместимости, если используется
        dialogueContainer.IntExposedProperties.Clear();
        dialogueContainer.StringExposedProperties.Clear();

        // Сохранение актуальных данных
        dialogueContainer.IntExposedProperties.AddRange(targetGraphView.IntExposedProperties);
        dialogueContainer.StringExposedProperties.AddRange(targetGraphView.StringExposedProperties);
    }
    #endregion

    #region Loading
    /// <summary>
    /// Загрузка графа из файла
    /// </summary>
    public void LoadGraph(string fileName)
    {
        containerCache = Resources.Load<DialogueContainer>(fileName);
        if (containerCache == null)
        {
            EditorUtility.DisplayDialog("File Not Found", "Target dialogue graph file does not exist", "OK");
            return;
        }

        ClearGraph();
        CreateNodes();
        ConnectNodes();
        CreateExposedProperties();

        EditorUtility.DisplayDialog("Success", $"Graph {fileName} loaded", "OK");
    }

    /// <summary>
    /// Создает узлы из загруженных данных
    /// </summary>
    private void CreateNodes()
    {
        // Восстанавливаем EntryNode
        if (containerCache.EntryNodeData != null)
        {
            var entryNode = GetNodes().Find(x => x.EntryPoint);
            if (entryNode != null)
            {
                entryNode.GUID = containerCache.EntryNodeData.Guid;
                entryNode.SetPosition(new Rect(containerCache.EntryNodeData.Position, targetGraphView.DefaultNodeSize));
            }
        }

        // Создаем SpeechNode
        foreach (var nodeData in containerCache.SpeechNodeDatas)
        {
            BaseNode tempNode = null;
            switch (nodeData.NodeType)
            {
                case "SpeechNodeText":
                    tempNode = NodeFactory.CreateSpeechNodeText(nodeData.Position);
                    if (tempNode is SpeechNode speechNodeText)
                    {
                        speechNodeText.SetDialogueText(nodeData.DialogueText);
                    }
                    break;
                case "SpeechNodeAudio":
                    tempNode = NodeFactory.CreateSpeechNodeAudio(nodeData.Position);
                    break;
                default:
                    tempNode = NodeFactory.CreateSpeechNode(nodeData.Position);
                    if (tempNode is SpeechNode speechNode)
                    {
                        speechNode.SetDialogueText(nodeData.DialogueText);
                    }
                    break;
            }
            tempNode.GUID = nodeData.Guid;

            // Восстанавливаем аудио клип по GUID
            if (!string.IsNullOrEmpty(nodeData.AudioClipGuid))
            {
                var audioClip = AssetDatabase.LoadAssetAtPath<AudioClip>(
                    AssetDatabase.GUIDToAssetPath(nodeData.AudioClipGuid));
                if (tempNode is SpeechNode speechNode)
                {
                    speechNode.AudioClip = audioClip;
                }
            }

            // Восстанавливаем спикера по GUID
            if (!string.IsNullOrEmpty(nodeData.SpeakerGuid))
            {
                var speaker = AssetDatabaseHelper.LoadAssetFromGuid<CharacterData>(nodeData.SpeakerGuid);
                if (tempNode is SpeechNode speechNode)
                {
                    speechNode.SetSpeaker(speaker);
                }
            }

            targetGraphView.AddElement(tempNode);
        }

        // Создаем SpeechNodeImage
        foreach (var nodeData in containerCache.SpeechNodeImageDatas)
        {
            var tempNode = NodeFactory.CreateSpeechNodeImage(nodeData.Position);
            tempNode.GUID = nodeData.Guid;

            // Восстанавливаем изображение по GUID
            if (!string.IsNullOrEmpty(nodeData.ImageSpriteGuid))
            {
                var imageSprite = AssetDatabase.LoadAssetAtPath<Sprite>(
                    AssetDatabase.GUIDToAssetPath(nodeData.ImageSpriteGuid));
                if (tempNode is SpeechNodeImage speechNodeImage)
                {
                    speechNodeImage.ImageSprite = imageSprite;
                }
            }

            // Восстанавливаем спикера по GUID
            if (!string.IsNullOrEmpty(nodeData.SpeakerGuid))
            {
                var speaker = AssetDatabaseHelper.LoadAssetFromGuid<CharacterData>(nodeData.SpeakerGuid);
                if (tempNode is SpeechNodeImage speechNodeImage)
                {
                    speechNodeImage.SetSpeaker(speaker);
                }
            }

            targetGraphView.AddElement(tempNode);
        }

        // Создаем OptionNode
        foreach (var nodeData in containerCache.OptionNodeDatas)
        {
            BaseNode tempNode = null;
            switch (nodeData.NodeType)
            {
                case "OptionNodeText":
                    tempNode = NodeFactory.CreateOptionNodeText(nodeData.Position);
                    if (tempNode is OptionNode optionNodeText)
                    {
                        optionNodeText.SetResponseText(nodeData.ResponseText);
                    }
                    break;
                case "OptionNodeAudio":
                    tempNode = NodeFactory.CreateOptionNodeAudio(nodeData.Position);
                    break;
                default:
                    tempNode = NodeFactory.CreateOptionNode(nodeData.Position);
                    if (tempNode is OptionNode optionNode)
                    {
                        optionNode.SetResponseText(nodeData.ResponseText);
                    }
                    break;
            }
            tempNode.GUID = nodeData.Guid;

            // Восстанавливаем аудио клип по GUID
            if (!string.IsNullOrEmpty(nodeData.AudioClipGuid))
            {
                var audioClip = AssetDatabase.LoadAssetAtPath<AudioClip>(
                    AssetDatabase.GUIDToAssetPath(nodeData.AudioClipGuid));
                if (tempNode is OptionNode optionNode)
                {
                    optionNode.AudioClip = audioClip;
                }
            }

            targetGraphView.AddElement(tempNode);
        }

        // Создаем OptionNodeImage
        foreach (var nodeData in containerCache.OptionNodeImageDatas)
        {
            var tempNode = NodeFactory.CreateOptionNodeImage(nodeData.Position);
            tempNode.GUID = nodeData.Guid;

            // Восстанавливаем изображение по GUID
            if (!string.IsNullOrEmpty(nodeData.ImageSpriteGuid))
            {
                var imageSprite = AssetDatabase.LoadAssetAtPath<Sprite>(
                    AssetDatabase.GUIDToAssetPath(nodeData.ImageSpriteGuid));
                if (tempNode is OptionNodeImage optionNodeImage)
                {
                    optionNodeImage.ImageSprite = imageSprite;
                }
            }

            targetGraphView.AddElement(tempNode);
        }

        // Создаем IntConditionNode
        foreach (var nodeData in containerCache.IntConditionNodeDatas)
        {
            var tempNode = NodeFactory.CreateIntConditionNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is IntConditionNode intConditionNode)
            {
                intConditionNode.SelectedProperty = nodeData.SelectedProperty;
                intConditionNode.Comparison = nodeData.Comparison;
                intConditionNode.CompareValue = nodeData.CompareValue;
            }
            targetGraphView.AddElement(tempNode);
            // Обновляем UI после добавления в граф
            if (tempNode is IntConditionNode icn)
                icn.UpdateUIFromData();
        }

        // Создаем StringConditionNode
        foreach (var nodeData in containerCache.StringConditionNodeDatas)
        {
            var tempNode = NodeFactory.CreateStringConditionNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is StringConditionNode stringConditionNode)
            {
                stringConditionNode.SelectedProperty = nodeData.SelectedProperty;
                stringConditionNode.Comparison = (StringConditionNode.StringComparisonType)nodeData.Comparison;
                stringConditionNode.CompareValue = nodeData.CompareValue;
            }
            targetGraphView.AddElement(tempNode);
            // Обновляем UI после добавления в граф
            if (tempNode is StringConditionNode scn)
                scn.UpdateUIFromData();
        }

        // Создаем ModifyIntNode
        foreach (var nodeData in containerCache.ModifyIntNodeDatas)
        {
            var tempNode = NodeFactory.CreateModifyIntNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is ModifyIntNode modifyIntNode)
            {
                modifyIntNode.SelectedProperty = nodeData.SelectedProperty;
                modifyIntNode.Operator = nodeData.Operator;
                modifyIntNode.Value = nodeData.Value;
                modifyIntNode.UpdateUIFromData(); // ← добавлено
            }
            targetGraphView.AddElement(tempNode);
        }

        // Создаем EndNode
        foreach (var nodeData in containerCache.EndNodeDatas)
        {
            var tempNode = NodeFactory.CreateEndNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is EndNode endNodeEditor)
            {
                endNodeEditor.SetNextDialogueFromPath(nodeData.NextDialogueName);
            }
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.EventNodeDatas)
        {
            var tempNode = new EventNode();
            tempNode.Initialize(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            tempNode.RuntimeEvent = nodeData.Event;
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.CharacterIntConditionNodeDatas)
        {
            var tempNode = NodeFactory.CreateCharacterIntConditionNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is CharacterIntConditionNode n)
            {
                n.SetInitialData(nodeData.CharacterName, nodeData.SelectedVariable, nodeData.Comparison, nodeData.CompareValue);
                n.UpdateUIFromData();
            }
            targetGraphView.AddElement(tempNode);
        }

        foreach (var nodeData in containerCache.CharacterModifyIntNodeDatas)
        {
            var tempNode = NodeFactory.CreateCharacterModifyIntNode(nodeData.Position);
            tempNode.GUID = nodeData.Guid;
            if (tempNode is CharacterModifyIntNode n)
            {
                n.CharacterName = nodeData.CharacterName;
                n.SelectedVariable = nodeData.SelectedVariable;
                n.Operator = nodeData.Operator;
                n.Value = nodeData.Value;
                n.UpdateUIFromData();
            }
            targetGraphView.AddElement(tempNode);
        }
    }

    /// <summary>
    /// Восстановление связей между узлами
    /// </summary>
    /// <summary>
    /// Восстановление связей между узлами
    /// </summary>
    private void ConnectNodes()
    {
        try
        {
            var nodeList = this.targetGraphView.nodes.ToList().Cast<BaseNode>().ToList();
            for (int i = 0; i < nodeList.Count; i++)
            {
                var connections = containerCache.NodeLinks.Where(x => x.BaseNodeGuid == nodeList[i].GUID).ToList();
                foreach (var connection in connections)
                {
                    var targetNodeGuid = connection.TargetNodeGuid;
                    var targetNode = nodeList.FirstOrDefault(x => x.GUID == targetNodeGuid);
                    if (targetNode == null)
                    {
                        Debug.LogWarning($"Target node not found for GUID: {targetNodeGuid}");
                        continue;
                    }

                    Port outputPort = null;

                    // Определяем outputPort в зависимости от типа узла
                    if (nodeList[i] is SpeechNode speechNode)
                    {
                        foreach (var port in speechNode.outputContainer.Children())
                        {
                            if (port is Port portElement && portElement.portName == connection.PortName)
                            {
                                outputPort = portElement;
                                break;
                            }
                        }
                        if (outputPort == null)
                        {
                            outputPort = speechNode.InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
                            outputPort.portName = connection.PortName;
                            speechNode.outputContainer.Add(outputPort);
                            speechNode.RefreshPorts();
                            speechNode.RefreshExpandedState();
                        }
                    }
                    else if (nodeList[i] is OptionNode optionNode)
                    {
                        outputPort = optionNode.outputContainer[0].Q<Port>();
                    }
                    else if (nodeList[i] is EntryNode entryNode)
                    {
                        outputPort = entryNode.outputContainer[0].Q<Port>();
                    }
                    else if (nodeList[i] is IntConditionNode || nodeList[i] is StringConditionNode)
                    {
                        foreach (var port in nodeList[i].outputContainer.Children())
                        {
                            if (port is Port portElement && portElement.portName == connection.PortName)
                            {
                                outputPort = portElement;
                                break;
                            }
                        }
                        if (outputPort == null)
                        {
                            Debug.LogWarning($"Port '{connection.PortName}' not found on condition node {nodeList[i].GUID}");
                        }
                    }
                    else if (nodeList[i] is ModifyIntNode modifyNode)
                    {
                        outputPort = modifyNode.outputContainer[0].Q<Port>();
                    }
                    else if (nodeList[i] is EndNode endNode)
                    {
                        outputPort = endNode.outputContainer[0].Q<Port>();
                    }
                    else if (nodeList[i] is EventNode eventNode)
                    {
                        outputPort = eventNode.outputContainer[0].Q<Port>();
                    }

                    // Получаем inputPort у целевого узла
                    Port inputPort = null;
                    if (targetNode.inputContainer.childCount > 0)
                    {
                        inputPort = targetNode.inputContainer[0] as Port;
                    }

                    // Соединяем порты
                    if (outputPort != null && inputPort != null)
                    {
                        LinkNodes(outputPort, inputPort);
                    }
                    else
                    {
                        Debug.LogWarning($"Failed to connect {nodeList[i].GUID} -> {targetNodeGuid}. outputPort: {outputPort != null}, inputPort: {inputPort != null}");
                    }
                }
            }
        }
        catch (Exception e)
        {
            Debug.LogError($"Error connecting nodes: {e.Message}\n{e.StackTrace}");
        }
    }

    /// <summary>
    /// Связывание двух портов
    /// </summary>
    private void LinkNodes(Port output, Port input)
    {
        var tempEdge = new Edge { output = output, input = input };
        tempEdge.input.Connect(tempEdge);
        tempEdge.output.Connect(tempEdge);
        targetGraphView.Add(tempEdge);
    }

    /// <summary>
    /// Восстановление свойств черной доски
    /// </summary>
    private void CreateExposedProperties()
    {
        targetGraphView.ClearBlackBoardAndExposedProperties();

        // Загружаем Int свойства
        foreach (var prop in containerCache.IntExposedProperties)
        {
            var newProp = new IntExposedProperty
            {
                PropertyName = prop.PropertyName,
                IntValue = prop.IntValue,
                MinValue = prop.MinValue,
                MaxValue = prop.MaxValue
            };
            targetGraphView.AddPropertyToBlackBoard(newProp);
        }

        // Загружаем String свойства
        foreach (var prop in containerCache.StringExposedProperties)
        {
            var newProp = new StringExposedProperty
            {
                PropertyName = prop.PropertyName,
                StringValue = prop.StringValue
            };
            targetGraphView.AddPropertyToBlackBoard(newProp);
        }

        // Принудительно обновляем все выпадающие списки после загрузки свойств
        var propertyNodes = targetGraphView.nodes.ToList().OfType<IPropertyNode>();
        foreach (var node in propertyNodes)
            node.RefreshPropertyDropdown();
    }

    /// <summary>
    /// Очистка текущего графа перед загрузкой
    /// </summary>
    private void ClearGraph()
    {
        // Удаляем все узлы кроме стартового
        foreach (var node in GetNodes().Where(node => !node.EntryPoint).ToList())
        {
            // Удаляем связанные связи
            var edgesToRemove = GetEdges().Where(x => x.input.node == node || x.output.node == node).ToList();
            foreach (var edge in edgesToRemove)
            {
                targetGraphView.RemoveElement(edge);
            }

            targetGraphView.RemoveElement(node);
        }
    }
    #endregion

    /// <summary>
    /// Загружает граф из уже загруженного DialogueContainer
    /// </summary>
    public void LoadGraphFromContainer(DialogueContainer container)
    {
        if (container == null)
        {
            Debug.LogError("Cannot load null container");
            return;
        }

        containerCache = container;
        ClearGraph();
        CreateNodes();
        ConnectNodes();
        CreateExposedProperties();
    }

    /// <summary>
    /// Сохраняет граф в существующий DialogueContainer
    /// </summary>
    public void SaveGraphToExistingContainer(DialogueContainer existingContainer)
    {
        if (existingContainer == null)
        {
            Debug.LogError("Cannot save to null container");
            return;
        }

        // Очищаем старые данные
        existingContainer.NodeLinks.Clear();
        existingContainer.SpeechNodeDatas.Clear();
        existingContainer.OptionNodeDatas.Clear();
        existingContainer.IntConditionNodeDatas.Clear();
        existingContainer.StringConditionNodeDatas.Clear();
        existingContainer.ModifyIntNodeDatas.Clear();
        existingContainer.EndNodeDatas.Clear();
        existingContainer.SpeechNodeImageDatas.Clear();
        existingContainer.OptionNodeImageDatas.Clear();
        existingContainer.IntExposedProperties.Clear();
        existingContainer.StringExposedProperties.Clear();

        // Сохраняем новые данные
        SaveNodes(existingContainer);
        SaveExposedProperties(existingContainer);

        EditorUtility.SetDirty(existingContainer);
        AssetDatabase.SaveAssets();
    }
}

//==== File 41 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Editor\DialogueGraph\Utilities\NodeFactory.cs ====
using UnityEngine;
using UnityEditor;

/// <summary>
/// Фабрика для создания узлов диалогового графа
/// Централизует логику создания всех типов узлов
/// </summary>
public static class NodeFactory
{
    /// <summary>
    /// Создает узел указанного типа в заданной позиции
    /// </summary>
    private static DialogueGraphView GetGraphView()
    {
        // Получаем все окна типа DialogueGraph
        var windows = Resources.FindObjectsOfTypeAll<DialogueGraph>();
        if (windows.Length > 0)
        {
            return windows[0].graphView;
        }
        return null;
    }

    /// <summary>
    /// Создает узел указанного типа в заданной позиции
    /// </summary>
    public static BaseNode CreateNode(System.Type nodeType, Vector2 position)
    {
        return nodeType.Name switch
        {
            nameof(SpeechNode) => CreateSpeechNode(position),
            nameof(SpeechNodeText) => CreateSpeechNodeText(position),
            nameof(SpeechNodeAudio) => CreateSpeechNodeAudio(position),
            nameof(SpeechNodeImage) => CreateSpeechNodeImage(position),
            nameof(OptionNode) => CreateOptionNode(position),
            nameof(OptionNodeText) => CreateOptionNodeText(position),
            nameof(OptionNodeAudio) => CreateOptionNodeAudio(position),
            nameof(OptionNodeImage) => CreateOptionNodeImage(position),
            nameof(EntryNode) => CreateEntryNode(position),
            nameof(IntConditionNode) => CreateIntConditionNode(position),
            nameof(StringConditionNode) => CreateStringConditionNode(position),
            nameof(ModifyIntNode) => CreateModifyIntNode(position),
            nameof(EndNode) => CreateEndNode(position),
            nameof(EventNode) => CreateEventNode(position),
            nameof(CharacterIntConditionNode) => CreateCharacterIntConditionNode(position),
            nameof(CharacterModifyIntNode) => CreateCharacterModifyIntNode(position),
            _ => null
        };
    }

    public static EventNode CreateEventNode(Vector2 position)
    {
        var node = new EventNode();
        node.Initialize(position);
        return node;
    }

    public static IntConditionNode CreateIntConditionNode(Vector2 position, IntConditionNodeData data = null)
    {
        var node = new IntConditionNode();
        if (data != null)
        {
            node.SetInitialData(data.SelectedProperty, data.Comparison, data.CompareValue);
        }
        node.Initialize(position);
        return node;
    }

    public static StringConditionNode CreateStringConditionNode(Vector2 position)
    {
        var node = new StringConditionNode();
        node.Initialize(position);
        return node;
    }

    public static ModifyIntNode CreateModifyIntNode(Vector2 position)
    {
        var node = new ModifyIntNode();
        node.Initialize(position);
        return node;
    }

    /// <summary>
    /// Создает узел речи NPC
    /// </summary>
    public static SpeechNode CreateSpeechNode(Vector2 position, string dialogueText = "New Dialogue")
    {
        var node = new SpeechNode();
        node.Initialize(position);
        node.DialogueText = dialogueText;

        // Автоматическая установка базового персонажа
        var baseCharacter = GetBaseCharacter();
        if (baseCharacter != null)
        {
            node.SetSpeaker(baseCharacter);
        }

        return node;
    }

    /// <summary>
    /// Создает узел варианта ответа игрока
    /// </summary>
    public static OptionNode CreateOptionNode(Vector2 position, string responseText = "New Response")
    {
        var node = new OptionNode();
        node.Initialize(position);
        node.ResponseText = responseText;
        return node;
    }

    /// <summary>
    /// Создает стартовый узел
    /// </summary>
    public static EntryNode CreateEntryNode(Vector2 position)
    {
        var node = new EntryNode();
        node.Initialize(position);
        return node;
    }

    public static EndNode CreateEndNode(Vector2 position)
    {
        var node = new EndNode();
        node.Initialize(position);
        return node;
    }

    public static SpeechNodeText CreateSpeechNodeText(Vector2 position, string dialogueText = "New Dialogue")
    {
        var node = new SpeechNodeText();
        node.Initialize(position);
        node.DialogueText = dialogueText;

        var baseCharacter = GetBaseCharacter();
        if (baseCharacter != null)
        {
            node.SetSpeaker(baseCharacter);
        }

        return node;
    }

    public static SpeechNodeAudio CreateSpeechNodeAudio(Vector2 position)
    {
        var node = new SpeechNodeAudio();
        node.Initialize(position);

        var baseCharacter = GetBaseCharacter();
        if (baseCharacter != null)
        {
            node.SetSpeaker(baseCharacter);
        }

        return node;
    }

    public static SpeechNodeImage CreateSpeechNodeImage(Vector2 position)
    {
        var node = new SpeechNodeImage();
        node.Initialize(position);

        var baseCharacter = GetBaseCharacter();
        if (baseCharacter != null)
        {
            node.SetSpeaker(baseCharacter);
        }

        return node;
    }

    public static OptionNodeText CreateOptionNodeText(Vector2 position, string responseText = "New Response")
    {
        var node = new OptionNodeText();
        node.Initialize(position);
        node.ResponseText = responseText;
        return node;
    }

    public static OptionNodeAudio CreateOptionNodeAudio(Vector2 position)
    {
        var node = new OptionNodeAudio();
        node.Initialize(position);
        return node;
    }

    public static OptionNodeImage CreateOptionNodeImage(Vector2 position)
    {
        var node = new OptionNodeImage();
        node.Initialize(position);
        return node;
    }

    private static CharacterData GetBaseCharacter()
    {
        var graphView = GetGraphView();
        if (graphView != null && !string.IsNullOrEmpty(graphView.BaseCharacterGuid))
        {
            return AssetDatabaseHelper.LoadAssetFromGuid<CharacterData>(graphView.BaseCharacterGuid);
        }
        return null;
    }

    public static CharacterIntConditionNode CreateCharacterIntConditionNode(Vector2 position)
    {
        var node = new CharacterIntConditionNode();
        node.Initialize(position);
        return node;
    }

    public static CharacterModifyIntNode CreateCharacterModifyIntNode(Vector2 position)
    {
        var node = new CharacterModifyIntNode();
        node.Initialize(position);
        return node;
    }

}

//==== File 42 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Core\BaseConditionNode.cs ====
using UnityEditor.Experimental.GraphView;
using UnityEngine;

public abstract class BaseConditionNode : BaseNode
{
    public override void Initialize(Vector2 position)
    {
        base.Initialize(position);

        // ������� ������� ����
        var inputPort = InstantiatePort(Orientation.Horizontal, Direction.Input, Port.Capacity.Multi, typeof(float));
        inputPort.portName = "Input";
        inputContainer.Add(inputPort);

        // ������� �������� ����� True � False
        var truePort = InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
        truePort.portName = "True";
        outputContainer.Add(truePort);

        var falsePort = InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Single, typeof(float));
        falsePort.portName = "False";
        outputContainer.Add(falsePort);
    }
}


//==== File 43 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Core\BaseNode.cs ====
using UnityEditor.Experimental.GraphView;
using UnityEngine;
using System;

/// <summary>
/// ������� ����� ��� ���� ����� ����������� �����
/// �������� ����� ������ � �������� ��� ���� �����
/// </summary>
public abstract class BaseNode : Node
{
    public string GUID { get; set; } // ���������� ������������� ����
    public bool EntryPoint { get; set; } = false; // �������� �� ���� ������ �����

    /// <summary>
    /// ������������� ���� � ��������� ��������
    /// </summary>
    public virtual void Initialize(Vector2 position)
    {
        GUID = Guid.NewGuid().ToString();
        SetPosition(new Rect(position, new Vector2(200, 150)));
    }
}


//==== File 44 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Core\IPropertyNode.cs ====
public interface IPropertyNode
{
    void RefreshPropertyDropdown();
}

//==== File 45 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\DialogueContainer.cs ====
using System.Collections.Generic;
using UnityEngine;
using System;

/// <summary>
/// ��������� ��� �������� ������ ����������� ����
/// </summary>
[Serializable]
public class DialogueContainer : ScriptableObject
{
    [Header("Entry Node")]
    public EntryNodeData EntryNodeData;

    [Header("Node Connections")]
    public List<NodeLinkData> NodeLinks = new List<NodeLinkData>();

    [Header("Speech Nodes")]
    public List<SpeechNodeData> SpeechNodeDatas = new List<SpeechNodeData>();

    [Header("Option Nodes")]
    public List<OptionNodeData> OptionNodeDatas = new List<OptionNodeData>();

    [Header("Exposed Properties")]
    public List<ExposedProperty> ExposedProperties = new List<ExposedProperty>();

    [Header("Exposed Properties")]
    public List<IntExposedProperty> IntExposedProperties = new List<IntExposedProperty>();
    public List<StringExposedProperty> StringExposedProperties = new List<StringExposedProperty>();

    [Header("Condition Nodes")]
    public List<IntConditionNodeData> IntConditionNodeDatas = new List<IntConditionNodeData>();
    public List<StringConditionNodeData> StringConditionNodeDatas = new List<StringConditionNodeData>();

    [Header("Modify Int Nodes")]
    public List<ModifyIntNodeData> ModifyIntNodeDatas = new List<ModifyIntNodeData>();

    [Header("End Nodes")]
    public List<EndNodeData> EndNodeDatas = new List<EndNodeData>();

    [Header("Speech Image Nodes")]
    public List<SpeechNodeImageData> SpeechNodeImageDatas = new List<SpeechNodeImageData>();

    [Header("Option Image Nodes")]
    public List<OptionNodeImageData> OptionNodeImageDatas = new List<OptionNodeImageData>();

    [Header("Base Character")]
    public string BaseCharacterGuid;

    [Header("Event Nodes")]
    public List<EventNodeData> EventNodeDatas = new List<EventNodeData>();

    [Header("Character Condition Nodes")]
    public List<CharacterIntConditionNodeData> CharacterIntConditionNodeDatas = new List<CharacterIntConditionNodeData>();

    [Header("Character Modify Int Nodes")]
    public List<CharacterModifyIntNodeData> CharacterModifyIntNodeDatas = new List<CharacterModifyIntNodeData>();
}


//==== File 46 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\ExposedProperty.cs ====
using UnityEngine;

/// <summary>
/// �������� ��� ������ ����� - ����������, ������� ����� ������������ � ��������
/// </summary>
[System.Serializable]
public class ExposedProperty
{
    public string PropertyName = "New Property"; // ��� ��������
    public string PropertyValue = "New Value";   // �������� ��������
}

//==== File 47 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\IntExposedProperty.cs ====
[System.Serializable]
public class IntExposedProperty
{
    public string PropertyName = "New Int Property";
    public int IntValue = 0;
    public int MinValue = 0;
    public int MaxValue = 100;
}


//==== File 48 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\NodeLinkData.cs ====
[System.Serializable]
public class NodeLinkData
{
    public string BaseNodeGuid;
    public string PortName;
    public string TargetNodeGuid;
}


//==== File 49 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\StringExposedProperty.cs ====
[System.Serializable]
public class StringExposedProperty
{
    public string PropertyName = "New String Property";
    public string StringValue = "New Value";
}


//==== File 50 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Enums\ComparisonEnums.cs ====
namespace DialogueSystem
{
    public enum ComparisonType
    {
        Equal,
        NotEqual,
        Greater,
        Less,
        GreaterOrEqual,
        LessOrEqual
    }

    public enum StringComparisonType
    {
        Equal,
        NotEqual,
        IsNullOrEmpty
    }

    public enum OperatorType
    {
        Set,
        Add,
        Subtract,
        Multiply,
        Divide,
        Increment,
        Decrement
    }
}


//==== File 51 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\Node Data\CharacterIntConditionNodeData.cs ====
using DialogueSystem;
using UnityEngine;
using System;

[Serializable]
public class CharacterIntConditionNodeData : BaseNodeData
{
    public string CharacterName;
    public string SelectedVariable;
    public ComparisonType Comparison;
    public int CompareValue;
}

//==== File 52 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\Node Data\CharacterModifyIntNodeData.cs ====
using DialogueSystem;
using UnityEngine;
using System;

[Serializable]
public class CharacterModifyIntNodeData : BaseNodeData
{
    public string CharacterName;
    public string SelectedVariable;
    public OperatorType Operator;
    public int Value;
}

//==== File 53 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\Node Data\EndNodeData.cs ====
using UnityEngine;
using System;

[Serializable]
public class EndNodeData : BaseNodeData
{
    public string NextDialogueName;
}

//==== File 54 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\Node Data\EntryNodeData.cs ====
using UnityEngine;
using System;

/// <summary>
/// ������ ���������� ���� ��� ������������
/// </summary>
[Serializable]
public class EntryNodeData : BaseNodeData
{

}


//==== File 55 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\Node Data\EventNodeData.cs ====
using UnityEngine;
using UnityEngine.Events;
using System;

[Serializable]
public class EventNodeData : BaseNodeData
{
    public UnityEvent Event = new UnityEvent();
}

//==== File 56 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\Node Data\IntConditionNodeData.cs ====
using DialogueSystem;
using UnityEngine;
using System;

[Serializable]
public class IntConditionNodeData
{
    public string Guid;
    public Vector2 Position;
    public string SelectedProperty;
    public ComparisonType Comparison;
    public int CompareValue;
}


//==== File 57 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\Node Data\ModifyIntNodeData.cs ====
using DialogueSystem;
using UnityEngine;
using System;

[Serializable]
public class ModifyIntNodeData : BaseNodeData
{
    public string SelectedProperty;
    public OperatorType Operator;
    public int Value;
}


//==== File 58 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\Node Data\OptionNodeData.cs ====
using UnityEngine;
using System;

/// <summary>
/// ������ ���� �������� ������ ������ ��� ������������
/// </summary>
[Serializable]
public class OptionNodeData : BaseNodeData
{
    [TextArea, Tooltip("Response text content")]
    public string ResponseText;

    [Tooltip("GUID of the audio clip asset")]
    public string AudioClipGuid;

    public string NodeType;
}


//==== File 59 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\Node Data\OptionNodeImageData.cs ====
using UnityEngine;
using System;

[Serializable]
public class OptionNodeImageData : BaseNodeData
{
    public string ImageSpriteGuid;

    public string NodeType;
}

//==== File 60 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\Node Data\SpeechNodeData.cs ====
using UnityEngine;
using System;

/// <summary>
/// ������ ���� ���� NPC ��� ������������
/// </summary>
[Serializable]
public class SpeechNodeData : BaseNodeData
{
    [TextArea, Tooltip("Dialogue text content")]
    public string DialogueText;

    [Tooltip("GUID of the audio clip asset")]
    public string AudioClipGuid;

    [Tooltip("GUID of the speaker character asset")]
    public string SpeakerGuid;

    public string NodeType;
}


//==== File 61 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\Node Data\SpeechNodeImageData.cs ====
using UnityEngine;
using System;

[Serializable]
public class SpeechNodeImageData : BaseNodeData
{
    public string ImageSpriteGuid;

    public string NodeType;
    public string SpeakerGuid;
}

//==== File 62 of 62: D:/Work/REDDialogSystemProject/Assets\Scripts\Runtime\DialogueSystem\Data\Node Data\StringConditionNodeData.cs ====
using DialogueSystem;
using UnityEngine;
using System;

[Serializable]
public class StringConditionNodeData : BaseNodeData
{
    public string SelectedProperty;
    public StringComparisonType Comparison;
    public string CompareValue;
}



// ============ Statistics =============
// Total Files: 62
// Total Size: 217,76 KB
// Total Lines: 5934
// Classes: 61
// Methods: 391
// Comments: 692
// =====================================
